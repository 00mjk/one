function SpiceConn(t){if(void 0===t||void 0===t.uri||!t.uri)throw new Error("You must specify a uri");if(this.ws=new WebSocket(t.uri,"binary"),!this.ws.binaryType)throw new Error("WebSocket doesn't support binaryType.  Try a different browser.");if(this.connection_id=void 0!==t.connection_id?t.connection_id:0,this.type=void 0!==t.type?t.type:SPICE_CHANNEL_MAIN,this.chan_id=void 0!==t.chan_id?t.chan_id:0,void 0!==t.parent&&(this.parent=t.parent,this.message_id=t.parent.message_id,this.password=t.parent.password),void 0!==t.screen_id&&(this.screen_id=t.screen_id),void 0!==t.dump_id&&(this.dump_id=t.dump_id),void 0!==t.message_id&&(this.message_id=t.message_id),void 0!==t.password&&(this.password=t.password),void 0!==t.onerror&&(this.onerror=t.onerror),void 0!==t.onsuccess&&(this.onsuccess=t.onsuccess),void 0!==t.onagent&&(this.onagent=t.onagent),this.state="connecting",this.ws.parent=this,this.wire_reader=new SpiceWireReader(this,this.process_inbound),this.messages_sent=0,this.warnings=[],this.ws.addEventListener("open",function(){DEBUG>0&&console.log(">> WebSockets.onopen"),DEBUG>0&&console.log("id "+this.parent.connection_id+"; type "+this.parent.type),this.parent.send_hdr(),this.parent.wire_reader.request(SpiceLinkHeader.prototype.buffer_size()),this.parent.state="start"}),this.ws.addEventListener("error",function(t){"url"in t.target&&this.parent.log_err("WebSocket error: Can't connect to websocket on URL: "+t.target.url),this.parent.report_error(t)}),this.ws.addEventListener("close",function(t){if(DEBUG>0&&console.log(">> WebSockets.onclose"),DEBUG>0&&console.log("id "+this.parent.connection_id+"; type "+this.parent.type),DEBUG>0&&console.log(t),"closing"!=this.parent.state&&"error"!=this.parent.state&&void 0!==this.parent.onerror){var t;t=new Error("connecting"==this.parent.state?"Connection refused.":"start"==this.parent.state||"link"==this.parent.state?"Unexpected protocol mismatch.":"ticket"==this.parent.state?"Bad password.":"Unexpected close while "+this.parent.state),this.parent.onerror(t),this.parent.log_err(t.toString())}}),2==this.ws.readyState||3==this.ws.readyState)throw new Error("Unable to connect to "+t.uri);this.timeout=window.setTimeout(spiceconn_timeout,SPICE_CONNECT_TIMEOUT,this)}function spiceconn_timeout(t){SpiceConn.prototype.handle_timeout.call(t)}function SpiceArrayBufferSlice(t,e){t=t||0,e=e||this.byteLength,0>e&&(e=this.byteLength+e),0>t&&(t=this.byteLength+t),0>t&&(t=0),0>e&&(e=0),e>this.byteLength&&(e=this.byteLength),t>e&&(t=e);var i,s=new ArrayBuffer(e-t),r=new Uint8Array(this,t,e-t),n=new Uint8Array(s);for(i=0;e-t>i;i++)n[i]=r[i];return s}function combine_array_buffers(t,e){var i,s=new Uint8Array(t),r=new Uint8Array(e),n=new ArrayBuffer(t.byteLength+e.byteLength),a=new Uint8Array(n),_=0;for(i=0;i<s.length;i++)a[_++]=s[i];for(i=0;i<r.length;i++)a[_++]=r[i];return n}function hexdump_buffer(t){for(var e=new Uint8Array(t),i="",s="",r=0,n=0;n<e.length;n++){var a=Number(e[n]).toString(16);if(1==a.length&&(i+="0"),i+=a+" ",s+=10==e[n]||13==e[n]||8==e[n]?".":String.fromCharCode(e[n]),n%16==15||n==e.length-1){for(;n%16!=15;)i+="   ",n++;0==r&&console.log(i+" | "+s),"00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 "==i?1==r?(console.log("."),r++):0==r&&r++:r=0,i=s=""}}}function get_scancode(t){return void 0===common_scanmap[t]?-1!=navigator.userAgent.indexOf("Firefox")?firefox_scanmap[t]:DOM_scanmap[t]:common_scanmap[t]}function keycode_to_start_scan(t){var e=get_scancode(t);return void 0===e?(alert("no map for "+t),0):256>e?e:224|e-256<<8}function keycode_to_end_scan(t){var e=get_scancode(t);return void 0===e?0:256>e?128|e:32992|e-256<<8}function rfc2083_make_crc_table(){var t,e,i;for(e=0;256>e;e++){for(t=e,i=0;8>i;i++)1&t?t=(3988292384^t>>>1)>>>0&4294967295:t>>>=1;rfc2083_crc_table[e]=t}rfc2083_crc_table_computed=1}function rfc2083_update_crc(t,e,i,s){var r,n=t;for(rfc2083_crc_table_computed||rfc2083_make_crc_table(),r=0;s>r;r++)n=rfc2083_crc_table[255&(n^e[i+r])]^n>>>8;return n}function rfc2083_crc(t,e,i){return 4294967295^rfc2083_update_crc(4294967295,t,e,i)}function crc32(t,e,i){var s=new Uint8Array(t);return rfc2083_crc(s,e,i)}function PngIHDR(t,e){this.width=t,this.height=e,this.depth=8,this.type=6,this.compression=0,this.filter=0,this.interlace=0}function adler(){this.s1=1,this.s2=0}function PngIDAT(t,e,i){if(i.byteLength>65535)throw new Error("Cannot handle more than 64K");this.data=i,this.width=t,this.height=e}function PngIEND(){}function create_rgba_png(t,e,i){var s,r=new PngIHDR(t,e),n=new PngIDAT(t,e,i),a=new PngIEND,_=new ArrayBuffer(r.buffer_size()+n.buffer_size()+a.buffer_size()),o=r.to_buffer(_);o=n.to_buffer(_,o),o=a.to_buffer(_,o);var c=new Uint8Array(_),h="";for(s=0;o>s;s++)h+="%",c[s]<16&&(h+="0"),h+=c[s].toString(16);return"%89PNG%0D%0A%1A%0A"+h}function lz_rgb32_decompress(t,e,s,r,n){var a,_=e,o=0;for(a=t[_++];4*o<s.length;a=t[_++]){var c=o,h=a>>5,p=(31&a)<<8;if(a>=32){var u;if(h--,6==h)do u=t[_++],h+=u;while(255==u);if(u=t[_++],p+=u,255==u&&p-u==7936&&(p=t[_++]<<8,p+=t[_++],p+=8191),h+=1,r==LZ_IMAGE_TYPE_RGBA&&(h+=2),p+=1,c-=p,c==o-1)for(var d=c;h;--h){if(r==LZ_IMAGE_TYPE_RGBA)s[4*o+3]=s[4*d+3];else for(i=0;4>i;i++)s[4*o+i]=s[4*d+i];o++}else for(;h;--h){if(r==LZ_IMAGE_TYPE_RGBA)s[4*o+3]=s[4*c+3];else for(i=0;4>i;i++)s[4*o+i]=s[4*c+i];o++,c++}}else for(a++,r==LZ_IMAGE_TYPE_RGBA?s[4*o+3]=t[_++]:(s[4*o+0]=t[_+2],s[4*o+1]=t[_+1],s[4*o+2]=t[_+0],n&&(s[4*o+3]=255),_+=3),o++,--a;a;a--)r==LZ_IMAGE_TYPE_RGBA?s[4*o+3]=t[_++]:(s[4*o+0]=t[_+2],s[4*o+1]=t[_+1],s[4*o+2]=t[_+0],n&&(s[4*o+3]=255),_+=3),o++}return _-1}function convert_spice_lz_to_web(t,e){var i;if(e.type===LZ_IMAGE_TYPE_RGB32||e.type===LZ_IMAGE_TYPE_RGBA){var s=new Uint8Array(e.data),r=t.createImageData(e.width,e.height);i=lz_rgb32_decompress(s,0,r.data,LZ_IMAGE_TYPE_RGB32,e.type!=LZ_IMAGE_TYPE_RGBA),e.type==LZ_IMAGE_TYPE_RGBA&&lz_rgb32_decompress(s,i,r.data,LZ_IMAGE_TYPE_RGBA,!1)}else{if(e.type!==LZ_IMAGE_TYPE_XXXA)return void 0;var s=new Uint8Array(e.data),r=t.createImageData(e.width,e.height);lz_rgb32_decompress(s,0,r.data,LZ_IMAGE_TYPE_RGBA,!1)}return r}function ceil_log_2(t){if(1===t)return 0;var e=1;for(t-=1;t>>>=1;)e++;return e}function family_init(t,e,i){var s;for(s=0;e>s;s++){var r,n;r=i-e,r>bppmask[e-s]&&(r=bppmask[e-s]),n=bppmask[e]+1-(r<<s),t.nGRcodewords[s]=r<<s,t.notGRcwlen[s]=r+ceil_log_2(n),t.notGRprefixmask[s]=bppmask[32-r]>>>0,t.notGRsuffixlen[s]=ceil_log_2(n)}var a,_=bppmask[e],o=_>>>1;for(a=0;_>=a;a++)t.xlatU2L[a]=o>=a?a<<1:(_-a<<1)+1;for(a=0;_>=a;a++)t.xlatL2U[a]=1&a?_-(a>>>1):a>>>1}function quic_image_bpc(t){switch(t){case QUIC_IMAGE_TYPE_GRAY:return 8;case QUIC_IMAGE_TYPE_RGB16:return 5;case QUIC_IMAGE_TYPE_RGB24:return 8;case QUIC_IMAGE_TYPE_RGB32:return 8;case QUIC_IMAGE_TYPE_RGBA:return 8;case QUIC_IMAGE_TYPE_INVALID:default:return console.log("quic: bad image type\n"),0}}function cnt_l_zeroes(t){return 4286578688&t?lzeroes[t>>>24]:4294934528&t?8+lzeroes[t>>>16&255]:4294967168&t?16+lzeroes[t>>>8&255]:24+lzeroes[255&t]}function golomb_decoding_8bpc(t,e){var i,s;if(0>e||e>family_8bpc.notGRprefixmask[t]){var r=cnt_l_zeroes(e);s=r+1+t,i=r<<t|e>>32-s&bppmask[t]}else s=family_8bpc.notGRcwlen[t],i=family_8bpc.nGRcodewords[t]+(e>>32-s&bppmask[family_8bpc.notGRsuffixlen[t]]);return{codewordlen:s,rc:i}}function golomb_code_len_8bpc(t,e){return t<family_8bpc.nGRcodewords[e]?(t>>>e)+1+e:family_8bpc.notGRcwlen[e]}function QuicModel(t){var e,i=0;switch(this.levels=1<<t,this.n_buckets_ptrs=0,evol){case 1:this.repfirst=3,this.firstsize=1,this.repnext=2,this.mulsize=2;break;case 3:this.repfirst=1,this.firstsize=1,this.repnext=1,this.mulsize=2;break;case 5:this.repfirst=1,this.firstsize=1,this.repnext=1,this.mulsize=4;break;case 0:case 2:case 4:console.log("quic: findmodelparams(): evol value obsolete!!!\n");default:console.log("quic: findmodelparams(): evol out of range!!!\n")}this.n_buckets=0;var s=this.repfirst+1,r=this.firstsize;do e=this.n_buckets?i+1:0,--s||(s=this.repnext,r*=this.mulsize),i=e+r-1,i+r>=this.levels&&(i=this.levels-1),this.n_buckets_ptrs||(this.n_buckets_ptrs=this.levels),this.n_buckets++;while(i<this.levels-1)}function QuicBucket(){this.counters=[0,0,0,0,0,0,0,0]}function QuicFamilyStat(){this.buckets_ptrs=[],this.buckets_buf=[]}function QuicChannel(t,e){return this.state=new CommonState,this.family_stat_8bpc=new QuicFamilyStat,this.family_stat_5bpc=new QuicFamilyStat,this.correlate_row={zero:0,row:[]},this.model_8bpc=t,this.model_5bpc=e,this.buckets_ptrs=[],this.family_stat_8bpc.fill_model_structures(this.model_8bpc)?(this.family_stat_5bpc.fill_model_structures(this.model_5bpc),void 0):void 0}function CommonState(){}function QuicEncoder(){this.rgb_state=new CommonState,this.model_8bpc=new QuicModel(8),this.model_5bpc=new QuicModel(5),this.channels=[];var t;for(t=0;4>t;t++)if(this.channels[t]=new QuicChannel(this.model_8bpc,this.model_5bpc),!this.channels[t])return void console.log("quic: failed to create channel")}function SpiceQuic(){}function convert_spice_quic_to_web(t,e){var i,s=t.createImageData(e.width,e.height);for(i=0;i<s.width*s.height*4;i+=4)s.data[i+0]=e.outptr[i+2],s.data[i+1]=e.outptr[i+1],s.data[i+2]=e.outptr[i+0],s.data[i+3]=e.type!==QUIC_IMAGE_TYPE_RGBA?255:255-e.outptr[i+3];return s}function convert_spice_bitmap_to_web(t,e){var i,s,r,n=new Uint8Array(e.data);if(e.format!=SPICE_BITMAP_FMT_32BIT&&e.format!=SPICE_BITMAP_FMT_RGBA)return void 0;for(i=t.createImageData(e.x,e.y),s=0;s<e.y*e.stride;)for(r=0;r<e.x;r++,s+=4)i.data[s+0]=n[s+2],i.data[s+1]=n[s+1],i.data[s+2]=n[s+0],i.data[s+3]=e.format==SPICE_BITMAP_FMT_32BIT?255:n[s];return i}function SpiceDataView(t,e,i){this.u8=void 0!==e?void 0!==i?new Uint8Array(t,e,i):new Uint8Array(t,e):new Uint8Array(t)}function SpiceChannelId(){}function SpiceRect(){}function SpiceClipRects(){}function SpiceClip(){}function SpiceImageDescriptor(){}function SpicePalette(){}function SpiceBitmap(){}function SpiceImage(){}function SpiceQMask(){}function SpicePattern(){}function SpiceBrush(){}function SpiceFill(){}function SpiceCopy(){}function SpicePoint16(){}function SpicePoint(){}function SpiceCursorHeader(){}function SpiceCursor(){}function SpiceSurface(){}function SpiceLinkHeader(t,e){this.magic=SPICE_MAGIC,this.major_version=SPICE_VERSION_MAJOR,this.minor_version=SPICE_VERSION_MINOR,this.size=0,void 0!==t&&this.from_buffer(t,e)}function SpiceLinkMess(t,e){this.connection_id=0,this.channel_type=0,this.channel_id=0,this.common_caps=[],this.channel_caps=[],void 0!==t&&this.from_buffer(t,e)}function SpiceLinkReply(t,e){this.error=0,this.pub_key=void 0,this.common_caps=[],this.channel_caps=[],void 0!==t&&this.from_buffer(t,e)}function SpiceLinkAuthTicket(){this.auth_mechanism=0,this.encrypted_data=void 0}function SpiceLinkAuthReply(t,e){this.auth_code=0,void 0!==t&&this.from_buffer(t,e)}function SpiceMiniData(t,e){this.type=0,this.size=0,this.data=void 0,void 0!==t&&this.from_buffer(t,e)}function SpiceMsgChannels(t,e){this.num_of_channels=0,this.channels=[],void 0!==t&&this.from_buffer(t,e)}function SpiceMsgMainInit(t,e){this.from_buffer(t,e)}function SpiceMsgMainMouseMode(t,e){this.from_buffer(t,e)}function SpiceMsgMainAgentData(t,e){this.from_buffer(t,e)}function SpiceMsgMainAgentTokens(t,e){this.from_buffer(t,e)}function SpiceMsgSetAck(t,e){this.from_buffer(t,e)}function SpiceMsgcAckSync(t){this.generation=t.generation}function SpiceMsgcMainMouseModeRequest(t){this.mode=t}function SpiceMsgcMainAgentStart(t){this.num_tokens=t}function SpiceMsgcMainAgentData(t,e){this.protocol=VD_AGENT_PROTOCOL,this.type=t,this.opaque=0,this.size=e.buffer_size(),this.data=e}function VDAgentAnnounceCapabilities(t,e){e?(this.request=t,this.caps=e):this.from_buffer(t)}function VDAgentMonitorsConfig(t,e,i,s,r,n){this.num_mon=1,this.flags=t,this.width=e,this.height=i,this.depth=s,this.x=r,this.y=n}function VDAgentFileXferStatusMessage(t,e){e?(this.id=t,this.result=e):this.from_buffer(t)}function VDAgentFileXferStartMessage(t,e,i){this.id=t,this.string="[vdagent-file-xfer]\nname="+e+"\nsize="+i+"\n"}function VDAgentFileXferDataMessage(t,e,i){this.id=t,this.size=e,this.data=i}function SpiceMsgNotify(t,e){this.from_buffer(t,e)}function SpiceMsgcDisplayInit(){this.pixmap_cache_id=1,this.glz_dictionary_id=0,this.pixmap_cache_size=10485760,this.glz_dictionary_window_size=0}function SpiceMsgDisplayBase(){}function SpiceMsgDisplayDrawCopy(t,e){this.from_buffer(t,e)}function SpiceMsgDisplayDrawFill(t,e){this.from_buffer(t,e)}function SpiceMsgDisplayCopyBits(t,e){this.from_buffer(t,e)}function SpiceMsgSurfaceCreate(t,e){this.from_buffer(t,e)}function SpiceMsgSurfaceDestroy(t,e){this.from_buffer(t,e)}function SpiceMsgInputsInit(t,e){this.from_buffer(t,e)}function SpiceMsgInputsKeyModifiers(t,e){this.from_buffer(t,e)}function SpiceMsgCursorInit(t,e){this.from_buffer(t,e)}function SpiceMsgPlaybackData(t,e){this.from_buffer(t,e)}function SpiceMsgPlaybackMode(t,e){this.from_buffer(t,e)}function SpiceMsgPlaybackStart(t,e){this.from_buffer(t,e)}function SpiceMsgCursorSet(t,e){this.from_buffer(t,e)}function SpiceMsgcMousePosition(t,e){if(this.display_id=0,this.buttons_state=t.buttons_state,e){var i=document.body.scrollTop||document.documentElement.scrollTop,s=document.body.scrollLeft||document.documentElement.scrollLeft;this.x=e.clientX-t.display.surfaces[t.display.primary_surface].canvas.offsetLeft+s,this.y=e.clientY-t.display.surfaces[t.display.primary_surface].canvas.offsetTop+i,t.mousex=this.x,t.mousey=this.y}else this.x=this.y=this.buttons_state=0}function SpiceMsgcMouseMotion(t,e){this.display_id=0,this.buttons_state=t.buttons_state,e?(this.x=e.clientX-t.display.surfaces[t.display.primary_surface].canvas.offsetLeft,this.y=e.clientY-t.display.surfaces[t.display.primary_surface].canvas.offsetTop,void 0!==t.mousex&&(this.x-=t.mousex,this.y-=t.mousey),t.mousex=e.clientX-t.display.surfaces[t.display.primary_surface].canvas.offsetLeft,t.mousey=e.clientY-t.display.surfaces[t.display.primary_surface].canvas.offsetTop):this.x=this.y=this.buttons_state=0}function SpiceMsgcMousePress(t,e){e?(this.button=e.button+1,this.buttons_state=1<<e.button,t.buttons_state=this.buttons_state):(this.button=SPICE_MOUSE_BUTTON_LEFT,this.buttons_state=SPICE_MOUSE_BUTTON_MASK_LEFT)}function SpiceMsgcMouseRelease(t,e){e?(this.button=e.button+1,this.buttons_state=0,t.buttons_state=this.buttons_state):(this.button=SPICE_MOUSE_BUTTON_LEFT,this.buttons_state=0)}function SpiceMsgcKeyDown(t){this.code=t?keycode_to_start_scan(t.keyCode):0}function SpiceMsgcKeyUp(t){this.code=t?keycode_to_end_scan(t.keyCode):0}function SpiceMsgDisplayStreamCreate(t,e){this.from_buffer(t,e)}function SpiceStreamDataHeader(){}function SpiceMsgDisplayStreamData(t,e){this.from_buffer(t,e)}function SpiceMsgDisplayStreamClip(t,e){this.from_buffer(t,e)}function SpiceMsgDisplayStreamDestroy(t,e){this.from_buffer(t,e)}function SpiceMsgDisplayInvalList(t,e){this.count=0,this.resources=[],this.from_buffer(t,e)}function SpiceWireReader(t,e){this.sc=t,this.callback=e,this.needed=0,this.buffers=[],this.sc.ws.wire_reader=this,this.sc.ws.binaryType="arraybuffer",this.sc.ws.addEventListener("message",wire_blob_catcher)}function wire_blob_catcher(t){DEBUG>1&&console.log(">> WebSockets.onmessage"),DEBUG>1&&console.log("id "+this.wire_reader.sc.connection_id+"; type "+this.wire_reader.sc.type),SpiceWireReader.prototype.inbound.call(this.wire_reader,t.data)}function putImageDataWithAlpha(t,e,i,s){var r=document.createElement("canvas"),n=r.getContext("2d");r.setAttribute("width",e.width),r.setAttribute("height",e.height),n.putImageData(e,0,0),t.drawImage(r,i,s,e.width,e.height)}function stripAlpha(t){var e;for(e=0;e<t.width*t.height*4;e+=4)t.data[e+3]=255}function SpiceDisplayConn(){SpiceConn.apply(this,arguments)}function handle_mouseover(){this.focus()}function handle_mouseout(){this.sc&&this.sc.cursor&&this.sc.cursor.spice_simulated_cursor&&(this.sc.cursor.spice_simulated_cursor.style.display="none"),this.blur()}function handle_draw_jpeg_onload(){var t,e=null;if(void 0===this.o.sc.surfaces[this.o.base.surface_id]?(DEBUG>2&&this.o.sc.log_info("Discarding jpeg; presumed lost surface "+this.o.base.surface_id),e=document.createElement("canvas"),e.setAttribute("width",this.o.base.box.right),e.setAttribute("height",this.o.base.box.bottom),t=e.getContext("2d")):t=this.o.sc.surfaces[this.o.base.surface_id].canvas.context,this.alpha_img){var i=document.createElement("canvas"),s=i.getContext("2d");i.setAttribute("width",this.alpha_img.width),i.setAttribute("height",this.alpha_img.height),s.putImageData(this.alpha_img,0,0),s.globalCompositeOperation="source-in",s.drawImage(this,0,0),t.drawImage(i,this.o.base.box.left,this.o.base.box.top),this.o.descriptor&&this.o.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this.o.sc||(this.o.sc.cache={}),this.o.sc.cache[this.o.descriptor.id]=s.getImageData(0,0,this.alpha_img.width,this.alpha_img.height))}else t.drawImage(this,this.o.base.box.left,this.o.base.box.top),this.src=null,this.o.descriptor&&this.o.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this.o.sc||(this.o.sc.cache={}),this.o.sc.cache[this.o.descriptor.id]=t.getImageData(this.o.base.box.left,this.o.base.box.top,this.o.base.box.right-this.o.base.box.left,this.o.base.box.bottom-this.o.base.box.top));if(null==e){if(DUMP_DRAWS&&this.o.sc.parent.dump_id){var r=document.createElement("canvas");r.setAttribute("id",this.o.tag+"."+this.o.sc.surfaces[this.o.base.surface_id].draw_count+"."+this.o.base.surface_id+"@"+this.o.base.box.left+"x"+this.o.base.box.top),r.getContext("2d").drawImage(this,0,0),document.getElementById(this.o.sc.parent.dump_id).appendChild(r)}this.o.sc.surfaces[this.o.base.surface_id].draw_count++}}function SpiceInputsConn(){SpiceConn.apply(this,arguments),this.mousex=void 0,this.mousey=void 0,this.button_state=0,this.waiting_for_ack=0}function handle_mousemove(t){var e,i=new SpiceMiniData;this.sc.mouse_mode==SPICE_MOUSE_MODE_CLIENT?(e=new SpiceMsgcMousePosition(this.sc,t),i.build_msg(SPICE_MSGC_INPUTS_MOUSE_POSITION,e)):(e=new SpiceMsgcMouseMotion(this.sc,t),i.build_msg(SPICE_MSGC_INPUTS_MOUSE_MOTION,e)),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&(this.sc.inputs.waiting_for_ack<2*SPICE_INPUT_MOTION_ACK_BUNCH?(this.sc.inputs.send_msg(i),this.sc.inputs.waiting_for_ack++):DEBUG>0&&this.sc.log_info("Discarding mouse motion")),this.sc&&this.sc.cursor&&this.sc.cursor.spice_simulated_cursor&&(this.sc.cursor.spice_simulated_cursor.style.display="block",this.sc.cursor.spice_simulated_cursor.style.left=t.pageX-this.sc.cursor.spice_simulated_cursor.spice_hot_x+"px",this.sc.cursor.spice_simulated_cursor.style.top=t.pageY-this.sc.cursor.spice_simulated_cursor.spice_hot_y+"px",t.preventDefault())}function handle_mousedown(t){var e=new SpiceMsgcMousePress(this.sc,t),i=new SpiceMiniData;i.build_msg(SPICE_MSGC_INPUTS_MOUSE_PRESS,e),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),t.preventDefault()}function handle_contextmenu(t){return t.preventDefault(),!1}function handle_mouseup(t){var e=new SpiceMsgcMouseRelease(this.sc,t),i=new SpiceMiniData;i.build_msg(SPICE_MSGC_INPUTS_MOUSE_RELEASE,e),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),t.preventDefault()}function handle_mousewheel(t){var e=new SpiceMsgcMousePress,i=new SpiceMsgcMouseRelease;e.button=i.button=t.deltaY<0?SPICE_MOUSE_BUTTON_UP:SPICE_MOUSE_BUTTON_DOWN,e.buttons_state=0,i.buttons_state=0;var s=new SpiceMiniData;s.build_msg(SPICE_MSGC_INPUTS_MOUSE_PRESS,e),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(s),s.build_msg(SPICE_MSGC_INPUTS_MOUSE_RELEASE,i),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(s),t.preventDefault()}function handle_keydown(t){var e=new SpiceMsgcKeyDown(t),i=new SpiceMiniData;check_and_update_modifiers(t,e.code,this.sc),i.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,e),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),t.preventDefault()}function handle_keyup(t){var e=new SpiceMsgcKeyUp(t),i=new SpiceMiniData;check_and_update_modifiers(t,e.code,this.sc),i.build_msg(SPICE_MSGC_INPUTS_KEY_UP,e),this.sc&&this.sc.inputs&&"ready"===this.sc.inputs.state&&this.sc.inputs.send_msg(i),t.preventDefault()}function sendCtrlAltDel(){if(sc&&sc.inputs&&"ready"===sc.inputs.state){var t=new SpiceMsgcKeyDown,e=new SpiceMiniData;update_modifier(!0,KEY_LCtrl,sc),update_modifier(!0,KEY_Alt,sc),t.code=KEY_KP_Decimal,e.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,t),sc.inputs.send_msg(e),e.build_msg(SPICE_MSGC_INPUTS_KEY_UP,t),sc.inputs.send_msg(e),0==Ctrl_state&&update_modifier(!1,KEY_LCtrl,sc),0==Alt_state&&update_modifier(!1,KEY_Alt,sc)}}function update_modifier(t,e,i){var s=new SpiceMiniData;if(t){var r=new SpiceMsgcKeyDown;r.code=e,s.build_msg(SPICE_MSGC_INPUTS_KEY_DOWN,r)}else{var r=new SpiceMsgcKeyUp;r.code=128|e,s.build_msg(SPICE_MSGC_INPUTS_KEY_UP,r)}i.inputs.send_msg(s)}function check_and_update_modifiers(t,e,i){-1===Shift_state&&(Shift_state=t.shiftKey,Ctrl_state=t.ctrlKey,Alt_state=t.altKey,Meta_state=t.metaKey),e===KEY_ShiftL?Shift_state=!0:e===KEY_Alt?Alt_state=!0:e===KEY_LCtrl?Ctrl_state=!0:57525===e?Meta_state=!0:e===(128|KEY_ShiftL)?Shift_state=!1:e===(128|KEY_Alt)?Alt_state=!1:e===(128|KEY_LCtrl)?Ctrl_state=!1:57525===e&&(Meta_state=!1),i&&i.inputs&&"ready"===i.inputs.state&&(Shift_state!=t.shiftKey&&(console.log("Shift state out of sync"),update_modifier(t.shiftKey,KEY_ShiftL,i),Shift_state=t.shiftKey),Alt_state!=t.altKey&&(console.log("Alt state out of sync"),update_modifier(t.altKey,KEY_Alt,i),Alt_state=t.altKey),Ctrl_state!=t.ctrlKey&&(console.log("Ctrl state out of sync"),update_modifier(t.ctrlKey,KEY_LCtrl,i),Ctrl_state=t.ctrlKey),Meta_state!=t.metaKey&&(console.log("Meta state out of sync"),update_modifier(t.metaKey,57525,i),Meta_state=t.metaKey))}function EBML_write_u1_data_len(t,e,i){var s=128|t;return e.setUint8(i,s),i+1}function EBML_write_u8_value(t,e,i,s){return s=EBML_write_array(t,i,s),s=EBML_write_u1_data_len(1,i,s),i.setUint8(s,e),s+1}function EBML_write_u32_value(t,e,i,s){return s=EBML_write_array(t,i,s),s=EBML_write_u1_data_len(4,i,s),i.setUint32(s,e),s+4}function EBML_write_u16_value(t,e,i,s){return s=EBML_write_array(t,i,s),s=EBML_write_u1_data_len(2,i,s),i.setUint16(s,e),s+2}function EBML_write_float_value(t,e,i,s){return s=EBML_write_array(t,i,s),s=EBML_write_u1_data_len(4,i,s),i.setFloat32(s,e),s+4}function EBML_write_u64_data_len(t,e,i){e.setUint8(i++,1),e.setUint8(i++,0),e.setUint8(i++,0),e.setUint8(i++,0);for(var s=4294967295&t,r=24;r>=0;r-=8)e.setUint8(i++,s>>r);return i}function EBML_write_array(t,e,i){for(var s=0;s<t.length;s++)e.setUint8(i+s,t[s]);return i+t.length}function EBML_write_string(t,e,i){for(var s=0;s<t.length;s++)e.setUint8(i+s,t.charCodeAt(s));return i+t.length}function EBML_write_data(t,e,i,s){return s=EBML_write_array(t,i,s),s=e.length<127?EBML_write_u1_data_len(e.length,i,s):EBML_write_u64_data_len(e.length,i,s),s="string"==typeof e?EBML_write_string(e,i,s):EBML_write_array(e,i,s)}function EBMLHeader(){this.id=EBML_HEADER,this.Version=1,this.ReadVersion=1,this.MaxIDLength=4,this.MaxSizeLength=8,this.DocType="webm",this.DocTypeVersion=2,this.DocTypeReadVersion=2}function webm_Segment(){this.id=WEBM_SEGMENT_HEADER}function webm_SegmentInformation(){this.id=WEBM_SEGMENT_INFORMATION,this.timecode_scale=1e6,this.muxing_app="spice",this.writing_app="spice-html5"}function webm_Audio(t){this.id=WEBM_AUDIO,this.sampling_frequency=t,this.channels=OPUS_CHANNELS}function webm_Seek(t,e){this.id=WEBM_SEEK,this.pos=e,this.seekid=t}function webm_SeekHead(t,e){this.id=WEBM_SEEK_HEAD,this.info=new webm_Seek(WEBM_SEGMENT_INFORMATION,t),this.track=new webm_Seek(WEBM_TRACKS,e)}function webm_TrackEntry(){this.id=WEBM_TRACK_ENTRY,this.number=1,this.uid=1,this.type=2,this.flag_enabled=1,this.flag_default=1,this.flag_forced=1,this.flag_lacing=0,this.min_cache=0,this.max_block_addition_id=0,this.codec_decode_all=0,this.seek_pre_roll=0,this.codec_delay=8e7,this.codec_id="A_OPUS",this.audio=new webm_Audio(OPUS_FREQUENCY),this.codec_private=[79,112,117,115,72,101,97,100,1,OPUS_CHANNELS,0,15,128,187,0,0,0,0,0]}function webm_Tracks(t){this.id=WEBM_TRACKS,this.track_entry=t}function webm_Cluster(t,e){this.id=WEBM_CLUSTER,this.timecode=t,this.data=e}function webm_SimpleBlock(t,e,i){this.id=WEBM_SIMPLE_BLOCK,this.timecode=t,this.data=e,this.keyframe=i}function webm_Header(){this.ebml=new EBMLHeader,this.segment=new webm_Segment,this.seek_head=new webm_SeekHead(0,0),this.seek_head.info.pos=this.segment.buffer_size()+this.seek_head.buffer_size(),this.info=new webm_SegmentInformation,this.seek_head.track.pos=this.seek_head.info.pos+this.info.buffer_size(),this.track_entry=new webm_TrackEntry,this.tracks=new webm_Tracks(this.track_entry)}function SpicePlaybackConn(){SpiceConn.apply(this,arguments),this.queue=new Array,this.append_okay=!1,this.start_time=0,this.skip_until=0,this.gap_time=0}function handle_source_open(){var t=this.spiceconn;if(!t.source_buffer){if(t.source_buffer=this.addSourceBuffer(SPICE_PLAYBACK_CODEC),!t.source_buffer)return void t.log_err("Codec "+SPICE_PLAYBACK_CODEC+" not available.");t.source_buffer.spiceconn=t,t.source_buffer.mode="segments"}}function handle_source_ended(){var t=this.spiceconn;t.log_err("Audio source unexpectedly ended.")}function handle_source_closed(){var t=this.spiceconn;t.log_err("Audio source unexpectedly closed.")}function handle_append_buffer_done(){var t=this.spiceconn;if(t.queue.length>0){var e=t.queue.shift();playback_append_buffer(t,e)}else t.append_okay=!0}function handle_sourcebuffer_error(t){var e=this.spiceconn;e.log_err("source_buffer error "+t.message)}function playback_append_buffer(t,e){try{t.source_buffer.appendBuffer(e),t.append_okay=!1}catch(i){t.log_err("Error invoking appendBuffer: "+i.message)}}function SpiceCursorConn(){SpiceConn.apply(this,arguments)}function BigInteger(t,e,i){null!=t&&("number"==typeof t?this.fromNumber(t,e,i):null==e&&"string"!=typeof t?this.fromString(t,256):this.fromString(t,e))}function nbi(){return new BigInteger(null)}function am1(t,e,i,s,r,n){for(;--n>=0;){var a=e*this[t++]+i[s]+r;r=Math.floor(a/67108864),i[s++]=67108863&a}return r}function am2(t,e,i,s,r,n){for(var a=32767&e,_=e>>15;--n>=0;){var o=32767&this[t],c=this[t++]>>15,h=_*o+c*a;o=a*o+((32767&h)<<15)+i[s]+(1073741823&r),r=(o>>>30)+(h>>>15)+_*c+(r>>>30),i[s++]=1073741823&o}return r}function am3(t,e,i,s,r,n){for(var a=16383&e,_=e>>14;--n>=0;){var o=16383&this[t],c=this[t++]>>14,h=_*o+c*a;o=a*o+((16383&h)<<14)+i[s]+r,r=(o>>28)+(h>>14)+_*c,i[s++]=268435455&o}return r}function int2char(t){return BI_RM.charAt(t)}function intAt(t,e){var i=BI_RC[t.charCodeAt(e)];return null==i?-1:i}function bnpCopyTo(t){for(var e=this.t-1;e>=0;--e)t[e]=this[e];t.t=this.t,t.s=this.s}function bnpFromInt(t){this.t=1,this.s=0>t?-1:0,t>0?this[0]=t:-1>t?this[0]=t+DV:this.t=0}function nbv(t){var e=nbi();return e.fromInt(t),e}function bnpFromString(t,e){var i;if(16==e)i=4;else if(8==e)i=3;else if(256==e)i=8;else if(2==e)i=1;else if(32==e)i=5;else{if(4!=e)return void this.fromRadix(t,e);i=2}this.t=0,this.s=0;for(var s=t.length,r=!1,n=0;--s>=0;){var a=8==i?255&t[s]:intAt(t,s);0>a?"-"==t.charAt(s)&&(r=!0):(r=!1,0==n?this[this.t++]=a:n+i>this.DB?(this[this.t-1]|=(a&(1<<this.DB-n)-1)<<n,this[this.t++]=a>>this.DB-n):this[this.t-1]|=a<<n,n+=i,n>=this.DB&&(n-=this.DB))}8==i&&0!=(128&t[0])&&(this.s=-1,n>0&&(this[this.t-1]|=(1<<this.DB-n)-1<<n)),this.clamp(),r&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var t=this.s&this.DM;this.t>0&&this[this.t-1]==t;)--this.t}function bnToString(t){if(this.s<0)return"-"+this.negate().toString(t);var e;if(16==t)e=4;else if(8==t)e=3;else if(2==t)e=1;else if(32==t)e=5;else{if(4!=t)return this.toRadix(t);e=2}var i,s=(1<<e)-1,r=!1,n="",a=this.t,_=this.DB-a*this.DB%e;if(a-->0)for(_<this.DB&&(i=this[a]>>_)>0&&(r=!0,n=int2char(i));a>=0;)e>_?(i=(this[a]&(1<<_)-1)<<e-_,i|=this[--a]>>(_+=this.DB-e)):(i=this[a]>>(_-=e)&s,0>=_&&(_+=this.DB,--a)),i>0&&(r=!0),r&&(n+=int2char(i));return r?n:"0"}function bnNegate(){var t=nbi();return BigInteger.ZERO.subTo(this,t),t}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(t){var e=this.s-t.s;if(0!=e)return e;var i=this.t;if(e=i-t.t,0!=e)return e;for(;--i>=0;)if(0!=(e=this[i]-t[i]))return e;return 0}function nbits(t){var e,i=1;return 0!=(e=t>>>16)&&(t=e,i+=16),0!=(e=t>>8)&&(t=e,i+=8),0!=(e=t>>4)&&(t=e,i+=4),0!=(e=t>>2)&&(t=e,i+=2),0!=(e=t>>1)&&(t=e,i+=1),i}function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(t,e){var i;for(i=this.t-1;i>=0;--i)e[i+t]=this[i];for(i=t-1;i>=0;--i)e[i]=0;e.t=this.t+t,e.s=this.s}function bnpDRShiftTo(t,e){for(var i=t;i<this.t;++i)e[i-t]=this[i];e.t=Math.max(this.t-t,0),e.s=this.s}function bnpLShiftTo(t,e){var i,s=t%this.DB,r=this.DB-s,n=(1<<r)-1,a=Math.floor(t/this.DB),_=this.s<<s&this.DM;for(i=this.t-1;i>=0;--i)e[i+a+1]=this[i]>>r|_,_=(this[i]&n)<<s;for(i=a-1;i>=0;--i)e[i]=0;e[a]=_,e.t=this.t+a+1,e.s=this.s,e.clamp()}function bnpRShiftTo(t,e){e.s=this.s;var i=Math.floor(t/this.DB);if(i>=this.t)return void(e.t=0);var s=t%this.DB,r=this.DB-s,n=(1<<s)-1;e[0]=this[i]>>s;for(var a=i+1;a<this.t;++a)e[a-i-1]|=(this[a]&n)<<r,e[a-i]=this[a]>>s;s>0&&(e[this.t-i-1]|=(this.s&n)<<r),e.t=this.t-i,e.clamp()}function bnpSubTo(t,e){for(var i=0,s=0,r=Math.min(t.t,this.t);r>i;)s+=this[i]-t[i],e[i++]=s&this.DM,s>>=this.DB;if(t.t<this.t){for(s-=t.s;i<this.t;)s+=this[i],e[i++]=s&this.DM,s>>=this.DB;s+=this.s}else{for(s+=this.s;i<t.t;)s-=t[i],e[i++]=s&this.DM,s>>=this.DB;s-=t.s}e.s=0>s?-1:0,-1>s?e[i++]=this.DV+s:s>0&&(e[i++]=s),e.t=i,e.clamp()}function bnpMultiplyTo(t,e){var i=this.abs(),s=t.abs(),r=i.t;for(e.t=r+s.t;--r>=0;)e[r]=0;for(r=0;r<s.t;++r)e[r+i.t]=i.am(0,s[r],e,r,0,i.t);e.s=0,e.clamp(),this.s!=t.s&&BigInteger.ZERO.subTo(e,e)}function bnpSquareTo(t){for(var e=this.abs(),i=t.t=2*e.t;--i>=0;)t[i]=0;for(i=0;i<e.t-1;++i){var s=e.am(i,e[i],t,2*i,0,1);(t[i+e.t]+=e.am(i+1,2*e[i],t,2*i+1,s,e.t-i-1))>=e.DV&&(t[i+e.t]-=e.DV,t[i+e.t+1]=1)}t.t>0&&(t[t.t-1]+=e.am(i,e[i],t,2*i,0,1)),t.s=0,t.clamp()}function bnpDivRemTo(t,e,i){var s=t.abs();if(!(s.t<=0)){var r=this.abs();if(r.t<s.t)return null!=e&&e.fromInt(0),void(null!=i&&this.copyTo(i));null==i&&(i=nbi());var n=nbi(),a=this.s,_=t.s,o=this.DB-nbits(s[s.t-1]);o>0?(s.lShiftTo(o,n),r.lShiftTo(o,i)):(s.copyTo(n),r.copyTo(i));var c=n.t,h=n[c-1];if(0!=h){var p=h*(1<<this.F1)+(c>1?n[c-2]>>this.F2:0),u=this.FV/p,d=(1<<this.F1)/p,f=1<<this.F2,l=i.t,E=l-c,m=null==e?nbi():e;for(n.dlShiftTo(E,m),i.compareTo(m)>=0&&(i[i.t++]=1,i.subTo(m,i)),BigInteger.ONE.dlShiftTo(c,m),m.subTo(n,n);n.t<c;)n[n.t++]=0;for(;--E>=0;){var g=i[--l]==h?this.DM:Math.floor(i[l]*u+(i[l-1]+f)*d);if((i[l]+=n.am(0,g,i,E,0,c))<g)for(n.dlShiftTo(E,m),i.subTo(m,i);i[l]<--g;)i.subTo(m,i)}null!=e&&(i.drShiftTo(c,e),a!=_&&BigInteger.ZERO.subTo(e,e)),i.t=c,i.clamp(),o>0&&i.rShiftTo(o,i),0>a&&BigInteger.ZERO.subTo(i,i)}}}function bnMod(t){var e=nbi();return this.abs().divRemTo(t,null,e),this.s<0&&e.compareTo(BigInteger.ZERO)>0&&t.subTo(e,e),e}function Classic(t){this.m=t}function cConvert(t){return t.s<0||t.compareTo(this.m)>=0?t.mod(this.m):t}function cRevert(t){return t}function cReduce(t){t.divRemTo(this.m,null,t)}function cMulTo(t,e,i){t.multiplyTo(e,i),this.reduce(i)}function cSqrTo(t,e){t.squareTo(e),this.reduce(e)}function bnpInvDigit(){if(this.t<1)return 0;var t=this[0];if(0==(1&t))return 0;var e=3&t;return e=e*(2-(15&t)*e)&15,e=e*(2-(255&t)*e)&255,e=e*(2-((65535&t)*e&65535))&65535,e=e*(2-t*e%this.DV)%this.DV,e>0?this.DV-e:-e}function Montgomery(t){this.m=t,this.mp=t.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<t.DB-15)-1,this.mt2=2*t.t}function montConvert(t){var e=nbi();return t.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),t.s<0&&e.compareTo(BigInteger.ZERO)>0&&this.m.subTo(e,e),e}function montRevert(t){var e=nbi();return t.copyTo(e),this.reduce(e),e}function montReduce(t){for(;t.t<=this.mt2;)t[t.t++]=0;for(var e=0;e<this.m.t;++e){var i=32767&t[e],s=i*this.mpl+((i*this.mph+(t[e]>>15)*this.mpl&this.um)<<15)&t.DM;
for(i=e+this.m.t,t[i]+=this.m.am(0,s,t,e,0,this.m.t);t[i]>=t.DV;)t[i]-=t.DV,t[++i]++}t.clamp(),t.drShiftTo(this.m.t,t),t.compareTo(this.m)>=0&&t.subTo(this.m,t)}function montSqrTo(t,e){t.squareTo(e),this.reduce(e)}function montMulTo(t,e,i){t.multiplyTo(e,i),this.reduce(i)}function bnpIsEven(){return 0==(this.t>0?1&this[0]:this.s)}function bnpExp(t,e){if(t>4294967295||1>t)return BigInteger.ONE;var i=nbi(),s=nbi(),r=e.convert(this),n=nbits(t)-1;for(r.copyTo(i);--n>=0;)if(e.sqrTo(i,s),(t&1<<n)>0)e.mulTo(s,r,i);else{var a=i;i=s,s=a}return e.revert(i)}function bnModPowInt(t,e){var i;return i=256>t||e.isEven()?new Classic(e):new Montgomery(e),this.exp(t,i)}function parseBigInt(t,e){return new BigInteger(t,e)}function linebrk(t,e){for(var i="",s=0;s+e<t.length;)i+=t.substring(s,s+e)+"\n",s+=e;return i+t.substring(s,t.length)}function byte2Hex(t){return 16>t?"0"+t.toString(16):t.toString(16)}function pkcs1pad2(t,e){if(e<t.length+11)return alert("Message too long for RSA"),null;for(var i=new Array,s=t.length-1;s>=0&&e>0;){var r=t.charCodeAt(s--);128>r?i[--e]=r:r>127&&2048>r?(i[--e]=63&r|128,i[--e]=r>>6|192):(i[--e]=63&r|128,i[--e]=r>>6&63|128,i[--e]=r>>12|224)}i[--e]=0;for(var n=new SecureRandom,a=new Array;e>2;){for(a[0]=0;0==a[0];)n.nextBytes(a);i[--e]=a[0]}return i[--e]=2,i[--e]=0,new BigInteger(i)}function RSAKey(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function RSASetPublic(t,e){null!=t&&null!=e&&t.length>0&&e.length>0?(this.n=parseBigInt(t,16),this.e=parseInt(e,16)):alert("Invalid RSA public key")}function RSADoPublic(t){return t.modPowInt(this.e,this.n)}function RSAEncrypt(t){var e=pkcs1pad2(t,this.n.bitLength()+7>>3);if(null==e)return null;var i=this.doPublic(e);if(null==i)return null;var s=i.toString(16);return 0==(1&s.length)?s:"0"+s}function Arcfour(){this.i=0,this.j=0,this.S=new Array}function ARC4init(t){var e,i,s;for(e=0;256>e;++e)this.S[e]=e;for(i=0,e=0;256>e;++e)i=i+this.S[e]+t[e%t.length]&255,s=this.S[e],this.S[e]=this.S[i],this.S[i]=s;this.i=0,this.j=0}function ARC4next(){var t;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,t=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=t,this.S[t+this.S[this.i]&255]}function prng_newstate(){return new Arcfour}function rng_seed_int(t){rng_pool[rng_pptr++]^=255&t,rng_pool[rng_pptr++]^=t>>8&255,rng_pool[rng_pptr++]^=t>>16&255,rng_pool[rng_pptr++]^=t>>24&255,rng_pptr>=rng_psize&&(rng_pptr-=rng_psize)}function rng_seed_time(){rng_seed_int((new Date).getTime())}function rng_get_byte(){if(null==rng_state){for(rng_seed_time(),rng_state=prng_newstate(),rng_state.init(rng_pool),rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0}return rng_state.next()}function rng_get_bytes(t){var e;for(e=0;e<t.length;++e)t[e]=rng_get_byte()}function SecureRandom(){}function hex_sha1(t){return rstr2hex(rstr_sha1(str2rstr_utf8(t)))}function b64_sha1(t){return rstr2b64(rstr_sha1(str2rstr_utf8(t)))}function any_sha1(t,e){return rstr2any(rstr_sha1(str2rstr_utf8(t)),e)}function hex_hmac_sha1(t,e){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(t),str2rstr_utf8(e)))}function b64_hmac_sha1(t,e){return rstr2b64(rstr_hmac_sha1(str2rstr_utf8(t),str2rstr_utf8(e)))}function any_hmac_sha1(t,e,i){return rstr2any(rstr_hmac_sha1(str2rstr_utf8(t),str2rstr_utf8(e)),i)}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(t){return binb2rstr(binb_sha1(rstr2binb(t),8*t.length))}function rstr_hmac_sha1(t,e){var i=rstr2binb(t);i.length>16&&(i=binb_sha1(i,8*t.length));for(var s=Array(16),r=Array(16),n=0;16>n;n++)s[n]=909522486^i[n],r[n]=1549556828^i[n];var a=binb_sha1(s.concat(rstr2binb(e)),512+8*e.length);return binb2rstr(binb_sha1(r.concat(a),672))}function rstr2hex(t){try{}catch(e){hexcase=0}for(var i,s=hexcase?"0123456789ABCDEF":"0123456789abcdef",r="",n=0;n<t.length;n++)i=t.charCodeAt(n),r+=s.charAt(i>>>4&15)+s.charAt(15&i);return r}function rstr2b64(t){try{}catch(e){b64pad=""}for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s="",r=t.length,n=0;r>n;n+=3)for(var a=t.charCodeAt(n)<<16|(r>n+1?t.charCodeAt(n+1)<<8:0)|(r>n+2?t.charCodeAt(n+2):0),_=0;4>_;_++)s+=8*n+6*_>8*t.length?b64pad:i.charAt(a>>>6*(3-_)&63);return s}function rstr2any(t,e){var i,s,r,n,a=e.length,_=Array(),o=Array(Math.ceil(t.length/2));for(i=0;i<o.length;i++)o[i]=t.charCodeAt(2*i)<<8|t.charCodeAt(2*i+1);for(;o.length>0;){for(n=Array(),r=0,i=0;i<o.length;i++)r=(r<<16)+o[i],s=Math.floor(r/a),r-=s*a,(n.length>0||s>0)&&(n[n.length]=s);_[_.length]=r,o=n}var c="";for(i=_.length-1;i>=0;i--)c+=e.charAt(_[i]);var h=Math.ceil(8*t.length/(Math.log(e.length)/Math.log(2)));for(i=c.length;h>i;i++)c=e[0]+c;return c}function str2rstr_utf8(t){for(var e,i,s="",r=-1;++r<t.length;)e=t.charCodeAt(r),i=r+1<t.length?t.charCodeAt(r+1):0,e>=55296&&56319>=e&&i>=56320&&57343>=i&&(e=65536+((1023&e)<<10)+(1023&i),r++),127>=e?s+=String.fromCharCode(e):2047>=e?s+=String.fromCharCode(192|e>>>6&31,128|63&e):65535>=e?s+=String.fromCharCode(224|e>>>12&15,128|e>>>6&63,128|63&e):2097151>=e&&(s+=String.fromCharCode(240|e>>>18&7,128|e>>>12&63,128|e>>>6&63,128|63&e));return s}function str2rstr_utf16le(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(255&t.charCodeAt(i),t.charCodeAt(i)>>>8&255);return e}function str2rstr_utf16be(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(t.charCodeAt(i)>>>8&255,255&t.charCodeAt(i));return e}function rstr2binb(t){for(var e=Array(t.length>>2),i=0;i<e.length;i++)e[i]=0;for(var i=0;i<8*t.length;i+=8)e[i>>5]|=(255&t.charCodeAt(i/8))<<24-i%32;return e}function binb2rstr(t){for(var e="",i=0;i<32*t.length;i+=8)e+=String.fromCharCode(t[i>>5]>>>24-i%32&255);return e}function binb_sha1(t,e){t[e>>5]|=128<<24-e%32,t[(e+64>>9<<4)+15]=e;for(var i=Array(80),s=1732584193,r=-271733879,n=-1732584194,a=271733878,_=-1009589776,o=0;o<t.length;o+=16){for(var c=s,h=r,p=n,u=a,d=_,f=0;80>f;f++){i[f]=16>f?t[o+f]:bit_rol(i[f-3]^i[f-8]^i[f-14]^i[f-16],1);var l=safe_add(safe_add(bit_rol(s,5),sha1_ft(f,r,n,a)),safe_add(safe_add(_,i[f]),sha1_kt(f)));_=a,a=n,n=bit_rol(r,30),r=s,s=l}s=safe_add(s,c),r=safe_add(r,h),n=safe_add(n,p),a=safe_add(a,u),_=safe_add(_,d)}return Array(s,r,n,a,_)}function sha1_ft(t,e,i,s){return 20>t?e&i|~e&s:40>t?e^i^s:60>t?e&i|e&s|i&s:e^i^s}function sha1_kt(t){return 20>t?1518500249:40>t?1859775393:60>t?-1894007588:-899497514}function safe_add(t,e){var i=(65535&t)+(65535&e),s=(t>>16)+(e>>16)+(i>>16);return s<<16|65535&i}function bit_rol(t,e){return t<<e|t>>>32-e}function MGF1(t,e){var i,s,r;for(i=0,r=0;r<t.length;i++){var n=new String;for(s=0;s<e.length;s++)n+=String.fromCharCode(e[s]);n+=String.fromCharCode(i>>24&255),n+=String.fromCharCode(i>>16&255),n+=String.fromCharCode(i>>8&255),n+=String.fromCharCode(255&i);var a=rstr_sha1(n);for(s=0;s<a.length&&r<t.length;s++,r++)t[r]=a.charCodeAt(s)}}function RSA_padding_add_PKCS1_OAEP(t,e,i){var s=new Array(SHA_DIGEST_LENGTH),r=new SecureRandom;r.nextBytes(s);var n,a=t-1-s.length,_=new Array(a),o=a-e.length-1;if(void 0===i&&(i=""),SHA_DIGEST_LENGTH>o)return console.log("Error - data too large for key size."),null;for(n=0;o>n;n++)_[n]=0;var c=rstr_sha1(i);for(n=0;n<c.length;n++)_[n]=c.charCodeAt(n);for(_[o]=1,n=0;n<e.length;n++)_[n+o+1]=e.charCodeAt(n);var h=new Array(a);if(MGF1(h,s)<0)return null;for(n=0;n<h.length;n++)_[n]^=h[n];var p=Array(SHA_DIGEST_LENGTH);if(MGF1(p,_)<0)return null;for(n=0;n<p.length;n++)s[n]^=p[n];var u=new String;for(u+=String.fromCharCode(0),n=0;n<s.length;n++)u+=String.fromCharCode(s[n]);for(n=0;n<_.length;n++)u+=String.fromCharCode(_[n]);return u}function asn_get_length(t,e){var i=t[e++];if(i>128){if(129!=i)return console.log("Error:  we lazily don't support keys bigger than 255 bytes.  It'd be easy to fix."),null;i=t[e++]}return[e,i]}function find_sequence(t,e){var i;return e=e||0,48!=t[e++]?(console.log("Error:  public key should start with a sequence flag."),null):(i=asn_get_length(t,e),i?i:null)}function create_rsa_from_mb(t,e){var i,s,r,n,a,_=new Uint8Array(t);if(s=find_sequence(_,e),!s)return null;if(e=s[0],s=find_sequence(_,e),!s)return null;if(e=s[0]+s[1],3!=_[e++])return console.log("Error: expecting bit string next."),null;if(i=asn_get_length(_,e),!i)return null;if(e=i[0],0!=_[e]&&48!=_[e+1])return console.log("Error: unexpected values in bit string."),null;if(s=find_sequence(_,e+1),!s)return null;if(e=s[0],2!=_[e++])return console.log("Error: expecting integer n next."),null;if(i=asn_get_length(_,e),!i)return null;for(e=i[0],r=new Array(i[1]),n=0;n<i[1];n++)r[n]=_[e+n];if(a=new RSAKey,a.n=new BigInteger(r),e+=i[1],2!=_[e++])return console.log("Error: expecting integer e next."),null;if(i=asn_get_length(_,e),!i)return null;for(e=i[0],a.e=_[e++],n=1;n<i[1];n++)a.e<<=8,a.e|=_[e++];return a}function rsa_encrypt(t,e){var i,s=[],r=RSA_padding_add_PKCS1_OAEP(t.n.bitLength()+7>>3,e);if(!r)return null;var n=new Array(r.length);for(i=0;i<r.length;i++)n[i]=r.charCodeAt(i);var a=new BigInteger(n),_=t.doPublic(a),o=_.toString(16);for(0!=(1&o.length)&&(o="0"+o),i=0;i<o.length;i+=2)s[i/2]=parseInt(o.substring(i,i+2),16);return s}function resize_helper(t){var e=document.getElementById(t.screen_id).clientWidth,i=document.getElementById(t.screen_id).clientHeight,s=document.getElementById(t.message_id),r=window.innerHeight-s.offsetHeight-s.offsetTop-20;i+=r,i%8>0&&(i+=8-i%8),e%8>0&&(e+=8-e%8),t.resize_window(0,e,i,32,0,0),t.spice_resize_timer=void 0}function handle_resize(){var t=window.spice_connection;t&&t.spice_resize_timer&&(window.clearTimeout(t.spice_resize_timer),t.spice_resize_timer=void 0),t.spice_resize_timer=window.setTimeout(resize_helper,200,t)}function SpiceFileXferTask(t,e){this.id=t,this.file=e}function handle_file_dragover(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"}function handle_file_drop(t){var e=window.spice_connection,i=t.dataTransfer.files;t.stopPropagation(),t.preventDefault();for(var s=i.length-1;s>=0;s--)i[s].type,e.file_xfer_start(i[s])}function SpiceMainConn(){if("undefined"==typeof WebSocket)throw new Error("WebSocket unavailable.  You need to use a different browser.");SpiceConn.apply(this,arguments),this.agent_msg_queue=[],this.file_xfer_tasks={},this.file_xfer_task_id=0,this.file_xfer_read_queue=[]}var requirejs,require,define;!function(t){function e(t,e){return m.call(t,e)}function i(t,e){var i,s,r,n,a,_,o,c,h,p,u,d=e&&e.split("/"),f=l.map,E=f&&f["*"]||{};if(t&&"."===t.charAt(0))if(e){for(t=t.split("/"),a=t.length-1,l.nodeIdCompat&&S.test(t[a])&&(t[a]=t[a].replace(S,"")),t=d.slice(0,d.length-1).concat(t),h=0;h<t.length;h+=1)if(u=t[h],"."===u)t.splice(h,1),h-=1;else if(".."===u){if(1===h&&(".."===t[2]||".."===t[0]))break;h>0&&(t.splice(h-1,2),h-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((d||E)&&f){for(i=t.split("/"),h=i.length;h>0;h-=1){if(s=i.slice(0,h).join("/"),d)for(p=d.length;p>0;p-=1)if(r=f[d.slice(0,p).join("/")],r&&(r=r[s])){n=r,_=h;break}if(n)break;!o&&E&&E[s]&&(o=E[s],c=h)}!n&&o&&(n=o,_=c),n&&(i.splice(0,_,n),t=i.join("/"))}return t}function s(e,i){return function(){var s=g.call(arguments,0);return"string"!=typeof s[0]&&1===s.length&&s.push(null),h.apply(t,s.concat([e,i]))}}function r(t){return function(e){return i(e,t)}}function n(t){return function(e){d[t]=e}}function a(i){if(e(f,i)){var s=f[i];delete f[i],E[i]=!0,c.apply(t,s)}if(!e(d,i)&&!e(E,i))throw new Error("No "+i);return d[i]}function _(t){var e,i=t?t.indexOf("!"):-1;return i>-1&&(e=t.substring(0,i),t=t.substring(i+1,t.length)),[e,t]}function o(t){return function(){return l&&l.config&&l.config[t]||{}}}var c,h,p,u,d={},f={},l={},E={},m=Object.prototype.hasOwnProperty,g=[].slice,S=/\.js$/;p=function(t,e){var s,n=_(t),o=n[0];return t=n[1],o&&(o=i(o,e),s=a(o)),o?t=s&&s.normalize?s.normalize(t,r(e)):i(t,e):(t=i(t,e),n=_(t),o=n[0],t=n[1],o&&(s=a(o))),{f:o?o+"!"+t:t,n:t,pr:o,p:s}},u={require:function(t){return s(t)},exports:function(t){var e=d[t];return"undefined"!=typeof e?e:d[t]={}},module:function(t){return{id:t,uri:"",exports:d[t],config:o(t)}}},c=function(i,r,_,o){var c,h,l,m,g,S,b=[],C=typeof _;if(o=o||i,"undefined"===C||"function"===C){for(r=!r.length&&_.length?["require","exports","module"]:r,g=0;g<r.length;g+=1)if(m=p(r[g],o),h=m.f,"require"===h)b[g]=u.require(i);else if("exports"===h)b[g]=u.exports(i),S=!0;else if("module"===h)c=b[g]=u.module(i);else if(e(d,h)||e(f,h)||e(E,h))b[g]=a(h);else{if(!m.p)throw new Error(i+" missing "+h);m.p.load(m.n,s(o,!0),n(h),{}),b[g]=d[h]}l=_?_.apply(d[i],b):void 0,i&&(c&&c.exports!==t&&c.exports!==d[i]?d[i]=c.exports:l===t&&S||(d[i]=l))}else i&&(d[i]=_)},requirejs=require=h=function(e,i,s,r,n){if("string"==typeof e)return u[e]?u[e](i):a(p(e,i).f);if(!e.splice){if(l=e,l.deps&&h(l.deps,l.callback),!i)return;i.splice?(e=i,i=s,s=null):e=t}return i=i||function(){},"function"==typeof s&&(s=r,r=n),r?c(t,e,i,s):setTimeout(function(){c(t,e,i,s)},4),h},h.config=function(t){return h(t)},requirejs._defined=d,define=function(t,i,s){if("string"!=typeof t)throw new Error("See almond README: incorrect module build, no module name");i.splice||(s=i,i=[]),e(d,t)||e(f,t)||(f[t]=[t,i,s])},define.amd={jQuery:!0}}(),define("almond",function(){}),SpiceConn.prototype={send_hdr:function(){var t=new SpiceLinkHeader,e=new SpiceLinkMess;e.connection_id=this.connection_id,e.channel_type=this.type,e.common_caps.push(1<<SPICE_COMMON_CAP_PROTOCOL_AUTH_SELECTION|1<<SPICE_COMMON_CAP_MINI_HEADER),e.channel_type==SPICE_CHANNEL_PLAYBACK?e.channel_caps.push(1<<SPICE_PLAYBACK_CAP_OPUS):e.channel_type==SPICE_CHANNEL_MAIN&&e.channel_caps.push(1<<SPICE_MAIN_CAP_AGENT_CONNECTED_TOKENS),t.size=e.buffer_size();var i=new ArrayBuffer(t.buffer_size()+e.buffer_size());t.to_buffer(i),e.to_buffer(i,t.buffer_size()),DEBUG>1&&console.log("Sending header:"),DEBUG>2&&hexdump_buffer(i),this.ws.send(i)},send_ticket:function(t){var e=new SpiceLinkAuthTicket;e.auth_mechanism=SPICE_COMMON_CAP_AUTH_SPICE,e.encrypted_data=t;var i=new ArrayBuffer(e.buffer_size());e.to_buffer(i),DEBUG>1&&console.log("Sending ticket:"),DEBUG>2&&hexdump_buffer(i),this.ws.send(i)},send_msg:function(t){var e=new ArrayBuffer(t.buffer_size());t.to_buffer(e),this.messages_sent++,DEBUG>0&&console.log(">> hdr "+this.channel_type()+" type "+t.type+" size "+e.byteLength),DEBUG>2&&hexdump_buffer(e),this.ws.send(e)},process_inbound:function(t,e){if(DEBUG>2&&console.log(this.type+": processing message of size "+t.byteLength+"; state is "+this.state),"ready"==this.state)if(void 0==e){var i=new SpiceMiniData(t);i.type>500&&alert("Something has gone very wrong; we think we have message of type "+i.type),0==i.size?(this.process_message(i),this.wire_reader.request(SpiceMiniData.prototype.buffer_size())):(this.wire_reader.request(i.size),this.wire_reader.save_header(i))}else e.data=t,this.process_message(e),this.wire_reader.request(SpiceMiniData.prototype.buffer_size()),this.wire_reader.save_header(void 0);else if("start"==this.state)if(this.reply_hdr=new SpiceLinkHeader(t),this.reply_hdr.magic!=SPICE_MAGIC){this.state="error";var s=new Error("Error: magic mismatch: "+this.reply_hdr.magic);this.report_error(s)}else this.wire_reader.request(this.reply_hdr.size),this.state="link";else if("link"==this.state)if(this.reply_link=new SpiceLinkReply(t),this.reply_link.error){this.state="error";var s=new Error("Error: reply link error "+this.reply_link.error);this.report_error(s)}else this.send_ticket(rsa_encrypt(this.reply_link.pub_key,this.password+String.fromCharCode(0))),this.state="ticket",this.wire_reader.request(SpiceLinkAuthReply.prototype.buffer_size());else if("ticket"==this.state)if(this.auth_reply=new SpiceLinkAuthReply(t),this.auth_reply.auth_code==SPICE_LINK_ERR_OK){if(DEBUG>0&&console.log(this.type+": Connected"),this.type==SPICE_CHANNEL_DISPLAY){var r=new SpiceMsgcDisplayInit,n=new SpiceMiniData;n.build_msg(SPICE_MSGC_DISPLAY_INIT,r),DEBUG>0&&console.log("Request display init"),this.send_msg(n)}this.state="ready",this.wire_reader.request(SpiceMiniData.prototype.buffer_size()),this.timeout&&(window.clearTimeout(this.timeout),delete this.timeout)}else{if(this.state="error",this.auth_reply.auth_code==SPICE_LINK_ERR_PERMISSION_DENIED)var s=new Error("Permission denied.");else var s=new Error("Unexpected link error "+this.auth_reply.auth_code);this.report_error(s)}},process_common_messages:function(t){if(t.type==SPICE_MSG_SET_ACK){var e=new SpiceMsgSetAck(t.data);this.ack_window=e.window,DEBUG>1&&console.log(this.type+": set ack to "+e.window),this.msgs_until_ack=this.ack_window;var i=new SpiceMsgcAckSync(e),s=new SpiceMiniData;return s.build_msg(SPICE_MSGC_ACK_SYNC,i),this.send_msg(s),!0}if(t.type==SPICE_MSG_PING){DEBUG>1&&console.log("ping!");var r=new SpiceMiniData;return r.type=SPICE_MSGC_PONG,t.data&&(r.data=t.data.slice(0,12)),r.size=r.buffer_size(),this.send_msg(r),!0}if(t.type==SPICE_MSG_NOTIFY){var n=new SpiceMsgNotify(t.data);return n.severity==SPICE_NOTIFY_SEVERITY_ERROR?this.log_err(n.message):n.severity==SPICE_NOTIFY_SEVERITY_WARN?this.log_warn(n.message):this.log_info(n.message),!0}return!1},process_message:function(t){var e;if(DEBUG>0&&console.log("<< hdr "+this.channel_type()+" type "+t.type+" size "+(t.data&&t.data.byteLength)),e=this.process_common_messages(t),e||(this.process_channel_message?(e=this.process_channel_message(t),e||this.log_warn(this.type+": Unknown message type "+t.type+"!")):this.log_err(this.type+": No message handlers for this channel; message "+t.type)),void 0!==this.msgs_until_ack&&this.ack_window&&(this.msgs_until_ack--,this.msgs_until_ack<=0)){this.msgs_until_ack=this.ack_window;var i=new SpiceMiniData;i.type=SPICE_MSGC_ACK,this.send_msg(i),DEBUG>1&&console.log(this.type+": sent ack")}return e},channel_type:function(){return this.type==SPICE_CHANNEL_MAIN?"main":this.type==SPICE_CHANNEL_DISPLAY?"display":this.type==SPICE_CHANNEL_INPUTS?"inputs":this.type==SPICE_CHANNEL_CURSOR?"cursor":"unknown-"+this.type},log_info:function(){var t=Array.prototype.join.call(arguments," ");if(console.log(t),this.message_id){var e=document.createElement("p");e.appendChild(document.createTextNode(t)),e.className+="spice-message-info",document.getElementById(this.message_id).appendChild(e)}},log_warn:function(){var t=Array.prototype.join.call(arguments," ");if(console.log("WARNING: "+t),this.message_id){var e=document.createElement("p");e.appendChild(document.createTextNode(t)),e.className+="spice-message-warning",document.getElementById(this.message_id).appendChild(e)}},log_err:function(){var t=Array.prototype.join.call(arguments," ");if(console.log("ERROR: "+t),this.message_id){var e=document.createElement("p");e.appendChild(document.createTextNode(t)),e.className+="spice-message-error",document.getElementById(this.message_id).appendChild(e)}},known_unimplemented:function(t,e){if(!this.warnings[t]||DEBUG>1){var i="";1>=DEBUG&&(i=" [ further notices suppressed ]"),this.log_warn("Unimplemented function "+t+"("+e+")"+i),this.warnings[t]=!0}},report_error:function(t){if(this.log_err(t.toString()),void 0==this.onerror)throw t;this.onerror(t)},report_success:function(t){void 0!=this.onsuccess&&this.onsuccess(t)},cleanup:function(){this.timeout&&(window.clearTimeout(this.timeout),delete this.timeout),this.ws&&(this.ws.close(),this.ws=void 0)},handle_timeout:function(){var t=new Error("Connection timed out.");this.report_error(t)}},define("spice-spiceconn",function(){}),ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=SpiceArrayBufferSlice,console.log("WARNING:  ArrayBuffer.slice() is missing; we are extending ArrayBuffer to compensate")),define("spice-spicearraybuffer",function(){});var SPICE_MAGIC="REDQ",SPICE_VERSION_MAJOR=2,SPICE_VERSION_MINOR=2,SPICE_CONNECT_TIMEOUT=3e4,SPICE_COMMON_CAP_PROTOCOL_AUTH_SELECTION=0,SPICE_COMMON_CAP_AUTH_SPICE=1,SPICE_COMMON_CAP_AUTH_SASL=2,SPICE_COMMON_CAP_MINI_HEADER=3,SPICE_TICKET_KEY_PAIR_LENGTH=1024,SPICE_TICKET_PUBKEY_BYTES=SPICE_TICKET_KEY_PAIR_LENGTH/8+34,SPICE_LINK_ERR_OK=0,SPICE_LINK_ERR_ERROR=1,SPICE_LINK_ERR_INVALID_MAGIC=2,SPICE_LINK_ERR_INVALID_DATA=3,SPICE_LINK_ERR_VERSION_MISMATCH=4,SPICE_LINK_ERR_NEED_SECURED=5,SPICE_LINK_ERR_NEED_UNSECURED=6,SPICE_LINK_ERR_PERMISSION_DENIED=7,SPICE_LINK_ERR_BAD_CONNECTION_ID=8,SPICE_LINK_ERR_CHANNEL_NOT_AVAILABLE=9,SPICE_MSG_MIGRATE=1,SPICE_MSG_MIGRATE_DATA=2,SPICE_MSG_SET_ACK=3,SPICE_MSG_PING=4,SPICE_MSG_WAIT_FOR_CHANNELS=5,SPICE_MSG_DISCONNECTING=6,SPICE_MSG_NOTIFY=7,SPICE_MSG_LIST=8,SPICE_MSG_MAIN_MIGRATE_BEGIN=101,SPICE_MSG_MAIN_MIGRATE_CANCEL=102,SPICE_MSG_MAIN_INIT=103,SPICE_MSG_MAIN_CHANNELS_LIST=104,SPICE_MSG_MAIN_MOUSE_MODE=105,SPICE_MSG_MAIN_MULTI_MEDIA_TIME=106,SPICE_MSG_MAIN_AGENT_CONNECTED=107,SPICE_MSG_MAIN_AGENT_DISCONNECTED=108,SPICE_MSG_MAIN_AGENT_DATA=109,SPICE_MSG_MAIN_AGENT_TOKEN=110,SPICE_MSG_MAIN_MIGRATE_SWITCH_HOST=111,SPICE_MSG_MAIN_MIGRATE_END=112,SPICE_MSG_MAIN_NAME=113,SPICE_MSG_MAIN_UUID=114,SPICE_MSG_MAIN_AGENT_CONNECTED_TOKENS=115,SPICE_MSG_MAIN_MIGRATE_BEGIN_SEAMLESS=116,SPICE_MSG_MAIN_MIGRATE_DST_SEAMLESS_ACK=117,SPICE_MSG_MAIN_MIGRATE_DST_SEAMLESS_NACK=118,SPICE_MSG_END_MAIN=119,SPICE_MSGC_ACK_SYNC=1,SPICE_MSGC_ACK=2,SPICE_MSGC_PONG=3,SPICE_MSGC_MIGRATE_FLUSH_MARK=4,SPICE_MSGC_MIGRATE_DATA=5,SPICE_MSGC_DISCONNECTING=6,SPICE_MSGC_MAIN_CLIENT_INFO=101,SPICE_MSGC_MAIN_MIGRATE_CONNECTED=102,SPICE_MSGC_MAIN_MIGRATE_CONNECT_ERROR=103,SPICE_MSGC_MAIN_ATTACH_CHANNELS=104,SPICE_MSGC_MAIN_MOUSE_MODE_REQUEST=105,SPICE_MSGC_MAIN_AGENT_START=106,SPICE_MSGC_MAIN_AGENT_DATA=107,SPICE_MSGC_MAIN_AGENT_TOKEN=108,SPICE_MSGC_MAIN_MIGRATE_END=109,SPICE_MSGC_END_MAIN=110,SPICE_MSG_DISPLAY_MODE=101,SPICE_MSG_DISPLAY_MARK=102,SPICE_MSG_DISPLAY_RESET=103,SPICE_MSG_DISPLAY_COPY_BITS=104,SPICE_MSG_DISPLAY_INVAL_LIST=105,SPICE_MSG_DISPLAY_INVAL_ALL_PIXMAPS=106,SPICE_MSG_DISPLAY_INVAL_PALETTE=107,SPICE_MSG_DISPLAY_INVAL_ALL_PALETTES=108,SPICE_MSG_DISPLAY_STREAM_CREATE=122,SPICE_MSG_DISPLAY_STREAM_DATA=123,SPICE_MSG_DISPLAY_STREAM_CLIP=124,SPICE_MSG_DISPLAY_STREAM_DESTROY=125,SPICE_MSG_DISPLAY_STREAM_DESTROY_ALL=126,SPICE_MSG_DISPLAY_DRAW_FILL=302,SPICE_MSG_DISPLAY_DRAW_OPAQUE=303,SPICE_MSG_DISPLAY_DRAW_COPY=304,SPICE_MSG_DISPLAY_DRAW_BLEND=305,SPICE_MSG_DISPLAY_DRAW_BLACKNESS=306,SPICE_MSG_DISPLAY_DRAW_WHITENESS=307,SPICE_MSG_DISPLAY_DRAW_INVERS=308,SPICE_MSG_DISPLAY_DRAW_ROP3=309,SPICE_MSG_DISPLAY_DRAW_STROKE=310,SPICE_MSG_DISPLAY_DRAW_TEXT=311,SPICE_MSG_DISPLAY_DRAW_TRANSPARENT=312,SPICE_MSG_DISPLAY_DRAW_ALPHA_BLEND=313,SPICE_MSG_DISPLAY_SURFACE_CREATE=314,SPICE_MSG_DISPLAY_SURFACE_DESTROY=315,SPICE_MSGC_DISPLAY_INIT=101,SPICE_MSG_INPUTS_INIT=101,SPICE_MSG_INPUTS_KEY_MODIFIERS=102,SPICE_MSG_INPUTS_MOUSE_MOTION_ACK=111,SPICE_MSGC_INPUTS_KEY_DOWN=101,SPICE_MSGC_INPUTS_KEY_UP=102,SPICE_MSGC_INPUTS_KEY_MODIFIERS=103,SPICE_MSGC_INPUTS_MOUSE_MOTION=111,SPICE_MSGC_INPUTS_MOUSE_POSITION=112,SPICE_MSGC_INPUTS_MOUSE_PRESS=113,SPICE_MSGC_INPUTS_MOUSE_RELEASE=114,SPICE_MSG_CURSOR_INIT=101,SPICE_MSG_CURSOR_RESET=102,SPICE_MSG_CURSOR_SET=103,SPICE_MSG_CURSOR_MOVE=104,SPICE_MSG_CURSOR_HIDE=105,SPICE_MSG_CURSOR_TRAIL=106,SPICE_MSG_CURSOR_INVAL_ONE=107,SPICE_MSG_CURSOR_INVAL_ALL=108,SPICE_MSG_PLAYBACK_DATA=101,SPICE_MSG_PLAYBACK_MODE=102,SPICE_MSG_PLAYBACK_START=103,SPICE_MSG_PLAYBACK_STOP=104,SPICE_MSG_PLAYBACK_VOLUME=105,SPICE_MSG_PLAYBACK_MUTE=106,SPICE_MSG_PLAYBACK_LATENCY=107,SPICE_PLAYBACK_CAP_CELT_0_5_1=0,SPICE_PLAYBACK_CAP_VOLUME=1,SPICE_PLAYBACK_CAP_LATENCY=2,SPICE_PLAYBACK_CAP_OPUS=3,SPICE_MAIN_CAP_SEMI_SEAMLESS_MIGRATE=0,SPICE_MAIN_CAP_NAME_AND_UUID=1,SPICE_MAIN_CAP_AGENT_CONNECTED_TOKENS=2,SPICE_MAIN_CAP_SEAMLESS_MIGRATE=3,SPICE_AUDIO_DATA_MODE_INVALID=0,SPICE_AUDIO_DATA_MODE_RAW=1,SPICE_AUDIO_DATA_MODE_CELT_0_5_1=2,SPICE_AUDIO_DATA_MODE_OPUS=3,SPICE_AUDIO_FMT_INVALID=0,SPICE_AUDIO_FMT_S16=1,SPICE_CHANNEL_MAIN=1,SPICE_CHANNEL_DISPLAY=2,SPICE_CHANNEL_INPUTS=3,SPICE_CHANNEL_CURSOR=4,SPICE_CHANNEL_PLAYBACK=5,SPICE_CHANNEL_RECORD=6,SPICE_CHANNEL_TUNNEL=7,SPICE_CHANNEL_SMARTCARD=8,SPICE_CHANNEL_USBREDIR=9,SPICE_SURFACE_FLAGS_PRIMARY=1,SPICE_NOTIFY_SEVERITY_INFO=0,SPICE_NOTIFY_SEVERITY_WARN=1,SPICE_NOTIFY_SEVERITY_ERROR=2,SPICE_MOUSE_MODE_SERVER=1,SPICE_MOUSE_MODE_CLIENT=2,SPICE_MOUSE_MODE_MASK=3,SPICE_CLIP_TYPE_NONE=0,SPICE_CLIP_TYPE_RECTS=1,SPICE_IMAGE_TYPE_BITMAP=0,SPICE_IMAGE_TYPE_QUIC=1,SPICE_IMAGE_TYPE_RESERVED=2,SPICE_IMAGE_TYPE_LZ_PLT=100,SPICE_IMAGE_TYPE_LZ_RGB=101,SPICE_IMAGE_TYPE_GLZ_RGB=102,SPICE_IMAGE_TYPE_FROM_CACHE=103,SPICE_IMAGE_TYPE_SURFACE=104,SPICE_IMAGE_TYPE_JPEG=105,SPICE_IMAGE_TYPE_FROM_CACHE_LOSSLESS=106,SPICE_IMAGE_TYPE_ZLIB_GLZ_RGB=107,SPICE_IMAGE_TYPE_JPEG_ALPHA=108,SPICE_IMAGE_FLAGS_CACHE_ME=1,SPICE_IMAGE_FLAGS_HIGH_BITS_SET=2,SPICE_IMAGE_FLAGS_CACHE_REPLACE_ME=4,SPICE_BITMAP_FLAGS_PAL_CACHE_ME=1,SPICE_BITMAP_FLAGS_PAL_FROM_CACHE=2,SPICE_BITMAP_FLAGS_TOP_DOWN=4,SPICE_BITMAP_FLAGS_MASK=7,SPICE_BITMAP_FMT_INVALID=0,SPICE_BITMAP_FMT_1BIT_LE=1,SPICE_BITMAP_FMT_1BIT_BE=2,SPICE_BITMAP_FMT_4BIT_LE=3,SPICE_BITMAP_FMT_4BIT_BE=4,SPICE_BITMAP_FMT_8BIT=5,SPICE_BITMAP_FMT_16BIT=6,SPICE_BITMAP_FMT_24BIT=7,SPICE_BITMAP_FMT_32BIT=8,SPICE_BITMAP_FMT_RGBA=9,SPICE_CURSOR_FLAGS_NONE=1,SPICE_CURSOR_FLAGS_CACHE_ME=2,SPICE_CURSOR_FLAGS_FROM_CACHE=4,SPICE_CURSOR_FLAGS_MASK=7,SPICE_MOUSE_BUTTON_MASK_LEFT=1,SPICE_MOUSE_BUTTON_MASK_MIDDLE=2,SPICE_MOUSE_BUTTON_MASK_RIGHT=4,SPICE_MOUSE_BUTTON_MASK_MASK=7,SPICE_MOUSE_BUTTON_INVALID=0,SPICE_MOUSE_BUTTON_LEFT=1,SPICE_MOUSE_BUTTON_MIDDLE=2,SPICE_MOUSE_BUTTON_RIGHT=3,SPICE_MOUSE_BUTTON_UP=4,SPICE_MOUSE_BUTTON_DOWN=5,SPICE_BRUSH_TYPE_NONE=0,SPICE_BRUSH_TYPE_SOLID=1,SPICE_BRUSH_TYPE_PATTERN=2,SPICE_SURFACE_FMT_INVALID=0,SPICE_SURFACE_FMT_1_A=1,SPICE_SURFACE_FMT_8_A=8,SPICE_SURFACE_FMT_16_555=16,SPICE_SURFACE_FMT_32_xRGB=32,SPICE_SURFACE_FMT_16_565=80,SPICE_SURFACE_FMT_32_ARGB=96,SPICE_ROPD_INVERS_SRC=1,SPICE_ROPD_INVERS_BRUSH=2,SPICE_ROPD_INVERS_DEST=4,SPICE_ROPD_OP_PUT=8,SPICE_ROPD_OP_OR=16,SPICE_ROPD_OP_AND=32,SPICE_ROPD_OP_XOR=64,SPICE_ROPD_OP_BLACKNESS=128,SPICE_ROPD_OP_WHITENESS=256,SPICE_ROPD_OP_INVERS=512,SPICE_ROPD_INVERS_RES=1024,SPICE_ROPD_MASK=2047,LZ_IMAGE_TYPE_INVALID=0,LZ_IMAGE_TYPE_PLT1_LE=1,LZ_IMAGE_TYPE_PLT1_BE=2,LZ_IMAGE_TYPE_PLT4_LE=3,LZ_IMAGE_TYPE_PLT4_BE=4,LZ_IMAGE_TYPE_PLT8=5,LZ_IMAGE_TYPE_RGB16=6,LZ_IMAGE_TYPE_RGB24=7,LZ_IMAGE_TYPE_RGB32=8,LZ_IMAGE_TYPE_RGBA=9,LZ_IMAGE_TYPE_XXXA=10,QUIC_IMAGE_TYPE_INVALID=0,QUIC_IMAGE_TYPE_GRAY=1,QUIC_IMAGE_TYPE_RGB16=2,QUIC_IMAGE_TYPE_RGB24=3,QUIC_IMAGE_TYPE_RGB32=4,QUIC_IMAGE_TYPE_RGBA=5,SPICE_INPUT_MOTION_ACK_BUNCH=4,SPICE_CURSOR_TYPE_ALPHA=0,SPICE_CURSOR_TYPE_MONO=1,SPICE_CURSOR_TYPE_COLOR4=2,SPICE_CURSOR_TYPE_COLOR8=3,SPICE_CURSOR_TYPE_COLOR16=4,SPICE_CURSOR_TYPE_COLOR24=5,SPICE_CURSOR_TYPE_COLOR32=6,SPICE_VIDEO_CODEC_TYPE_MJPEG=1,VD_AGENT_PROTOCOL=1,VD_AGENT_MAX_DATA_SIZE=2048,VD_AGENT_MOUSE_STATE=1,VD_AGENT_MONITORS_CONFIG=2,VD_AGENT_REPLY=3,VD_AGENT_CLIPBOARD=4,VD_AGENT_DISPLAY_CONFIG=5,VD_AGENT_ANNOUNCE_CAPABILITIES=6,VD_AGENT_CLIPBOARD_GRAB=7,VD_AGENT_CLIPBOARD_REQUEST=8,VD_AGENT_CLIPBOARD_RELEASE=9,VD_AGENT_FILE_XFER_START=10,VD_AGENT_FILE_XFER_STATUS=11,VD_AGENT_FILE_XFER_DATA=12,VD_AGENT_CLIENT_DISCONNECTED=13,VD_AGENT_MAX_CLIPBOARD=14,VD_AGENT_CAP_MOUSE_STATE=0,VD_AGENT_CAP_MONITORS_CONFIG=1,VD_AGENT_CAP_REPLY=2,VD_AGENT_CAP_CLIPBOARD=3,VD_AGENT_CAP_DISPLAY_CONFIG=4,VD_AGENT_CAP_CLIPBOARD_BY_DEMAND=5,VD_AGENT_CAP_CLIPBOARD_SELECTION=6,VD_AGENT_CAP_SPARSE_MONITORS_CONFIG=7,VD_AGENT_CAP_GUEST_LINEEND_LF=8,VD_AGENT_CAP_GUEST_LINEEND_CRLF=9,VD_AGENT_CAP_MAX_CLIPBOARD=10,VD_AGENT_END_CAP=11,VD_AGENT_FILE_XFER_STATUS_CAN_SEND_DATA=0,VD_AGENT_FILE_XFER_STATUS_CANCELLED=1,VD_AGENT_FILE_XFER_STATUS_ERROR=2,VD_AGENT_FILE_XFER_STATUS_SUCCESS=3;define("spice-enums",function(){});var KEY_Escape=1,KEY_1=2,KEY_2=3,KEY_3=4,KEY_4=5,KEY_5=6,KEY_6=7,KEY_7=8,KEY_8=9,KEY_9=10,KEY_0=11,KEY_Minus=12,KEY_Equal=13,KEY_BackSpace=14,KEY_Tab=15,KEY_Q=16,KEY_W=17,KEY_E=18,KEY_R=19,KEY_T=20,KEY_Y=21,KEY_U=22,KEY_I=23,KEY_O=24,KEY_P=25,KEY_LBrace=26,KEY_RBrace=27,KEY_Enter=28,KEY_LCtrl=29,KEY_A=30,KEY_S=31,KEY_D=32,KEY_F=33,KEY_G=34,KEY_H=35,KEY_J=36,KEY_K=37,KEY_L=38,KEY_SemiColon=39,KEY_Quote=40,KEY_Tilde=41,KEY_ShiftL=42,KEY_BSlash=43,KEY_Z=44,KEY_X=45,KEY_C=46,KEY_V=47,KEY_B=48,KEY_N=49,KEY_M=50,KEY_Comma=51,KEY_Period=52,KEY_Slash=53,KEY_ShiftR=54,KEY_KP_Multiply=55,KEY_Alt=56,KEY_Space=57,KEY_CapsLock=58,KEY_F1=59,KEY_F2=60,KEY_F3=61,KEY_F4=62,KEY_F5=63,KEY_F6=64,KEY_F7=65,KEY_F8=66,KEY_F9=67,KEY_F10=68,KEY_NumLock=69,KEY_ScrollLock=70,KEY_KP_7=71,KEY_KP_8=72,KEY_KP_9=73,KEY_KP_Minus=74,KEY_KP_4=75,KEY_KP_5=76,KEY_KP_6=77,KEY_KP_Plus=78,KEY_KP_1=79,KEY_KP_2=80,KEY_KP_3=81,KEY_KP_0=82,KEY_KP_Decimal=83,KEY_SysReqest=84,KEY_Less=86,KEY_F11=87,KEY_F12=88,KEY_Prefix0=96,KEY_Prefix1=97;define("spice-atKeynames",function(){});var DEBUG=0,DUMP_DRAWS=!1,DUMP_CANVASES=!1,common_scanmap=[];common_scanmap["Q".charCodeAt(0)]=KEY_Q,common_scanmap["W".charCodeAt(0)]=KEY_W,common_scanmap["E".charCodeAt(0)]=KEY_E,common_scanmap["R".charCodeAt(0)]=KEY_R,common_scanmap["T".charCodeAt(0)]=KEY_T,common_scanmap["Y".charCodeAt(0)]=KEY_Y,common_scanmap["U".charCodeAt(0)]=KEY_U,common_scanmap["I".charCodeAt(0)]=KEY_I,common_scanmap["O".charCodeAt(0)]=KEY_O,common_scanmap["P".charCodeAt(0)]=KEY_P,common_scanmap["A".charCodeAt(0)]=KEY_A,common_scanmap["S".charCodeAt(0)]=KEY_S,common_scanmap["D".charCodeAt(0)]=KEY_D,common_scanmap["F".charCodeAt(0)]=KEY_F,common_scanmap["G".charCodeAt(0)]=KEY_G,common_scanmap["H".charCodeAt(0)]=KEY_H,common_scanmap["J".charCodeAt(0)]=KEY_J,common_scanmap["K".charCodeAt(0)]=KEY_K,common_scanmap["L".charCodeAt(0)]=KEY_L,common_scanmap["Z".charCodeAt(0)]=KEY_Z,common_scanmap["X".charCodeAt(0)]=KEY_X,common_scanmap["C".charCodeAt(0)]=KEY_C,common_scanmap["V".charCodeAt(0)]=KEY_V,common_scanmap["B".charCodeAt(0)]=KEY_B,common_scanmap["N".charCodeAt(0)]=KEY_N,common_scanmap["M".charCodeAt(0)]=KEY_M,common_scanmap[" ".charCodeAt(0)]=KEY_Space,common_scanmap[13]=KEY_Enter,common_scanmap[27]=KEY_Escape,common_scanmap[8]=KEY_BackSpace,common_scanmap[9]=KEY_Tab,common_scanmap[16]=KEY_ShiftL,common_scanmap[17]=KEY_LCtrl,common_scanmap[18]=KEY_Alt,common_scanmap[20]=KEY_CapsLock,common_scanmap[144]=KEY_NumLock,common_scanmap[112]=KEY_F1,common_scanmap[113]=KEY_F2,common_scanmap[114]=KEY_F3,common_scanmap[115]=KEY_F4,common_scanmap[116]=KEY_F5,common_scanmap[117]=KEY_F6,common_scanmap[118]=KEY_F7,common_scanmap[119]=KEY_F8,common_scanmap[120]=KEY_F9,common_scanmap[121]=KEY_F10,common_scanmap[122]=KEY_F11,common_scanmap[123]=KEY_F12,common_scanmap[42]=99,common_scanmap[19]=101,common_scanmap[111]=57397,common_scanmap[106]=57399,common_scanmap[36]=57415,common_scanmap[38]=57416,common_scanmap[33]=57417,common_scanmap[37]=57419,common_scanmap[39]=57421,common_scanmap[35]=57423,common_scanmap[40]=57424,common_scanmap[34]=57425,common_scanmap[45]=57426,common_scanmap[46]=57427,common_scanmap[44]=10807,common_scanmap["1".charCodeAt(0)]=KEY_1,common_scanmap["2".charCodeAt(0)]=KEY_2,common_scanmap["3".charCodeAt(0)]=KEY_3,common_scanmap["4".charCodeAt(0)]=KEY_4,common_scanmap["5".charCodeAt(0)]=KEY_5,common_scanmap["6".charCodeAt(0)]=KEY_6,common_scanmap["7".charCodeAt(0)]=KEY_7,common_scanmap["8".charCodeAt(0)]=KEY_8,common_scanmap["9".charCodeAt(0)]=KEY_9,common_scanmap["0".charCodeAt(0)]=KEY_0,common_scanmap[145]=KEY_ScrollLock,common_scanmap[103]=KEY_KP_7,common_scanmap[104]=KEY_KP_8,common_scanmap[105]=KEY_KP_9,common_scanmap[100]=KEY_KP_4,common_scanmap[101]=KEY_KP_5,common_scanmap[102]=KEY_KP_6,common_scanmap[107]=KEY_KP_Plus,common_scanmap[97]=KEY_KP_1,common_scanmap[98]=KEY_KP_2,common_scanmap[99]=KEY_KP_3,common_scanmap[96]=KEY_KP_0,common_scanmap[110]=KEY_KP_Decimal,common_scanmap[191]=KEY_Slash,common_scanmap[190]=KEY_Period,common_scanmap[188]=KEY_Comma,common_scanmap[220]=KEY_BSlash,common_scanmap[192]=KEY_Tilde,common_scanmap[222]=KEY_Quote,common_scanmap[219]=KEY_LBrace,common_scanmap[221]=KEY_RBrace,common_scanmap[91]=57435,common_scanmap[92]=57436,common_scanmap[93]=57437;var firefox_scanmap=[];firefox_scanmap[173]=KEY_Minus,firefox_scanmap[109]=KEY_Minus,firefox_scanmap[61]=KEY_Equal,firefox_scanmap[59]=KEY_SemiColon;var DOM_scanmap=[];DOM_scanmap[189]=KEY_Minus,DOM_scanmap[187]=KEY_Equal,DOM_scanmap[186]=KEY_SemiColon,define("spice-utils",function(){});
var rfc2083_crc_table=Array(256),rfc2083_crc_table_computed=0;PngIHDR.prototype={to_buffer:function(t,e){e=e||0;var i=e,s=new SpiceDataView(t);return s.setUint32(e,this.buffer_size()-12),e+=4,s.setUint8(e,"I".charCodeAt(0)),e++,s.setUint8(e,"H".charCodeAt(0)),e++,s.setUint8(e,"D".charCodeAt(0)),e++,s.setUint8(e,"R".charCodeAt(0)),e++,s.setUint32(e,this.width),e+=4,s.setUint32(e,this.height),e+=4,s.setUint8(e,this.depth),e++,s.setUint8(e,this.type),e++,s.setUint8(e,this.compression),e++,s.setUint8(e,this.filter),e++,s.setUint8(e,this.interlace),e++,s.setUint32(e,crc32(t,i+4,this.buffer_size()-8)),e+=4},buffer_size:function(){return 25}},adler.prototype.update=function(t){this.s1+=t,this.s1%=65521,this.s2+=this.s1,this.s2%=65521},PngIDAT.prototype={to_buffer:function(t,e){e=e||0;var i,s,r,n=e,a=new SpiceDataView(t),_=new adler;a.setUint32(e,this.buffer_size()-12),e+=4,a.setUint8(e,"I".charCodeAt(0)),e++,a.setUint8(e,"D".charCodeAt(0)),e++,a.setUint8(e,"A".charCodeAt(0)),e++,a.setUint8(e,"T".charCodeAt(0)),e++,a.setUint8(e,120),e++,a.setUint8(e,1),e++,a.setUint8(e,128),e++,a.setUint16(e,this.data.byteLength+this.height),e+=2,a.setUint16(e,~(this.data.byteLength+this.height)),e+=2;var o=new Uint8Array(this.data);for(r=0,s=0;s<this.height;s++)for(a.setUint8(e,0),e++,_.update(0),i=0;i<this.width&&r<this.data.byteLength;i++)_.update(o[r]),a.setUint8(e,o[r++]),e++,_.update(o[r]),a.setUint8(e,o[r++]),e++,_.update(o[r]),a.setUint8(e,o[r++]),e++,_.update(o[r]),a.setUint8(e,o[r++]),e++;return a.setUint16(e,_.s2),e+=2,a.setUint16(e,_.s1),e+=2,a.setUint32(e,crc32(t,n+4,this.buffer_size()-8)),e+=4},buffer_size:function(){return 12+this.data.byteLength+this.height+4+2+1+2+2}},PngIEND.prototype={to_buffer:function(t,e){e=e||0;var i=e,s=new SpiceDataView(t);return s.setUint32(e,this.buffer_size()-12),e+=4,s.setUint8(e,"I".charCodeAt(0)),e++,s.setUint8(e,"E".charCodeAt(0)),e++,s.setUint8(e,"N".charCodeAt(0)),e++,s.setUint8(e,"D".charCodeAt(0)),e++,s.setUint32(e,crc32(t,i+4,this.buffer_size()-8)),e+=4},buffer_size:function(){return 12}},define("spice-png",function(){}),define("spice-lz",function(){});var encoder,QUIC_IMAGE_TYPE_INVALID=0,QUIC_IMAGE_TYPE_GRAY=1,QUIC_IMAGE_TYPE_RGB16=2,QUIC_IMAGE_TYPE_RGB24=3,QUIC_IMAGE_TYPE_RGB32=4,QUIC_IMAGE_TYPE_RGBA=5,DEFevol=3,DEFwmimax=6,DEFwminext=2048,need_init=!0,DEFmaxclen=26,evol=DEFevol,wmimax=DEFwmimax,wminext=DEFwminext,family_5bpc={nGRcodewords:[0,0,0,0,0,0,0,0],notGRcwlen:[0,0,0,0,0,0,0,0],notGRprefixmask:[0,0,0,0,0,0,0,0],notGRsuffixlen:[0,0,0,0,0,0,0,0],xlatU2L:[0,0,0,0,0,0,0,0],xlatL2U:[0,0,0,0,0,0,0,0]},family_8bpc={nGRcodewords:[0,0,0,0,0,0,0,0],notGRcwlen:[0,0,0,0,0,0,0,0],notGRprefixmask:[0,0,0,0,0,0,0,0],notGRsuffixlen:[0,0,0,0,0,0,0,0],xlatU2L:[0,0,0,0,0,0,0,0],xlatL2U:[0,0,0,0,0,0,0,0]},bppmask=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535,131071,262143,524287,1048575,2097151,4194303,8388607,16777215,33554431,67108863,134217727,268435455,536870911,1073741823,2147483647,4294967295],zeroLUT=[],besttrigtab=[[550,900,800,700,500,350,300,200,180,180,160],[110,550,900,800,550,400,350,250,140,160,140],[100,120,550,900,700,500,400,300,220,250,160]],J=[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,5,5,6,6,7,7,8,9,10,11,12,13,14,15],lzeroes=[8,7,6,6,5,5,5,5,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],tabrand_chaos=[46495042,893548311,794435923,2453991765,2077388039,894197842,1462934312,697534094,1826128012,343623392,2581292719,3811265708,459739748,2638427270,1654964626,101227083,2654850628,3668700691,572794346,2758751005,3445133904,2344099199,3367450297,898927923,3618406352,1606297603,754696453,20823118,2050458127,972590750,3990194068,3305596553,4239238564,1690498157,3015324227,2306127097,1510321853,548392192,971157512,2292288069,1611390505,4086766286,4084927083,1883326811,1891043243,113180603,1107690783,3778825955,3248980775,2443839100,2190866218,1932072870,495393613,1078522166,4051963518,1784694977,1768732442,2146763203,264646923,1474361405,2361552500,296035746,2489922759,2094565616,2409465348,1334241083,72483606,3740181004,4057920662,1734898312,4114662834,574624900,880305546,3258472262,26713132,1571648456,52557195,4043234286,2458021343,676064371,1528437109,64953873,546717185,2709319979,1947039598,2812723004,28691684,286829174,4235176970,3465707163,12526951,2154766700,3165032534,2036061161,3386656087,2301212354,2023576300,1061142336,3105452904,2743866805,3283373992,3397596080,3085489552,3196092395,3210707808,3651022684,925444321,2088074316,230011220,3223248386,533229176,523863486,3028311159,13140218,2538347282,900399636,3000796173,1526771255,3541282854,2992674461,2135722105,389334227,1225164337,3119947809,1803959919,3471171263,704170491,1407019136,1924534819,526887421,168782227,333811993,298623278,4268451686,381087740,2542899140,3266880867,2498950977,200969370,3511909096,3252303004,2268881098,2499828613,2606499854,3163208665,3790254546,1840025712,1319758833,3771674836,519421307,3512796222,1563402978,4284300462,2263719815,715250337,3178437172,2660191010,2982332026,3256309961,2709659997,3434092872,2367065591,69438718,915160508,183164069,3134331940,175242981,2680543346,1421955782,4231173251,1736652874,3990568476,1710820912,2286604440,3464587098,1261907837,1757387321,1128554270,1090050251,2429922486,1288729218,882830086,211637042,1376462063,2147615815,1737974929,798170275,4271572277,4241687072,1638524620,2760366295,1065115089,2097227717,1224023317,1625204849,3383303351,1488272307,2640186157,1649047732,819719707,2615091943,502645401,760628135,4108137983,63606742,1404337880,1865161130,4272996852,1239761976,790984678,3213322601,1917062825,4195069880,1962259360,2111002573,2311983960,1861406170,511141875,2797510619,1331661048,3130608186,147483493,3767089176,2650841450,4096523407,2574446300,1956416337,851468126,3607527519,1811658703,3642821136,832691095,2453312857,933732854,94341217,3393797730,1695907457,2405722077,2877685663,2469507058,2249636341,3988608661,4001245617,825934927,3103985967,1127151177,3691656896,1640967098,2168932645,2830550957,3998822878,3002602893,1509651465,775813869,2599574079,3791574229],rgb32_pixel_pad=3,rgb32_pixel_r=2,rgb32_pixel_g=1,rgb32_pixel_b=0,rgb32_pixel_size=4;if(QuicModel.prototype={n_buckets:0,n_buckets_ptrs:0,repfirst:0,firstsize:0,repnext:0,mulsize:0,levels:0},QuicBucket.prototype={bestcode:0,reste:function(t){this.bestcode=t,this.counters=[0,0,0,0,0,0,0,0]},update_model_8bpc:function(t,e,i){var s,r=i-1,n=this.counters[r]+=golomb_code_len_8bpc(e,r);for(s=i-2;s>=0;s--){var a=this.counters[s]+=golomb_code_len_8bpc(e,s);n>a&&(r=s,n=a)}if(this.bestcode=r,n>t.wm_trigger)for(s=0;i>s;s++)this.counters[s]=this.counters[s]>>>1}},QuicFamilyStat.prototype={fill_model_structures:function(t){var e,i=0,s=0,r=t.repfirst+1,n=t.firstsize;do{e=s?i+1:0,--r||(r=t.repnext,n*=t.mulsize),i=e+n-1,i+n>=t.levels&&(i=t.levels-1),this.buckets_buf[s]=new QuicBucket;var a;for(a=e;i>=a;a++)this.buckets_ptrs[a]=this.buckets_buf[s];s++}while(i<t.levels-1);return!0}},QuicChannel.prototype={reste:function(t){var e;if(this.correlate_row={zero:0,row:[]},8==t){for(e=0;e<this.model_8bpc.n_buckets;e++)this.family_stat_8bpc.buckets_buf[e].reste(7);this.buckets_ptrs=this.family_stat_8bpc.buckets_ptrs}else{if(5!=t)return console.log("quic: %s: bad bpc %d\n",__FUNCTION__,t),!1;for(e=0;e<this.model_5bpc.n_buckets;e++)this.family_stat_8bpc.buckets_buf[e].reste(4);this.buckets_ptrs=this.family_stat_5bpc.buckets_ptrs}return this.state.reste(),!0}},CommonState.prototype={waitcnt:0,tabrand_seed:255,wm_trigger:0,wmidx:0,wmileft:wminext,melcstate:0,melclen:0,melcorder:0,set_wm_trigger:function(){var t=this.wmidx;t>10&&(t=10),this.wm_trigger=besttrigtab[Math.floor(evol/2)][t]},reste:function(){this.waitcnt=0,this.tabrand_seed=255,this.wmidx=0,this.wmileft=wminext,this.set_wm_trigger(),this.melcstate=0,this.melclen=J[0],this.melcorder=1<<this.melclen},tabrand:function(){return this.tabrand_seed++,tabrand_chaos[255&this.tabrand_seed]}},QuicEncoder.prototype={type:0,width:0,height:0,io_idx:0,io_available_bits:0,io_word:0,io_next_word:0,io_now:0,io_end:0,rows_completed:0},QuicEncoder.prototype.reste=function(t){return this.rgb_state.reste(),this.io_now=t,this.io_end=this.io_now.length,this.io_idx=0,this.rows_completed=0,!0},QuicEncoder.prototype.read_io_word=function(){if(this.io_idx>=this.io_end)throw"quic: out of data";this.io_next_word=this.io_now[this.io_idx++]|this.io_now[this.io_idx++]<<8|this.io_now[this.io_idx++]<<16|this.io_now[this.io_idx++]<<24},QuicEncoder.prototype.decode_eatbits=function(t){this.io_word=this.io_word<<t;var e=this.io_available_bits-t;e>=0?(this.io_available_bits=e,this.io_word|=this.io_next_word>>>this.io_available_bits):(e=-1*e,this.io_word|=this.io_next_word<<e,this.read_io_word(),this.io_available_bits=32-e,this.io_word|=this.io_next_word>>>this.io_available_bits)},QuicEncoder.prototype.decode_eat32bits=function(){this.decode_eatbits(16),this.decode_eatbits(16)},QuicEncoder.prototype.reste_channels=function(t){var e;for(e=0;4>e;e++)if(!this.channels[e].reste(t))return!1;return!0},QuicEncoder.prototype.quic_decode_begin=function(t){if(!this.reste(t))return!1;this.io_idx=0,this.io_next_word=this.io_now[this.io_idx++]|this.io_now[this.io_idx++]<<8|this.io_now[this.io_idx++]<<16|this.io_now[this.io_idx++]<<24,this.io_word=this.io_next_word,this.io_available_bits=0;var e=this.io_word;if(this.decode_eat32bits(),1128879441!=e)return console.log("quic: bad magic "+e.toString(16)),!1;var i=this.io_word;if(this.decode_eat32bits(),0!=i)return console.log("quic: bad version "+i.toString(16)),!1;this.type=this.io_word,this.decode_eat32bits(),this.width=this.io_word,this.decode_eat32bits(),this.height=this.io_word,this.decode_eat32bits();var s=quic_image_bpc(this.type);return this.reste_channels(s)?!0:!1},QuicEncoder.prototype.quic_rgb32_uncompress_row0_seg=function(t,e,i,s,r,n){var a,_,o,c=3;if(t)a=t+this.rgb_state.waitcnt;else{e[rgb32_pixel_pad]=0,_=0;do o=golomb_decoding_8bpc(this.channels[_].buckets_ptrs[this.channels[_].correlate_row.zero].bestcode,this.io_word),this.channels[_].correlate_row.row[0]=o.rc,e[2-_]=255&family_8bpc.xlatL2U[o.rc],this.decode_eatbits(o.codewordlen);while(++_<c);if(this.rgb_state.waitcnt)--this.rgb_state.waitcnt;else{this.rgb_state.waitcnt=this.rgb_state.tabrand()&s,_=0;do this.channels[_].buckets_ptrs[this.channels[_].correlate_row.zero].update_model_8bpc(this.rgb_state,this.channels[_].correlate_row.row[0],r);while(++_<c)}a=++t+this.rgb_state.waitcnt}for(;i>a;){for(;a>=t;t++){e[t*rgb32_pixel_size+rgb32_pixel_pad]=0,_=0;do o=golomb_decoding_8bpc(this.channels[_].buckets_ptrs[this.channels[_].correlate_row.row[t-1]].bestcode,this.io_word),this.channels[_].correlate_row.row[t]=o.rc,e[t*rgb32_pixel_size+(2-_)]=family_8bpc.xlatL2U[o.rc]+e[(t-1)*rgb32_pixel_size+(2-_)]&n,this.decode_eatbits(o.codewordlen);while(++_<c)}_=0;do this.channels[_].buckets_ptrs[this.channels[_].correlate_row.row[a-1]].update_model_8bpc(this.rgb_state,this.channels[_].correlate_row.row[a],r);while(++_<c);a=t+(this.rgb_state.tabrand()&s)}for(;i>t;t++){e[t*rgb32_pixel_size+rgb32_pixel_pad]=0,_=0;do o=golomb_decoding_8bpc(this.channels[_].buckets_ptrs[this.channels[_].correlate_row.row[t-1]].bestcode,this.io_word),this.channels[_].correlate_row.row[t]=o.rc,e[t*rgb32_pixel_size+(2-_)]=family_8bpc.xlatL2U[o.rc]+e[(t-1)*rgb32_pixel_size+(2-_)]&n,this.decode_eatbits(o.codewordlen);while(++_<c)}this.rgb_state.waitcnt=a-i},QuicEncoder.prototype.quic_rgb32_uncompress_row0=function(t){for(var e=8,i=255,s=0,r=this.width;wmimax>this.rgb_state.wmidx&&this.rgb_state.wmileft<=r;)this.rgb_state.wmileft&&(this.quic_rgb32_uncompress_row0_seg(s,t,s+this.rgb_state.wmileft,bppmask[this.rgb_state.wmidx],e,i),s+=this.rgb_state.wmileft,r-=this.rgb_state.wmileft),this.rgb_state.wmidx++,this.rgb_state.set_wm_trigger(),this.rgb_state.wmileft=wminext;r&&(this.quic_rgb32_uncompress_row0_seg(s,t,s+r,bppmask[this.rgb_state.wmidx],e,i),wmimax>this.rgb_state.wmidx&&(this.rgb_state.wmileft-=r))},QuicEncoder.prototype.quic_rgb32_uncompress_row_seg=function(t,e,i,s,r,n){var a,_,o=3,c=bppmask[this.rgb_state.wmidx],h=0,p=0,u=0;if(i)p=i+this.rgb_state.waitcnt;else{e[rgb32_pixel_pad]=0,_=0;do a=golomb_decoding_8bpc(this.channels[_].buckets_ptrs[this.channels[_].correlate_row.zero].bestcode,this.io_word),this.channels[_].correlate_row.row[0]=a.rc,e[2-_]=family_8bpc.xlatL2U[this.channels[_].correlate_row.row[0]]+t[2-_]&n,this.decode_eatbits(a.codewordlen);while(++_<o);if(this.rgb_state.waitcnt)--this.rgb_state.waitcnt;else{this.rgb_state.waitcnt=this.rgb_state.tabrand()&c,_=0;do this.channels[_].buckets_ptrs[this.channels[_].correlate_row.zero].update_model_8bpc(this.rgb_state,this.channels[_].correlate_row.row[0],r);while(++_<o)}p=++i+this.rgb_state.waitcnt}for(;;){for(var d=0;s>p&&!d;){for(;p>=i&&!d;i++){var f=i*rgb32_pixel_size,l=(i-1)*rgb32_pixel_size,E=(i-2)*rgb32_pixel_size;if(t[l+rgb32_pixel_r]==t[f+rgb32_pixel_r]&&t[l+rgb32_pixel_g]==t[f+rgb32_pixel_g]&&t[l+rgb32_pixel_b]==t[f+rgb32_pixel_b]&&h!=i&&i>2&&e[l+rgb32_pixel_r]==e[E+rgb32_pixel_r]&&e[l+rgb32_pixel_g]==e[E+rgb32_pixel_g]&&e[l+rgb32_pixel_b]==e[E+rgb32_pixel_b]){for(this.rgb_state.waitcnt=p-i,h=i,u=i+this.decode_run(this.rgb_state);u>i;i++){var f=i*rgb32_pixel_size,l=(i-1)*rgb32_pixel_size;e[f+rgb32_pixel_pad]=0,e[f+rgb32_pixel_r]=e[l+rgb32_pixel_r],e[f+rgb32_pixel_g]=e[l+rgb32_pixel_g],e[f+rgb32_pixel_b]=e[l+rgb32_pixel_b]}if(i==s)return;p=i+this.rgb_state.waitcnt,d=1;break}_=0,e[f+rgb32_pixel_pad]=0;do{var m=this.channels[_],g=m.correlate_row;a=golomb_decoding_8bpc(m.buckets_ptrs[g.row[i-1]].bestcode,this.io_word),g.row[i]=a.rc,e[f+(2-_)]=family_8bpc.xlatL2U[a.rc]+(e[l+(2-_)]+t[f+(2-_)]>>1)&n,this.decode_eatbits(a.codewordlen)}while(++_<o)}if(d)break;_=0;do this.channels[_].buckets_ptrs[this.channels[_].correlate_row.row[p-1]].update_model_8bpc(this.rgb_state,this.channels[_].correlate_row.row[p],r);while(++_<o);p=i+(this.rgb_state.tabrand()&c)}for(;s>i&&!d;i++){var f=i*rgb32_pixel_size,l=(i-1)*rgb32_pixel_size,E=(i-2)*rgb32_pixel_size;if(t[l+rgb32_pixel_r]==t[f+rgb32_pixel_r]&&t[l+rgb32_pixel_g]==t[f+rgb32_pixel_g]&&t[l+rgb32_pixel_b]==t[f+rgb32_pixel_b]&&h!=i&&i>2&&e[l+rgb32_pixel_r]==e[E+rgb32_pixel_r]&&e[l+rgb32_pixel_g]==e[E+rgb32_pixel_g]&&e[l+rgb32_pixel_b]==e[E+rgb32_pixel_b]){for(this.rgb_state.waitcnt=p-i,h=i,u=i+this.decode_run(this.rgb_state);u>i;i++){var f=i*rgb32_pixel_size,l=(i-1)*rgb32_pixel_size;e[f+rgb32_pixel_pad]=0,e[f+rgb32_pixel_r]=e[l+rgb32_pixel_r],e[f+rgb32_pixel_g]=e[l+rgb32_pixel_g],e[f+rgb32_pixel_b]=e[l+rgb32_pixel_b]}if(i==s)return;p=i+this.rgb_state.waitcnt,d=1;break}e[f+rgb32_pixel_pad]=0,_=0;do a=golomb_decoding_8bpc(this.channels[_].buckets_ptrs[this.channels[_].correlate_row.row[i-1]].bestcode,this.io_word),this.channels[_].correlate_row.row[i]=a.rc,e[f+(2-_)]=family_8bpc.xlatL2U[a.rc]+(e[l+(2-_)]+t[f+(2-_)]>>1)&n,this.decode_eatbits(a.codewordlen);while(++_<o)}if(!d)return void(this.rgb_state.waitcnt=p-s)}},QuicEncoder.prototype.decode_run=function(t){for(var e=0;;){var i,s=~(this.io_word>>>24)>>>0&255,r=zeroLUT[s];for(i=1;r>=i;i++)e+=t.melcorder,t.melcstate<32&&(t.melclen=J[++t.melcstate],t.melcorder=1<<t.melclen);if(8!=r){this.decode_eatbits(r+1);break}this.decode_eatbits(8)}return t.melclen&&(e+=this.io_word>>>32-t.melclen,this.decode_eatbits(t.melclen)),t.melcstate&&(t.melclen=J[--t.melcstate],t.melcorder=1<<t.melclen),e},QuicEncoder.prototype.quic_rgb32_uncompress_row=function(t,e){for(var i=8,s=255,r=0,n=this.width;wmimax>this.rgb_state.wmidx&&this.rgb_state.wmileft<=n;)this.rgb_state.wmileft&&(this.quic_rgb32_uncompress_row_seg(t,e,r,r+this.rgb_state.wmileft,i,s),r+=this.rgb_state.wmileft,n-=this.rgb_state.wmileft),this.rgb_state.wmidx++,this.rgb_state.set_wm_trigger(),this.rgb_state.wmileft=wminext;n&&(this.quic_rgb32_uncompress_row_seg(t,e,r,r+n,i,s),wmimax>this.rgb_state.wmidx&&(this.rgb_state.wmileft-=n))},QuicEncoder.prototype.quic_four_uncompress_row0_seg=function(t,e,i,s,r,n,a,_){var o,c;for(0==e?(c=golomb_decoding_8bpc(t.buckets_ptrs[i.zero].bestcode,this.io_word),i.row[0]=c.rc,s[rgb32_pixel_pad]=family_8bpc.xlatL2U[c.rc],this.decode_eatbits(c.codewordlen),t.state.waitcnt?--t.state.waitcnt:(t.state.waitcnt=t.state.tabrand()&n,t.buckets_ptrs[i.zero].update_model_8bpc(t.state,i.row[0],a)),o=++e+t.state.waitcnt):o=e+t.state.waitcnt;r>o;){for(var h;o>=e;e++)h=t.buckets_ptrs[i.row[e-1]],c=golomb_decoding_8bpc(h.bestcode,this.io_word),i.row[e]=c.rc,s[e*rgb32_pixel_size+rgb32_pixel_pad]=family_8bpc.xlatL2U[c.rc]+s[(e-1)*rgb32_pixel_size+rgb32_pixel_pad]&_,this.decode_eatbits(c.codewordlen);h.update_model_8bpc(t.state,i.row[o],a),o=e+(t.state.tabrand()&n)}for(;r>e;e++)c=golomb_decoding_8bpc(t.buckets_ptrs[i.row[e-1]].bestcode,this.io_word),i.row[e]=c.rc,s[e*rgb32_pixel_size+rgb32_pixel_pad]=family_8bpc.xlatL2U[c.rc]+s[(e-1)*rgb32_pixel_size+rgb32_pixel_pad]&_,this.decode_eatbits(c.codewordlen);t.state.waitcnt=o-r},QuicEncoder.prototype.quic_four_uncompress_row0=function(t,e){for(var i=8,s=255,r=t.correlate_row,n=0,a=this.width;wmimax>t.state.wmidx&&t.state.wmileft<=a;)t.state.wmileft&&(this.quic_four_uncompress_row0_seg(t,n,r,e,n+t.state.wmileft,bppmask[t.state.wmidx],i,s),n+=t.state.wmileft,a-=t.state.wmileft),t.state.wmidx++,t.state.set_wm_trigger(),t.state.wmileft=wminext;a&&(this.quic_four_uncompress_row0_seg(t,n,r,e,n+a,bppmask[t.state.wmidx],i,s),wmimax>t.state.wmidx&&(t.state.wmileft-=a))},QuicEncoder.prototype.quic_four_uncompress_row_seg=function(t,e,i,s,r,n,a,_){var o,c,h,p=bppmask[t.state.wmidx],u=0;for(0==r?(h=golomb_decoding_8bpc(t.buckets_ptrs[e.zero].bestcode,this.io_word),e.row[0]=h.rc,s[rgb32_pixel_pad]=family_8bpc.xlatL2U[h.rc]+i[rgb32_pixel_pad]&_,this.decode_eatbits(h.codewordlen),t.state.waitcnt?--t.state.waitcnt:(t.state.waitcnt=t.state.tabrand()&p,t.buckets_ptrs[e.zero].update_model_8bpc(t.state,e.row[0],a)),o=++r+t.state.waitcnt):o=r+t.state.waitcnt;;){for(var d=0;n>o&&!d;){for(var f;o>=r&&!d;r++){var l=r*rgb32_pixel_size,E=(r-1)*rgb32_pixel_size,m=(r-2)*rgb32_pixel_size;if(i[E+rgb32_pixel_pad]==i[l+rgb32_pixel_pad]&&u!=r&&r>2&&s[E+rgb32_pixel_pad]==s[m+rgb32_pixel_pad]){for(t.state.waitcnt=o-r,u=r,c=r+this.decode_run(t.state);c>r;r++){var l=r*rgb32_pixel_size,E=(r-1)*rgb32_pixel_size;s[l+rgb32_pixel_pad]=s[E+rgb32_pixel_pad]}if(r==n)return;o=r+t.state.waitcnt,d=1;break}f=t.buckets_ptrs[e.row[r-1]],h=golomb_decoding_8bpc(f.bestcode,this.io_word),e.row[r]=h.rc,s[l+rgb32_pixel_pad]=family_8bpc.xlatL2U[h.rc]+(s[E+rgb32_pixel_pad]+i[l+rgb32_pixel_pad]>>1)&_,this.decode_eatbits(h.codewordlen)}if(d)break;f.update_model_8bpc(t.state,e.row[o],a),o=r+(t.state.tabrand()&p)}for(;n>r&&!d;r++){var l=r*rgb32_pixel_size,E=(r-1)*rgb32_pixel_size,m=(r-2)*rgb32_pixel_size;if(i[E+rgb32_pixel_pad]==i[l+rgb32_pixel_pad]&&u!=r&&r>2&&s[E+rgb32_pixel_pad]==s[m+rgb32_pixel_pad]){for(t.state.waitcnt=o-r,u=r,c=r+this.decode_run(t.state);c>r;r++){var l=r*rgb32_pixel_size,E=(r-1)*rgb32_pixel_size;s[l+rgb32_pixel_pad]=s[E+rgb32_pixel_pad]}if(r==n)return;o=r+t.state.waitcnt,d=1;break}h=golomb_decoding_8bpc(t.buckets_ptrs[e.row[r-1]].bestcode,this.io_word),e.row[r]=h.rc,s[l+rgb32_pixel_pad]=family_8bpc.xlatL2U[h.rc]+(s[E+rgb32_pixel_pad]+i[l+rgb32_pixel_pad]>>1)&_,this.decode_eatbits(h.codewordlen)}if(!d)return void(t.state.waitcnt=o-n)}},QuicEncoder.prototype.quic_four_uncompress_row=function(t,e,i){for(var s=8,r=255,n=t.correlate_row,a=0,_=this.width;wmimax>t.state.wmidx&&t.state.wmileft<=_;)t.state.wmileft&&(this.quic_four_uncompress_row_seg(t,n,e,i,a,a+t.state.wmileft,s,r),a+=t.state.wmileft,_-=t.state.wmileft),t.state.wmidx++,t.state.set_wm_trigger(),t.state.wmileft=wminext;_&&(this.quic_four_uncompress_row_seg(t,n,e,i,a,a+_,s,r),wmimax>t.state.wmidx&&(t.state.wmileft-=_))},QuicEncoder.prototype.quic_decode=function(t,e){var i;switch(this.type){case QUIC_IMAGE_TYPE_RGB32:case QUIC_IMAGE_TYPE_RGB24:for(this.channels[0].correlate_row.zero=0,this.channels[1].correlate_row.zero=0,this.channels[2].correlate_row.zero=0,this.quic_rgb32_uncompress_row0(t),this.rows_completed++,i=1;i<this.height;i++){var s=t;t=s.subarray(e),this.channels[0].correlate_row.zero=this.channels[0].correlate_row.row[0],this.channels[1].correlate_row.zero=this.channels[1].correlate_row.row[0],this.channels[2].correlate_row.zero=this.channels[2].correlate_row.row[0],this.quic_rgb32_uncompress_row(s,t),this.rows_completed++}break;case QUIC_IMAGE_TYPE_RGB16:return console.log("quic: unsupported output format\n"),!1;case QUIC_IMAGE_TYPE_RGBA:for(this.channels[0].correlate_row.zero=0,this.channels[1].correlate_row.zero=0,this.channels[2].correlate_row.zero=0,this.quic_rgb32_uncompress_row0(t),this.channels[3].correlate_row.zero=0,this.quic_four_uncompress_row0(this.channels[3],t),this.rows_completed++,i=1;i<this.height;i++){var s=t;t=s.subarray(e),this.channels[0].correlate_row.zero=this.channels[0].correlate_row.row[0],this.channels[1].correlate_row.zero=this.channels[1].correlate_row.row[0],this.channels[2].correlate_row.zero=this.channels[2].correlate_row.row[0],this.quic_rgb32_uncompress_row(s,t),this.channels[3].correlate_row.zero=this.channels[3].correlate_row.row[0],this.quic_four_uncompress_row(encoder.channels[3],s,t),this.rows_completed++}break;case QUIC_IMAGE_TYPE_GRAY:return console.log("quic: unsupported output format\n"),!1;case QUIC_IMAGE_TYPE_INVALID:default:return console.log("quic: bad image type\n"),!1}return!0},QuicEncoder.prototype.simple_quic_decode=function(t){var e=4;if(!this.quic_decode_begin(t))return void 0;if(this.type!=QUIC_IMAGE_TYPE_RGB32&&this.type!=QUIC_IMAGE_TYPE_RGB24&&this.type!=QUIC_IMAGE_TYPE_RGBA)return void 0;var i=new Uint8Array(this.width*this.height*4);return i[0]=69,this.quic_decode(i,this.width*e)?i:void 0},SpiceQuic.prototype={from_dv:function(t,e,i){if(!encoder)throw"quic: no quic encoder";this.data_size=t.getUint32(e,!0),e+=4;var s=new Uint8Array(i.slice(e));return this.outptr=encoder.simple_quic_decode(s),this.outptr&&(this.type=encoder.type,this.width=encoder.width,this.height=encoder.height),e+=s.length}},need_init){need_init=!1,family_init(family_8bpc,8,DEFmaxclen),family_init(family_5bpc,5,DEFmaxclen);var i,j,k,l;for(j=k=1,l=8,i=0;256>i;++i)zeroLUT[i]=l,--k,0==k&&(k=j,--l,j*=2);if(encoder=new QuicEncoder,!encoder)throw"quic: failed to create encoder"}define("spice-quic",function(){}),define("spice-bitmap",function(){}),SpiceDataView.prototype={getUint8:function(t){return this.u8[t]},getUint16:function(t,e){var i=1,s=0;return e&&(i=0,s=1),this.u8[t+s]<<8|this.u8[t+i]},getUint32:function(t,e){var i=2,s=0;return e&&(i=0,s=2),this.getUint16(t+s,e)<<16|this.getUint16(t+i,e)},getUint64:function(t,e){var i=4,s=0;return e&&(i=0,s=4),this.getUint32(t+s,e)<<32|this.getUint32(t+i,e)},setUint8:function(t,e){this.u8[t]=255&e},setUint16:function(t,e,i){var s=1,r=0;i&&(s=0,r=1),this.u8[t+r]=(65535&e)>>8,this.u8[t+s]=255&e},setUint32:function(t,e,i){var s=2,r=0;i&&(s=0,r=2),this.setUint16(t+r,(4294967295&e)>>16,i),this.setUint16(t+s,65535&e,i)},setUint64:function(t,e,i){var s=4,r=0;i&&(s=0,r=4),this.setUint32(t+r,(0x10000000000000000&e)>>32,i),this.setUint32(t+s,4294967295&e,i)}},define("spice-spicedataview",function(){}),SpiceChannelId.prototype={from_dv:function(t,e){return this.type=t.getUint8(e,!0),e++,this.id=t.getUint8(e,!0),e++,e}},SpiceRect.prototype={from_dv:function(t,e){return this.top=t.getUint32(e,!0),e+=4,this.left=t.getUint32(e,!0),e+=4,this.bottom=t.getUint32(e,!0),e+=4,this.right=t.getUint32(e,!0),e+=4},is_same_size:function(t){return this.bottom-this.top==t.bottom-t.top&&this.right-this.left==t.right-t.left?!0:!1}},SpiceClipRects.prototype={from_dv:function(t,e,i){var s;for(this.num_rects=t.getUint32(e,!0),e+=4,this.num_rects>0&&(this.rects=[]),s=0;s<this.num_rects;s++)this.rects[s]=new SpiceRect,e=this.rects[s].from_dv(t,e,i);return e}},SpiceClip.prototype={from_dv:function(t,e,i){return this.type=t.getUint8(e,!0),e++,this.type==SPICE_CLIP_TYPE_RECTS&&(this.rects=new SpiceClipRects,e=this.rects.from_dv(t,e,i)),e}},SpiceImageDescriptor.prototype={from_dv:function(t,e){return this.id=t.getUint64(e,!0),e+=8,this.type=t.getUint8(e,!0),e++,this.flags=t.getUint8(e,!0),e++,this.width=t.getUint32(e,!0),e+=4,this.height=t.getUint32(e,!0),e+=4}},SpicePalette.prototype={from_dv:function(t,e){var i;for(this.unique=t.getUint64(e,!0),e+=8,this.num_ents=t.getUint16(e,!0),e+=2,this.ents=[],i=0;i<this.num_ents;i++)this.ents[i]=t.getUint32(e,!0),e+=4;return e}},SpiceBitmap.prototype={from_dv:function(t,e,i){if(this.format=t.getUint8(e,!0),e++,this.flags=t.getUint8(e,!0),e++,this.x=t.getUint32(e,!0),e+=4,this.y=t.getUint32(e,!0),e+=4,this.stride=t.getUint32(e,!0),e+=4,this.flags&SPICE_BITMAP_FLAGS_PAL_FROM_CACHE)this.palette_id=t.getUint64(e,!0),e+=8;else{var s=t.getUint32(e,!0);e+=4,0==s?this.palette=null:(this.palette=new SpicePalette,this.palette.from_dv(t,s,i))}return this.data=i.slice(e),e+=this.data.byteLength}},SpiceImage.prototype={from_dv:function(t,e,i){if(this.descriptor=new SpiceImageDescriptor,e=this.descriptor.from_dv(t,e,i),this.descriptor.type==SPICE_IMAGE_TYPE_LZ_RGB){this.lz_rgb=new Object,this.lz_rgb.length=t.getUint32(e,!0),e+=4;var s=e;this.lz_rgb.magic="";for(var r=3;r>=0;r--)this.lz_rgb.magic+=String.fromCharCode(t.getUint8(e+r));e+=4,this.lz_rgb.version=t.getUint32(e),e+=4,this.lz_rgb.type=t.getUint32(e),e+=4,this.lz_rgb.width=t.getUint32(e),e+=4,this.lz_rgb.height=t.getUint32(e),e+=4,this.lz_rgb.stride=t.getUint32(e),e+=4,this.lz_rgb.top_down=t.getUint32(e),e+=4;var n=e-s;this.lz_rgb.data=i.slice(e,this.lz_rgb.length+e-n),e+=this.lz_rgb.data.byteLength}if(this.descriptor.type==SPICE_IMAGE_TYPE_BITMAP&&(this.bitmap=new SpiceBitmap,e=this.bitmap.from_dv(t,e,i)),this.descriptor.type==SPICE_IMAGE_TYPE_SURFACE&&(this.surface_id=t.getUint32(e,!0),e+=4),this.descriptor.type==SPICE_IMAGE_TYPE_JPEG&&(this.jpeg=new Object,this.jpeg.data_size=t.getUint32(e,!0),e+=4,this.jpeg.data=i.slice(e),e+=this.jpeg.data.byteLength),this.descriptor.type==SPICE_IMAGE_TYPE_JPEG_ALPHA){this.jpeg_alpha=new Object,this.jpeg_alpha.flags=t.getUint8(e,!0),e+=1,this.jpeg_alpha.jpeg_size=t.getUint32(e,!0),e+=4,this.jpeg_alpha.data_size=t.getUint32(e,!0),e+=4,this.jpeg_alpha.data=i.slice(e,this.jpeg_alpha.jpeg_size+e),e+=this.jpeg_alpha.data.byteLength,this.jpeg_alpha.alpha=new Object,this.jpeg_alpha.alpha.length=this.jpeg_alpha.data_size-this.jpeg_alpha.jpeg_size;var s=e;this.jpeg_alpha.alpha.magic="";for(var r=3;r>=0;r--)this.jpeg_alpha.alpha.magic+=String.fromCharCode(t.getUint8(e+r));e+=4,this.jpeg_alpha.alpha.version=t.getUint32(e),e+=4,this.jpeg_alpha.alpha.type=t.getUint32(e),e+=4,this.jpeg_alpha.alpha.width=t.getUint32(e),e+=4,this.jpeg_alpha.alpha.height=t.getUint32(e),e+=4,this.jpeg_alpha.alpha.stride=t.getUint32(e),e+=4,this.jpeg_alpha.alpha.top_down=t.getUint32(e),e+=4;var n=e-s;this.jpeg_alpha.alpha.data=i.slice(e,this.jpeg_alpha.alpha.length+e-n),e+=this.jpeg_alpha.alpha.data.byteLength}return this.descriptor.type==SPICE_IMAGE_TYPE_QUIC&&(this.quic=new SpiceQuic,e=this.quic.from_dv(t,e,i)),e}},SpiceQMask.prototype={from_dv:function(t,e,i){this.flags=t.getUint8(e,!0),e++,this.pos=new SpicePoint,e=this.pos.from_dv(t,e,i);var s=t.getUint32(e,!0);return e+=4,0==s?(this.bitmap=null,e):(this.bitmap=new SpiceImage,this.bitmap.from_dv(t,s,i))}},SpicePattern.prototype={from_dv:function(t,e,i){var s=t.getUint32(e,!0);return e+=4,0==s?this.pat=null:(this.pat=new SpiceImage,this.pat.from_dv(t,s,i)),this.pos=new SpicePoint,this.pos.from_dv(t,e,i)}},SpiceBrush.prototype={from_dv:function(t,e,i){return this.type=t.getUint8(e,!0),e++,this.type==SPICE_BRUSH_TYPE_SOLID?(this.color=t.getUint32(e,!0),e+=4):this.type==SPICE_BRUSH_TYPE_PATTERN&&(this.pattern=new SpicePattern,e=this.pattern.from_dv(t,e,i)),e}},SpiceFill.prototype={from_dv:function(t,e,i){return this.brush=new SpiceBrush,e=this.brush.from_dv(t,e,i),this.rop_descriptor=t.getUint16(e,!0),e+=2,this.mask=new SpiceQMask,this.mask.from_dv(t,e,i)}},SpiceCopy.prototype={from_dv:function(t,e,i){var s=t.getUint32(e,!0);return e+=4,0==s?this.src_bitmap=null:(this.src_bitmap=new SpiceImage,this.src_bitmap.from_dv(t,s,i)),this.src_area=new SpiceRect,e=this.src_area.from_dv(t,e,i),this.rop_descriptor=t.getUint16(e,!0),e+=2,this.scale_mode=t.getUint8(e,!0),e++,this.mask=new SpiceQMask,this.mask.from_dv(t,e,i)}},SpicePoint16.prototype={from_dv:function(t,e){return this.x=t.getUint16(e,!0),e+=2,this.y=t.getUint16(e,!0),e+=2}},SpicePoint.prototype={from_dv:function(t,e){return this.x=t.getUint32(e,!0),e+=4,this.y=t.getUint32(e,!0),e+=4}},SpiceCursorHeader.prototype={from_dv:function(t,e){return this.unique=t.getUint64(e,!0),e+=8,this.type=t.getUint8(e,!0),e++,this.width=t.getUint16(e,!0),e+=2,this.height=t.getUint16(e,!0),e+=2,this.hot_spot_x=t.getUint16(e,!0),e+=2,this.hot_spot_y=t.getUint16(e,!0),e+=2}},SpiceCursor.prototype={from_dv:function(t,e,i){return this.flags=t.getUint16(e,!0),e+=2,this.flags&SPICE_CURSOR_FLAGS_NONE?this.header=null:(this.header=new SpiceCursorHeader,e=this.header.from_dv(t,e,i),this.data=i.slice(e),e+=this.data.byteLength),e}},SpiceSurface.prototype={from_dv:function(t,e){return this.surface_id=t.getUint32(e,!0),e+=4,this.width=t.getUint32(e,!0),e+=4,this.height=t.getUint32(e,!0),e+=4,this.format=t.getUint32(e,!0),e+=4,this.flags=t.getUint32(e,!0),e+=4}},define("spice-spicetype",function(){}),SpiceLinkHeader.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.magic="";for(var s=0;4>s;s++)this.magic+=String.fromCharCode(i.getUint8(e+s));e+=4,this.major_version=i.getUint32(e,!0),e+=4,this.minor_version=i.getUint32(e,!0),e+=4,this.size=i.getUint32(e,!0),e+=4},to_buffer:function(t,e){e=e||0;for(var i=new SpiceDataView(t),s=0;4>s;s++)i.setUint8(e+s,this.magic.charCodeAt(s));e+=4,i.setUint32(e,this.major_version,!0),e+=4,i.setUint32(e,this.minor_version,!0),e+=4,i.setUint32(e,this.size,!0),e+=4},buffer_size:function(){return 16}},SpiceLinkMess.prototype={from_buffer:function(t,e){e=e||0;var i,s=e,r=new SpiceDataView(t);this.connection_id=r.getUint32(e,!0),e+=4,this.channel_type=r.getUint8(e,!0),e++,this.channel_id=r.getUint8(e,!0),e++;var n=r.getUint32(e,!0);e+=4;var a=r.getUint32(e,!0);e+=4;var _=r.getUint32(e,!0);for(e+=4,e=s+_,this.common_caps=[],i=0;n>i;i++)this.common_caps.unshift(r.getUint32(e,!0)),e+=4;for(this.channel_caps=[],i=0;a>i;i++)this.channel_caps.unshift(r.getUint32(e,!0)),e+=4},to_buffer:function(t,e){e=e||0;var i,s=e,r=new SpiceDataView(t);for(r.setUint32(e,this.connection_id,!0),e+=4,r.setUint8(e,this.channel_type,!0),e++,r.setUint8(e,this.channel_id,!0),e++,r.setUint32(e,this.common_caps.length,!0),e+=4,r.setUint32(e,this.channel_caps.length,!0),e+=4,r.setUint32(e,e-s+4,!0),e+=4,i=0;i<this.common_caps.length;i++)r.setUint32(e,this.common_caps[i],!0),e+=4;for(i=0;i<this.channel_caps.length;i++)r.setUint32(e,this.channel_caps[i],!0),e+=4},buffer_size:function(){return 18+4*this.common_caps.length+4*this.channel_caps.length}},SpiceLinkReply.prototype={from_buffer:function(t,e){e=e||0;var i,s=e,r=new SpiceDataView(t);this.error=r.getUint32(e,!0),e+=4,this.pub_key=create_rsa_from_mb(t,e),e+=SPICE_TICKET_PUBKEY_BYTES;var n=r.getUint32(e,!0);e+=4;var a=r.getUint32(e,!0);e+=4;var _=r.getUint32(e,!0);for(e+=4,e=s+_,this.common_caps=[],i=0;n>i;i++)this.common_caps.unshift(r.getUint32(e,!0)),e+=4;for(this.channel_caps=[],i=0;a>i;i++)this.channel_caps.unshift(r.getUint32(e,!0)),e+=4}},SpiceLinkAuthTicket.prototype={to_buffer:function(t,e){e=e||0;var i,s=new SpiceDataView(t);for(s.setUint32(e,this.auth_mechanism,!0),e+=4,i=0;SPICE_TICKET_KEY_PAIR_LENGTH/8>i;i++)this.encrypted_data&&i<this.encrypted_data.length?s.setUint8(e,this.encrypted_data[i],!0):s.setUint8(e,0,!0),e++
},buffer_size:function(){return 4+SPICE_TICKET_KEY_PAIR_LENGTH/8}},SpiceLinkAuthReply.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.auth_code=i.getUint32(e,!0),e+=4},buffer_size:function(){return 4}},SpiceMiniData.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.type=i.getUint16(e,!0),e+=2,this.size=i.getUint32(e,!0),e+=4,t.byteLength>e&&(this.data=t.slice(e),e+=this.data.byteLength)},to_buffer:function(t,e){e=e||0;var i,s=new SpiceDataView(t);if(s.setUint16(e,this.type,!0),e+=2,s.setUint32(e,this.data?this.data.byteLength:0,!0),e+=4,this.data&&this.data.byteLength>0){var r=new Uint8Array(this.data);for(i=0;i<r.length;i++,e++)s.setUint8(e,r[i],!0)}},build_msg:function(t,e){this.type=t,this.size=e.buffer_size(),this.data=new ArrayBuffer(this.size),e.to_buffer(this.data)},buffer_size:function(){return this.data?6+this.data.byteLength:6}},SpiceMsgChannels.prototype={from_buffer:function(t,e){e=e||0;var i,s=new SpiceDataView(t);for(this.num_of_channels=s.getUint32(e,!0),e+=4,i=0;i<this.num_of_channels;i++){var r=new SpiceChannelId;e=r.from_dv(s,e,t),this.channels.push(r)}}},SpiceMsgMainInit.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.session_id=i.getUint32(e,!0),e+=4,this.display_channels_hint=i.getUint32(e,!0),e+=4,this.supported_mouse_modes=i.getUint32(e,!0),e+=4,this.current_mouse_mode=i.getUint32(e,!0),e+=4,this.agent_connected=i.getUint32(e,!0),e+=4,this.agent_tokens=i.getUint32(e,!0),e+=4,this.multi_media_time=i.getUint32(e,!0),e+=4,this.ram_hint=i.getUint32(e,!0),e+=4}},SpiceMsgMainMouseMode.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.supported_modes=i.getUint16(e,!0),e+=2,this.current_mode=i.getUint16(e,!0),e+=2}},SpiceMsgMainAgentData.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.protocol=i.getUint32(e,!0),e+=4,this.type=i.getUint32(e,!0),e+=4,this.opaque=i.getUint64(e,!0),e+=8,this.size=i.getUint32(e,!0),e+=4,t.byteLength>e&&(this.data=t.slice(e),e+=this.data.byteLength)}},SpiceMsgMainAgentTokens.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.num_tokens=i.getUint32(e,!0),e+=4}},SpiceMsgSetAck.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.generation=i.getUint32(e,!0),e+=4,this.window=i.getUint32(e,!0),e+=4}},SpiceMsgcAckSync.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);i.setUint32(e,this.generation,!0),e+=4},buffer_size:function(){return 4}},SpiceMsgcMainMouseModeRequest.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);i.setUint16(e,this.mode,!0),e+=2},buffer_size:function(){return 2}},SpiceMsgcMainAgentStart.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);i.setUint32(e,this.num_tokens,!0),e+=4},buffer_size:function(){return 4}},SpiceMsgcMainAgentData.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);i.setUint32(e,this.protocol,!0),e+=4,i.setUint32(e,this.type,!0),e+=4,i.setUint64(e,this.opaque,!0),e+=8,i.setUint32(e,this.size,!0),e+=4,this.data.to_buffer(t,e)},buffer_size:function(){return 20+this.data.buffer_size()}},VDAgentAnnounceCapabilities.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);i.setUint32(e,this.request,!0),e+=4,i.setUint32(e,this.caps,!0),e+=4},from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.request=i.getUint32(e,!0),e+=4,this.caps=i.getUint32(e,!0),e+=4},buffer_size:function(){return 8}},VDAgentMonitorsConfig.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);i.setUint32(e,this.num_mon,!0),e+=4,i.setUint32(e,this.flags,!0),e+=4,i.setUint32(e,this.height,!0),e+=4,i.setUint32(e,this.width,!0),e+=4,i.setUint32(e,this.depth,!0),e+=4,i.setUint32(e,this.x,!0),e+=4,i.setUint32(e,this.y,!0),e+=4},buffer_size:function(){return 28}},VDAgentFileXferStatusMessage.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);i.setUint32(e,this.id,!0),e+=4,i.setUint32(e,this.result,!0),e+=4},from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.id=i.getUint32(e,!0),e+=4,this.result=i.getUint32(e,!0),e+=4},buffer_size:function(){return 8}},VDAgentFileXferStartMessage.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);i.setUint32(e,this.id,!0),e+=4;for(var s=0;s<this.string.length;s++,e++)i.setUint8(e,this.string.charCodeAt(s))},buffer_size:function(){return 4+this.string.length+1}},VDAgentFileXferDataMessage.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);if(i.setUint32(e,this.id,!0),e+=4,i.setUint64(e,this.size,!0),e+=8,this.data&&this.data.byteLength>0)for(var s=new Uint8Array(this.data),r=0;r<s.length;r++,e++)i.setUint8(e,s[r])},buffer_size:function(){return 12+this.size}},SpiceMsgNotify.prototype={from_buffer:function(t,e){e=e||0;var i,s=new SpiceDataView(t);for(this.time_stamp=s.getUint64(e,!0),e+=8,this.severity=s.getUint32(e,!0),e+=4,this.visibility=s.getUint32(e,!0),e+=4,this.what=s.getUint32(e,!0),e+=4,this.message_len=s.getUint32(e,!0),e+=4,this.message="",i=0;i<this.message_len;i++){var r=s.getUint8(e,!0);e++,this.message+=String.fromCharCode(r)}}},SpiceMsgcDisplayInit.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);i.setUint8(e,this.pixmap_cache_id,!0),e++,i.setUint64(e,this.pixmap_cache_size,!0),e+=8,i.setUint8(e,this.glz_dictionary_id,!0),e++,i.setUint32(e,this.glz_dictionary_window_size,!0),e+=4},buffer_size:function(){return 14}},SpiceMsgDisplayBase.prototype={from_dv:function(t,e,i){return this.surface_id=t.getUint32(e,!0),e+=4,this.box=new SpiceRect,e=this.box.from_dv(t,e,i),this.clip=new SpiceClip,this.clip.from_dv(t,e,i)}},SpiceMsgDisplayDrawCopy.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.base=new SpiceMsgDisplayBase,e=this.base.from_dv(i,e,t),this.data=new SpiceCopy,this.data.from_dv(i,e,t)}},SpiceMsgDisplayDrawFill.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.base=new SpiceMsgDisplayBase,e=this.base.from_dv(i,e,t),this.data=new SpiceFill,this.data.from_dv(i,e,t)}},SpiceMsgDisplayCopyBits.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.base=new SpiceMsgDisplayBase,e=this.base.from_dv(i,e,t),this.src_pos=new SpicePoint,this.src_pos.from_dv(i,e,t)}},SpiceMsgSurfaceCreate.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.surface=new SpiceSurface,this.surface.from_dv(i,e,t)}},SpiceMsgSurfaceDestroy.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.surface_id=i.getUint32(e,!0),e+=4}},SpiceMsgInputsInit.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.keyboard_modifiers=i.getUint16(e,!0),e+=2}},SpiceMsgInputsKeyModifiers.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.keyboard_modifiers=i.getUint16(e,!0),e+=2}},SpiceMsgCursorInit.prototype={from_buffer:function(t,e,i){e=e||0;var s=new SpiceDataView(t);return this.position=new SpicePoint16,e=this.position.from_dv(s,e,i),this.trail_length=s.getUint16(e,!0),e+=2,this.trail_frequency=s.getUint16(e,!0),e+=2,this.visible=s.getUint8(e,!0),e++,this.cursor=new SpiceCursor,this.cursor.from_dv(s,e,t)}},SpiceMsgPlaybackData.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.time=i.getUint32(e,!0),e+=4,t.byteLength>e&&(this.data=t.slice(e),e+=this.data.byteLength),e}},SpiceMsgPlaybackMode.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.time=i.getUint32(e,!0),e+=4,this.mode=i.getUint16(e,!0),e+=2,t.byteLength>e&&(this.data=t.slice(e),e+=this.data.byteLength),e}},SpiceMsgPlaybackStart.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return this.channels=i.getUint32(e,!0),e+=4,this.format=i.getUint16(e,!0),e+=2,this.frequency=i.getUint32(e,!0),e+=4,this.time=i.getUint32(e,!0),e+=4}},SpiceMsgCursorSet.prototype={from_buffer:function(t,e,i){e=e||0;var s=new SpiceDataView(t);return this.position=new SpicePoint16,e=this.position.from_dv(s,e,i),this.visible=s.getUint8(e,!0),e++,this.cursor=new SpiceCursor,this.cursor.from_dv(s,e,t)}},SpiceMsgcMousePosition.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return i.setUint32(e,this.x,!0),e+=4,i.setUint32(e,this.y,!0),e+=4,i.setUint16(e,this.buttons_state,!0),e+=2,i.setUint8(e,this.display_id,!0),e+=1},buffer_size:function(){return 11}},SpiceMsgcMouseMotion.prototype.to_buffer=SpiceMsgcMousePosition.prototype.to_buffer,SpiceMsgcMouseMotion.prototype.buffer_size=SpiceMsgcMousePosition.prototype.buffer_size,SpiceMsgcMousePress.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return i.setUint8(e,this.button,!0),e++,i.setUint16(e,this.buttons_state,!0),e+=2},buffer_size:function(){return 3}},SpiceMsgcMouseRelease.prototype.to_buffer=SpiceMsgcMousePress.prototype.to_buffer,SpiceMsgcMouseRelease.prototype.buffer_size=SpiceMsgcMousePress.prototype.buffer_size,SpiceMsgcKeyDown.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return i.setUint32(e,this.code,!0),e+=4},buffer_size:function(){return 4}},SpiceMsgcKeyUp.prototype.to_buffer=SpiceMsgcKeyDown.prototype.to_buffer,SpiceMsgcKeyUp.prototype.buffer_size=SpiceMsgcKeyDown.prototype.buffer_size,SpiceMsgDisplayStreamCreate.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.surface_id=i.getUint32(e,!0),e+=4,this.id=i.getUint32(e,!0),e+=4,this.flags=i.getUint8(e,!0),e+=1,this.codec_type=i.getUint8(e,!0),e+=1,this.stamp=i.getUint64(e,!0),e+=8,this.stream_width=i.getUint32(e,!0),e+=4,this.stream_height=i.getUint32(e,!0),e+=4,this.src_width=i.getUint32(e,!0),e+=4,this.src_height=i.getUint32(e,!0),e+=4,this.dest=new SpiceRect,e=this.dest.from_dv(i,e,t),this.clip=new SpiceClip,this.clip.from_dv(i,e,t)}},SpiceStreamDataHeader.prototype={from_dv:function(t,e){return this.id=t.getUint32(e,!0),e+=4,this.multi_media_time=t.getUint32(e,!0),e+=4}},SpiceMsgDisplayStreamData.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.base=new SpiceStreamDataHeader,e=this.base.from_dv(i,e,t),this.data_size=i.getUint32(e,!0),e+=4,this.data=i.u8.subarray(e,e+this.data_size)}},SpiceMsgDisplayStreamClip.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.id=i.getUint32(e,!0),e+=4,this.clip=new SpiceClip,this.clip.from_dv(i,e,t)}},SpiceMsgDisplayStreamDestroy.prototype={from_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);this.id=i.getUint32(e,!0),e+=4}},SpiceMsgDisplayInvalList.prototype={from_buffer:function(t,e){var i;e=e||0;var s=new SpiceDataView(t);for(this.count=s.getUint16(e,!0),e+=2,i=0;i<this.count;i++)this.resources[i]={},this.resources[i].type=s.getUint8(e,!0),e++,this.resources[i].id=s.getUint64(e,!0),e+=8}},define("spice-spicemsg",function(){}),SpiceWireReader.prototype={inbound:function(t){if(0==this.needed)return void this.buffers.push(t);for(0==this.buffers.length&&t.byteLength>=this.needed?(t.byteLength>this.needed&&(this.buffers.push(t.slice(this.needed)),t=t.slice(0,this.needed)),this.callback.call(this.sc,t,this.saved_msg_header||void 0)):this.buffers.push(t);this.buffers.length>1&&this.buffers[0].byteLength<this.needed;){var e=this.buffers.shift(),i=this.buffers.shift();this.buffers.unshift(combine_array_buffers(e,i))}for(;this.buffers.length>0&&this.buffers[0].byteLength>=this.needed;)t=this.buffers.shift(),t.byteLength>this.needed&&(this.buffers.unshift(t.slice(this.needed)),t=t.slice(0,this.needed)),this.callback.call(this.sc,t,this.saved_msg_header||void 0)},request:function(t){this.needed=t},save_header:function(t){this.saved_msg_header=t},clear_header:function(){this.saved_msg_header=void 0}},define("spice-wire",function(){}),SpiceDisplayConn.prototype=Object.create(SpiceConn.prototype),SpiceDisplayConn.prototype.process_channel_message=function(t){if(t.type==SPICE_MSG_DISPLAY_MARK)return this.known_unimplemented(t.type,"Display Mark"),!0;if(t.type==SPICE_MSG_DISPLAY_RESET)return DEBUG>2&&console.log("Display reset"),this.surfaces[this.primary_surface].canvas.context.restore(),!0;if(t.type==SPICE_MSG_DISPLAY_DRAW_COPY){var e=new SpiceMsgDisplayDrawCopy(t.data);if(DEBUG>1&&this.log_draw("DrawCopy",e),e.base.box.is_same_size(e.data.src_area)||this.log_warn("FIXME: DrawCopy src_area is a different size than base.box; we do not handle that yet."),e.base.clip.type!=SPICE_CLIP_TYPE_NONE&&this.log_warn("FIXME: DrawCopy we don't handle clipping yet"),e.data.rop_descriptor!=SPICE_ROPD_OP_PUT&&this.log_warn("FIXME: DrawCopy we don't handle ropd type: "+e.data.rop_descriptor),e.data.mask.flags&&this.log_warn("FIXME: DrawCopy we don't handle mask flag: "+e.data.mask.flags),e.data.mask.bitmap&&this.log_warn("FIXME: DrawCopy we don't handle mask"),e.data&&e.data.src_bitmap){if(e.data.src_bitmap.descriptor.flags&&e.data.src_bitmap.descriptor.flags!=SPICE_IMAGE_FLAGS_CACHE_ME&&e.data.src_bitmap.descriptor.flags!=SPICE_IMAGE_FLAGS_HIGH_BITS_SET&&(this.log_warn("FIXME: DrawCopy unhandled image flags: "+e.data.src_bitmap.descriptor.flags),1>=DEBUG&&this.log_draw("DrawCopy",e)),e.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_QUIC){var i=this.surfaces[e.base.surface_id].canvas;if(!e.data.src_bitmap.quic)return this.log_warn("FIXME: DrawCopy could not handle this QUIC file."),!1;var s=convert_spice_quic_to_web(i.context,e.data.src_bitmap.quic);return this.draw_copy_helper({base:e.base,src_area:e.data.src_area,image_data:s,tag:"copyquic."+e.data.src_bitmap.quic.type,has_alpha:e.data.src_bitmap.quic.type==QUIC_IMAGE_TYPE_RGBA?!0:!1,descriptor:e.data.src_bitmap.descriptor})}if(e.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE||e.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_FROM_CACHE_LOSSLESS)return this.cache&&this.cache[e.data.src_bitmap.descriptor.id]?this.draw_copy_helper({base:e.base,src_area:e.data.src_area,image_data:this.cache[e.data.src_bitmap.descriptor.id],tag:"copycache."+e.data.src_bitmap.descriptor.id,has_alpha:!0,descriptor:e.data.src_bitmap.descriptor}):(this.log_warn("FIXME: DrawCopy did not find image id "+e.data.src_bitmap.descriptor.id+" in cache."),!1);if(e.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_SURFACE){var r=this.surfaces[e.data.src_bitmap.surface_id].canvas.context,s=(this.surfaces[e.base.surface_id].canvas.context,r.getImageData(e.data.src_area.left,e.data.src_area.top,e.data.src_area.right-e.data.src_area.left,e.data.src_area.bottom-e.data.src_area.top)),n=new SpiceRect;return n.top=n.left=0,n.right=s.width,n.bottom=s.height,this.draw_copy_helper({base:e.base,src_area:n,image_data:s,tag:"copysurf."+e.data.src_bitmap.surface_id,has_alpha:this.surfaces[e.data.src_bitmap.surface_id].format==SPICE_SURFACE_FMT_32_xRGB?!1:!0,descriptor:e.data.src_bitmap.descriptor})}if(e.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_JPEG){if(!e.data.src_bitmap.jpeg)return this.log_warn("FIXME: DrawCopy could not handle this JPEG file."),!1;var a,_="data:image/jpeg,",o=new Image,c=new Uint8Array(e.data.src_bitmap.jpeg.data);for(a=0;a<c.length;a++)_+="%",c[a]<16&&(_+="0"),_+=c[a].toString(16);return o.o={base:e.base,tag:"jpeg."+e.data.src_bitmap.surface_id,descriptor:e.data.src_bitmap.descriptor,sc:this},o.onload=handle_draw_jpeg_onload,o.src=_,!0}if(e.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_JPEG_ALPHA){if(!e.data.src_bitmap.jpeg_alpha)return this.log_warn("FIXME: DrawCopy could not handle this JPEG ALPHA file."),!1;var a,_="data:image/jpeg,",o=new Image,c=new Uint8Array(e.data.src_bitmap.jpeg_alpha.data);for(a=0;a<c.length;a++)_+="%",c[a]<16&&(_+="0"),_+=c[a].toString(16);if(o.o={base:e.base,tag:"jpeg."+e.data.src_bitmap.surface_id,descriptor:e.data.src_bitmap.descriptor,sc:this},this.surfaces[e.base.surface_id].format==SPICE_SURFACE_FMT_32_ARGB){var i=this.surfaces[e.base.surface_id].canvas;o.alpha_img=convert_spice_lz_to_web(i.context,e.data.src_bitmap.jpeg_alpha.alpha)}return o.onload=handle_draw_jpeg_onload,o.src=_,!0}if(e.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_BITMAP){var i=this.surfaces[e.base.surface_id].canvas;if(!e.data.src_bitmap.bitmap)return this.log_err("null bitmap"),!1;var s=convert_spice_bitmap_to_web(i.context,e.data.src_bitmap.bitmap);return s?this.draw_copy_helper({base:e.base,src_area:e.data.src_area,image_data:s,tag:"bitmap."+e.data.src_bitmap.bitmap.format,has_alpha:e.data.src_bitmap.bitmap==SPICE_BITMAP_FMT_32BIT?!1:!0,descriptor:e.data.src_bitmap.descriptor}):(this.log_warn("FIXME: Unable to interpret bitmap of format: "+e.data.src_bitmap.bitmap.format),!1)}if(e.data.src_bitmap.descriptor.type==SPICE_IMAGE_TYPE_LZ_RGB){var i=this.surfaces[e.base.surface_id].canvas;if(!e.data.src_bitmap.lz_rgb)return this.log_err("null lz_rgb "),!1;1!=e.data.src_bitmap.lz_rgb.top_down&&this.log_warn("FIXME: Implement non top down support for lz_rgb");var s=convert_spice_lz_to_web(i.context,e.data.src_bitmap.lz_rgb);return s?this.draw_copy_helper({base:e.base,src_area:e.data.src_area,image_data:s,tag:"lz_rgb."+e.data.src_bitmap.lz_rgb.type,has_alpha:e.data.src_bitmap.lz_rgb.type==LZ_IMAGE_TYPE_RGBA?!0:!1,descriptor:e.data.src_bitmap.descriptor}):(this.log_warn("FIXME: Unable to interpret bitmap of type: "+e.data.src_bitmap.lz_rgb.type),!1)}return this.log_warn("FIXME: DrawCopy unhandled image type: "+e.data.src_bitmap.descriptor.type),this.log_draw("DrawCopy",e),!1}return this.log_warn("FIXME: DrawCopy no src_bitmap."),!1}if(t.type==SPICE_MSG_DISPLAY_DRAW_FILL){var h=new SpiceMsgDisplayDrawFill(t.data);if(DEBUG>1&&this.log_draw("DrawFill",h),h.data.rop_descriptor!=SPICE_ROPD_OP_PUT&&this.log_warn("FIXME: DrawFill we don't handle ropd type: "+h.data.rop_descriptor),h.data.mask.flags&&this.log_warn("FIXME: DrawFill we don't handle mask flag: "+h.data.mask.flags),h.data.mask.bitmap&&this.log_warn("FIXME: DrawFill we don't handle mask"),h.data.brush.type==SPICE_BRUSH_TYPE_SOLID){var p=16777215&h.data.brush.color,u="rgb("+(p>>16)+", "+(p>>8&255)+", "+(255&p)+")";if(this.surfaces[h.base.surface_id].canvas.context.fillStyle=u,this.surfaces[h.base.surface_id].canvas.context.fillRect(h.base.box.left,h.base.box.top,h.base.box.right-h.base.box.left,h.base.box.bottom-h.base.box.top),DUMP_DRAWS&&this.parent.dump_id){var d=document.createElement("canvas");d.setAttribute("width",this.surfaces[h.base.surface_id].canvas.width),d.setAttribute("height",this.surfaces[h.base.surface_id].canvas.height),d.setAttribute("id","fillbrush."+h.base.surface_id+"."+this.surfaces[h.base.surface_id].draw_count),d.getContext("2d").fillStyle=u,d.getContext("2d").fillRect(h.base.box.left,h.base.box.top,h.base.box.right-h.base.box.left,h.base.box.bottom-h.base.box.top),document.getElementById(this.parent.dump_id).appendChild(d)}this.surfaces[h.base.surface_id].draw_count++}else this.log_warn("FIXME: DrawFill can't handle brush type: "+h.data.brush.type);return!0}if(t.type==SPICE_MSG_DISPLAY_COPY_BITS){var f=new SpiceMsgDisplayCopyBits(t.data);DEBUG>1&&this.log_draw("CopyBits",f);var l=this.surfaces[f.base.surface_id].canvas,r=l.context,E=l.width-f.src_pos.x,m=l.height-f.src_pos.y;E>f.base.box.right-f.base.box.left&&(E=f.base.box.right-f.base.box.left),m>f.base.box.bottom-f.base.box.top&&(m=f.base.box.bottom-f.base.box.top);var s=r.getImageData(f.src_pos.x,f.src_pos.y,E,m);if(putImageDataWithAlpha(r,s,f.base.box.left,f.base.box.top),DUMP_DRAWS&&this.parent.dump_id){var d=document.createElement("canvas");d.setAttribute("width",E),d.setAttribute("height",m),d.setAttribute("id","copybits"+f.base.surface_id+"."+this.surfaces[f.base.surface_id].draw_count),d.getContext("2d").putImageData(s,0,0),document.getElementById(this.parent.dump_id).appendChild(d)}return this.surfaces[f.base.surface_id].draw_count++,!0}if(t.type==SPICE_MSG_DISPLAY_INVAL_ALL_PALETTES)return this.known_unimplemented(t.type,"Inval All Palettes"),!0;if(t.type==SPICE_MSG_DISPLAY_SURFACE_CREATE){"surfaces"in this||(this.surfaces=[]);var g=new SpiceMsgSurfaceCreate(t.data);if(DEBUG>1&&console.log(this.type+": MsgSurfaceCreate id "+g.surface.surface_id+"; "+g.surface.width+"x"+g.surface.height+"; format "+g.surface.format+"; flags "+g.surface.flags),g.surface.format!=SPICE_SURFACE_FMT_32_xRGB&&g.surface.format!=SPICE_SURFACE_FMT_32_ARGB)return this.log_warn("FIXME: cannot handle surface format "+g.surface.format+" yet."),!1;var i=document.createElement("canvas");return i.setAttribute("width",g.surface.width),i.setAttribute("height",g.surface.height),i.setAttribute("id","spice_surface_"+g.surface.surface_id),i.setAttribute("tabindex",g.surface.surface_id),i.context=i.getContext("2d"),DUMP_CANVASES&&this.parent.dump_id&&document.getElementById(this.parent.dump_id).appendChild(i),g.surface.canvas=i,g.surface.draw_count=0,this.surfaces[g.surface.surface_id]=g.surface,g.surface.flags&SPICE_SURFACE_FLAGS_PRIMARY&&(this.primary_surface=g.surface.surface_id,i.context.save(),document.getElementById(this.parent.screen_id).appendChild(i),document.getElementById(this.parent.screen_id).style.height=g.surface.height+"px",this.hook_events()),!0}if(t.type==SPICE_MSG_DISPLAY_SURFACE_DESTROY){var g=new SpiceMsgSurfaceDestroy(t.data);return DEBUG>1&&console.log(this.type+": MsgSurfaceDestroy id "+g.surface_id),this.delete_surface(g.surface_id),!0}if(t.type==SPICE_MSG_DISPLAY_STREAM_CREATE){var g=new SpiceMsgDisplayStreamCreate(t.data);return DEBUG>1&&console.log(this.type+": MsgStreamCreate id"+g.id),this.streams||(this.streams=new Array),this.streams[g.id]?console.log("Stream already exists"):this.streams[g.id]=g,g.codec_type!=SPICE_VIDEO_CODEC_TYPE_MJPEG&&console.log("Unhandled stream codec: "+g.codec_type),!0}if(t.type==SPICE_MSG_DISPLAY_STREAM_DATA){var g=new SpiceMsgDisplayStreamData(t.data);if(!this.streams[g.base.id])return console.log("no stream for data"),!1;if(this.streams[g.base.id].codec_type===SPICE_VIDEO_CODEC_TYPE_MJPEG){var a,_="data:image/jpeg,",o=new Image;for(a=0;a<g.data.length;a++)_+="%",g.data[a]<16&&(_+="0"),_+=g.data[a].toString(16);var S=new SpiceMsgDisplayBase;S.surface_id=this.streams[g.base.id].surface_id,S.box=this.streams[g.base.id].dest,S.clip=this.streams[g.base.id].clip,o.o={base:S,tag:"mjpeg."+g.base.id,descriptor:null,sc:this},o.onload=handle_draw_jpeg_onload,o.src=_}return!0}if(t.type==SPICE_MSG_DISPLAY_STREAM_CLIP){var g=new SpiceMsgDisplayStreamClip(t.data);return DEBUG>1&&console.log(this.type+": MsgStreamClip id"+g.id),this.streams[g.id].clip=g.clip,!0}if(t.type==SPICE_MSG_DISPLAY_STREAM_DESTROY){var g=new SpiceMsgDisplayStreamDestroy(t.data);return DEBUG>1&&console.log(this.type+": MsgStreamDestroy id"+g.id),this.streams[g.id]=void 0,!0}if(t.type==SPICE_MSG_DISPLAY_INVAL_LIST){var a,g=new SpiceMsgDisplayInvalList(t.data);for(DEBUG>1&&console.log(this.type+": MsgInvalList "+g.count+" items"),a=0;a<g.count;a++)void 0!=this.cache[g.resources[a].id]&&delete this.cache[g.resources[a].id];return!0}return!1},SpiceDisplayConn.prototype.delete_surface=function(t){var e=document.getElementById("spice_surface_"+t);DUMP_CANVASES&&this.parent.dump_id&&document.getElementById(this.parent.dump_id).removeChild(e),this.primary_surface==t&&(this.unhook_events(),this.primary_surface=void 0,document.getElementById(this.parent.screen_id).removeChild(e)),delete this.surfaces[t]},SpiceDisplayConn.prototype.draw_copy_helper=function(t){var e=this.surfaces[t.base.surface_id].canvas;if(t.has_alpha?this.surfaces[t.base.surface_id].format==SPICE_SURFACE_FMT_32_xRGB?(stripAlpha(t.image_data),e.context.putImageData(t.image_data,t.base.box.left,t.base.box.top)):putImageDataWithAlpha(e.context,t.image_data,t.base.box.left,t.base.box.top):e.context.putImageData(t.image_data,t.base.box.left,t.base.box.top),(t.src_area.left>0||t.src_area.top>0)&&this.log_warn("FIXME: DrawCopy not shifting draw copies just yet..."),t.descriptor&&t.descriptor.flags&SPICE_IMAGE_FLAGS_CACHE_ME&&("cache"in this||(this.cache={}),this.cache[t.descriptor.id]=t.image_data),DUMP_DRAWS&&this.parent.dump_id){var i=document.createElement("canvas");i.setAttribute("width",t.image_data.width),i.setAttribute("height",t.image_data.height),i.setAttribute("id",t.tag+"."+this.surfaces[t.base.surface_id].draw_count+"."+t.base.surface_id+"@"+t.base.box.left+"x"+t.base.box.top),i.getContext("2d").putImageData(t.image_data,0,0),document.getElementById(this.parent.dump_id).appendChild(i)}return this.surfaces[t.base.surface_id].draw_count++,!0},SpiceDisplayConn.prototype.log_draw=function(t,e){var i=t+"."+e.base.surface_id+"."+this.surfaces[e.base.surface_id].draw_count+": ";i+="base.box "+e.base.box.left+", "+e.base.box.top+" to "+e.base.box.right+", "+e.base.box.bottom,i+="; clip.type "+e.base.clip.type,e.data&&(e.data.src_area&&(i+="; src_area "+e.data.src_area.left+", "+e.data.src_area.top+" to "+e.data.src_area.right+", "+e.data.src_area.bottom),e.data.src_bitmap&&null!=e.data.src_bitmap?(i+="; src_bitmap id: "+e.data.src_bitmap.descriptor.id,i+="; src_bitmap width "+e.data.src_bitmap.descriptor.width+", height "+e.data.src_bitmap.descriptor.height,i+="; src_bitmap type "+e.data.src_bitmap.descriptor.type+", flags "+e.data.src_bitmap.descriptor.flags,void 0!==e.data.src_bitmap.surface_id&&(i+="; src_bitmap surface_id "+e.data.src_bitmap.surface_id),e.data.src_bitmap.quic&&(i+="; QUIC type "+e.data.src_bitmap.quic.type+"; width "+e.data.src_bitmap.quic.width+"; height "+e.data.src_bitmap.quic.height),e.data.src_bitmap.lz_rgb&&(i+="; LZ_RGB length "+e.data.src_bitmap.lz_rgb.length+"; magic "+e.data.src_bitmap.lz_rgb.magic+"; version 0x"+e.data.src_bitmap.lz_rgb.version.toString(16)+"; type "+e.data.src_bitmap.lz_rgb.type+"; width "+e.data.src_bitmap.lz_rgb.width+"; height "+e.data.src_bitmap.lz_rgb.height+"; stride "+e.data.src_bitmap.lz_rgb.stride+"; top down "+e.data.src_bitmap.lz_rgb.top_down)):i+="; src_bitmap is null",e.data.brush&&(e.data.brush.type==SPICE_BRUSH_TYPE_SOLID&&(i+="; brush.color 0x"+e.data.brush.color.toString(16)),e.data.brush.type==SPICE_BRUSH_TYPE_PATTERN&&(i+="; brush.pat ",i+=null!=e.data.brush.pattern.pat?"[SpiceImage]":"[null]",i+=" at "+e.data.brush.pattern.pos.x+", "+e.data.brush.pattern.pos.y)),i+="; rop_descriptor "+e.data.rop_descriptor,void 0!==e.data.scale_mode&&(i+="; scale_mode "+e.data.scale_mode),i+="; mask.flags "+e.data.mask.flags,i+="; mask.pos "+e.data.mask.pos.x+", "+e.data.mask.pos.y,null!=e.data.mask.bitmap?(i+="; mask.bitmap width "+e.data.mask.bitmap.descriptor.width+", height "+e.data.mask.bitmap.descriptor.height,i+="; mask.bitmap type "+e.data.mask.bitmap.descriptor.type+", flags "+e.data.mask.bitmap.descriptor.flags):i+="; mask.bitmap is null"),console.log(i)},SpiceDisplayConn.prototype.hook_events=function(){if(void 0!==this.primary_surface){var t=this.surfaces[this.primary_surface].canvas;t.sc=this.parent,t.addEventListener("mousemove",handle_mousemove),t.addEventListener("mousedown",handle_mousedown),t.addEventListener("contextmenu",handle_contextmenu),t.addEventListener("mouseup",handle_mouseup),t.addEventListener("keydown",handle_keydown),t.addEventListener("keyup",handle_keyup),t.addEventListener("mouseout",handle_mouseout),t.addEventListener("mouseover",handle_mouseover),t.addEventListener("wheel",handle_mousewheel),t.focus()}},SpiceDisplayConn.prototype.unhook_events=function(){if(void 0!==this.primary_surface){var t=this.surfaces[this.primary_surface].canvas;t.removeEventListener("mousemove",handle_mousemove),t.removeEventListener("mousedown",handle_mousedown),t.removeEventListener("contextmenu",handle_contextmenu),t.removeEventListener("mouseup",handle_mouseup),t.removeEventListener("keydown",handle_keydown),t.removeEventListener("keyup",handle_keyup),t.removeEventListener("mouseout",handle_mouseout),t.removeEventListener("mouseover",handle_mouseover),t.removeEventListener("wheel",handle_mousewheel)}},SpiceDisplayConn.prototype.destroy_surfaces=function(){for(var t in this.surfaces)this.delete_surface(this.surfaces[t].surface_id);this.surfaces=void 0},define("spice-display",["spice-spiceconn"],function(){});var Shift_state=-1,Ctrl_state=-1,Alt_state=-1,Meta_state=-1;SpiceInputsConn.prototype=Object.create(SpiceConn.prototype),SpiceInputsConn.prototype.process_channel_message=function(t){if(t.type==SPICE_MSG_INPUTS_INIT){var e=new SpiceMsgInputsInit(t.data);return this.keyboard_modifiers=e.keyboard_modifiers,DEBUG>1&&console.log("MsgInputsInit - modifier "+this.keyboard_modifiers),!0}if(t.type==SPICE_MSG_INPUTS_KEY_MODIFIERS){var i=new SpiceMsgInputsKeyModifiers(t.data);return this.keyboard_modifiers=i.keyboard_modifiers,DEBUG>1&&console.log("MsgInputsKeyModifiers - modifier "+this.keyboard_modifiers),!0}return t.type==SPICE_MSG_INPUTS_MOUSE_MOTION_ACK?(DEBUG>1&&console.log("mouse motion ack"),this.waiting_for_ack-=SPICE_INPUT_MOTION_ACK_BUNCH,!0):!1},define("spice-inputs",["spice-spiceconn"],function(){});var EBML_HEADER=[26,69,223,163],EBML_HEADER_VERSION=[66,134],EBML_HEADER_READ_VERSION=[66,247],EBML_HEADER_MAX_ID_LENGTH=[66,242],EBML_HEADER_MAX_SIZE_LENGTH=[66,243],EBML_HEADER_DOC_TYPE=[66,130],EBML_HEADER_DOC_TYPE_VERSION=[66,135],EBML_HEADER_DOC_TYPE_READ_VERSION=[66,133],WEBM_SEGMENT_HEADER=[24,83,128,103],WEBM_SEGMENT_INFORMATION=[21,73,169,102],WEBM_TIMECODE_SCALE=[42,215,177],WEBM_MUXING_APP=[77,128],WEBM_WRITING_APP=[87,65],WEBM_SEEK_HEAD=[17,77,155,116],WEBM_SEEK=[77,187],WEBM_SEEK_ID=[83,171],WEBM_SEEK_POSITION=[83,172],WEBM_TRACKS=[22,84,174,107],WEBM_TRACK_ENTRY=[174],WEBM_TRACK_NUMBER=[215],WEBM_TRACK_UID=[115,197],WEBM_TRACK_TYPE=[131],WEBM_FLAG_ENABLED=[185],WEBM_FLAG_DEFAULT=[136],WEBM_FLAG_FORCED=[85,170],WEBM_FLAG_LACING=[156],WEBM_MIN_CACHE=[109,231],WEBM_MAX_BLOCK_ADDITION_ID=[85,238],WEBM_CODEC_DECODE_ALL=[170],WEBM_SEEK_PRE_ROLL=[86,187],WEBM_CODEC_DELAY=[86,170],WEBM_CODEC_PRIVATE=[99,162],WEBM_CODEC_ID=[134],WEBM_AUDIO=[225],WEBM_SAMPLING_FREQUENCY=[181],WEBM_CHANNELS=[159],WEBM_CLUSTER=[31,67,182,117],WEBM_TIME_CODE=[231],WEBM_SIMPLE_BLOCK=[163],CLUSTER_SIMPLEBLOCK_FLAG_KEYFRAME=128,OPUS_FREQUENCY=48e3,OPUS_CHANNELS=2,SPICE_PLAYBACK_CODEC='audio/webm; codecs="opus"',MAX_CLUSTER_TIME=1e3,GAP_DETECTION_THRESHOLD=50;EBMLHeader.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);return e=EBML_write_array(this.id,i,e),e=EBML_write_u64_data_len(31,i,e),e=EBML_write_u8_value(EBML_HEADER_VERSION,this.Version,i,e),e=EBML_write_u8_value(EBML_HEADER_READ_VERSION,this.ReadVersion,i,e),e=EBML_write_u8_value(EBML_HEADER_MAX_ID_LENGTH,this.MaxIDLength,i,e),e=EBML_write_u8_value(EBML_HEADER_MAX_SIZE_LENGTH,this.MaxSizeLength,i,e),e=EBML_write_data(EBML_HEADER_DOC_TYPE,this.DocType,i,e),e=EBML_write_u8_value(EBML_HEADER_DOC_TYPE_VERSION,this.DocTypeVersion,i,e),e=EBML_write_u8_value(EBML_HEADER_DOC_TYPE_READ_VERSION,this.DocTypeReadVersion,i,e)},buffer_size:function(){return 39+this.id.length}},webm_Segment.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);return e=EBML_write_array(this.id,i,e),i.setUint8(e++,255),e},buffer_size:function(){return this.id.length+1}},webm_SegmentInformation.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);return e=EBML_write_array(this.id,i,e),e=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,e),e=EBML_write_u32_value(WEBM_TIMECODE_SCALE,this.timecode_scale,i,e),e=EBML_write_data(WEBM_MUXING_APP,this.muxing_app,i,e),e=EBML_write_data(WEBM_WRITING_APP,this.writing_app,i,e)},buffer_size:function(){return this.id.length+8+WEBM_TIMECODE_SCALE.length+1+4+WEBM_MUXING_APP.length+1+this.muxing_app.length+WEBM_WRITING_APP.length+1+this.writing_app.length}},webm_Audio.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);return e=EBML_write_array(this.id,i,e),e=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,e),e=EBML_write_u8_value(WEBM_CHANNELS,this.channels,i,e),e=EBML_write_float_value(WEBM_SAMPLING_FREQUENCY,this.sampling_frequency,i,e)},buffer_size:function(){return this.id.length+8+WEBM_SAMPLING_FREQUENCY.length+1+4+WEBM_CHANNELS.length+1+1}},webm_Seek.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);return e=EBML_write_array(this.id,i,e),e=EBML_write_u1_data_len(this.buffer_size()-1-this.id.length,i,e),e=EBML_write_data(WEBM_SEEK_ID,this.seekid,i,e),e=EBML_write_u16_value(WEBM_SEEK_POSITION,this.pos,i,e)
},buffer_size:function(){return this.id.length+1+WEBM_SEEK_ID.length+1+this.seekid.length+WEBM_SEEK_POSITION.length+1+2}},webm_SeekHead.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);return e=EBML_write_array(this.id,i,e),e=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,e),e=this.info.to_buffer(t,e),e=this.track.to_buffer(t,e)},buffer_size:function(){return this.id.length+8+this.info.buffer_size()+this.track.buffer_size()}},webm_TrackEntry.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);return e=EBML_write_array(this.id,i,e),e=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,e),e=EBML_write_u8_value(WEBM_TRACK_NUMBER,this.number,i,e),e=EBML_write_u8_value(WEBM_TRACK_UID,this.uid,i,e),e=EBML_write_u8_value(WEBM_FLAG_ENABLED,this.flag_enabled,i,e),e=EBML_write_u8_value(WEBM_FLAG_DEFAULT,this.flag_default,i,e),e=EBML_write_u8_value(WEBM_FLAG_FORCED,this.flag_forced,i,e),e=EBML_write_u8_value(WEBM_FLAG_LACING,this.flag_lacing,i,e),e=EBML_write_data(WEBM_CODEC_ID,this.codec_id,i,e),e=EBML_write_u8_value(WEBM_MIN_CACHE,this.min_cache,i,e),e=EBML_write_u8_value(WEBM_MAX_BLOCK_ADDITION_ID,this.max_block_addition_id,i,e),e=EBML_write_u8_value(WEBM_CODEC_DECODE_ALL,this.codec_decode_all,i,e),e=EBML_write_u32_value(WEBM_CODEC_DELAY,this.codec_delay,i,e),e=EBML_write_u32_value(WEBM_SEEK_PRE_ROLL,this.seek_pre_roll,i,e),e=EBML_write_u8_value(WEBM_TRACK_TYPE,this.type,i,e),e=EBML_write_data(WEBM_CODEC_PRIVATE,this.codec_private,i,e),e=this.audio.to_buffer(t,e)},buffer_size:function(){return this.id.length+8+WEBM_TRACK_NUMBER.length+1+1+WEBM_TRACK_UID.length+1+1+WEBM_TRACK_TYPE.length+1+1+WEBM_FLAG_ENABLED.length+1+1+WEBM_FLAG_DEFAULT.length+1+1+WEBM_FLAG_FORCED.length+1+1+WEBM_FLAG_LACING.length+1+1+WEBM_MIN_CACHE.length+1+1+WEBM_MAX_BLOCK_ADDITION_ID.length+1+1+WEBM_CODEC_DECODE_ALL.length+1+1+WEBM_SEEK_PRE_ROLL.length+1+4+WEBM_CODEC_DELAY.length+1+4+WEBM_CODEC_ID.length+this.codec_id.length+1+WEBM_CODEC_PRIVATE.length+1+this.codec_private.length+this.audio.buffer_size()}},webm_Tracks.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);return e=EBML_write_array(this.id,i,e),e=EBML_write_u64_data_len(this.buffer_size()-8-this.id.length,i,e),e=this.track_entry.to_buffer(t,e)},buffer_size:function(){return this.id.length+8+this.track_entry.buffer_size()}},webm_Cluster.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);return e=EBML_write_array(this.id,i,e),i.setUint8(e++,255),e=EBML_write_u32_value(WEBM_TIME_CODE,this.timecode,i,e)},buffer_size:function(){return this.id.length+1+WEBM_TIME_CODE.length+1+4}},webm_SimpleBlock.prototype={to_buffer:function(t,e){e=e||0;var i=new DataView(t);e=EBML_write_array(this.id,i,e),e=EBML_write_u64_data_len(this.data.byteLength+4,i,e),e=EBML_write_u1_data_len(1,i,e),i.setUint16(e,this.timecode),e+=2,i.setUint8(e,this.keyframe?CLUSTER_SIMPLEBLOCK_FLAG_KEYFRAME:0),e+=1;for(var s=new Uint8Array(this.data),r=0;r<this.data.byteLength;r++)i.setUint8(e++,s[r]);return e},buffer_size:function(){return this.id.length+8+1+2+1+this.data.byteLength}},webm_Header.prototype={to_buffer:function(t,e){return e=e||0,e=this.ebml.to_buffer(t,e),e=this.segment.to_buffer(t,e),e=this.info.to_buffer(t,e),e=this.tracks.to_buffer(t,e)},buffer_size:function(){return this.ebml.buffer_size()+this.segment.buffer_size()+this.info.buffer_size()+this.tracks.buffer_size()}},define("spice-webm",function(){}),SpicePlaybackConn.prototype=Object.create(SpiceConn.prototype),SpicePlaybackConn.prototype.process_channel_message=function(t){if(!window.MediaSource)return this.log_err("MediaSource API is not available"),!1;if(t.type==SPICE_MSG_PLAYBACK_START){var e=new SpiceMsgPlaybackStart(t.data);if(DEBUG>0&&console.log("PlaybackStart; frequency "+e.frequency),e.frequency!=OPUS_FREQUENCY)return this.log_err("This player cannot handle frequency "+e.frequency),!1;if(e.channels!=OPUS_CHANNELS)return this.log_err("This player cannot handle "+e.channels+" channels"),!1;if(e.format!=SPICE_AUDIO_FMT_S16)return this.log_err("This player cannot format "+e.format),!1;if(!this.source_buffer)return this.media_source=new MediaSource,this.media_source.spiceconn=this,this.audio=document.createElement("audio"),this.audio.setAttribute("autoplay",!0),this.audio.src=window.URL.createObjectURL(this.media_source),document.getElementById(this.parent.screen_id).appendChild(this.audio),this.media_source.addEventListener("sourceopen",handle_source_open,!1),this.media_source.addEventListener("sourceended",handle_source_ended,!1),this.media_source.addEventListener("sourceclosed",handle_source_closed,!1),this.bytes_written=0,!0}if(t.type==SPICE_MSG_PLAYBACK_DATA){var i=new SpiceMsgPlaybackData(t.data);return this.last_data_time&&i.time<=this.last_data_time&&(DEBUG>1&&console.log("Hacking time of "+i.time+" to "+this.last_data_time+1),i.time=this.last_data_time+1),this.last_data_time&&i.time>=this.last_data_time+GAP_DETECTION_THRESHOLD&&(this.skip_until=i.time,this.gap_time=i.time-this.start_time-(1e3*this.source_buffer.buffered.end(this.source_buffer.buffered.end.length-1)).toFixed(0)),this.last_data_time=i.time,DEBUG>1&&console.log("PlaybackData; time "+i.time+"; length "+i.data.byteLength),this.source_buffer?(0==this.start_time?this.start_playback(i):i.time-this.cluster_time>=MAX_CLUSTER_TIME||this.skip_until>0?this.new_cluster(i):this.simple_block(i,!1),this.skip_until>0&&(this.audio.currentTime=(this.skip_until-this.start_time-this.gap_time)/1e3,this.skip_until=0),this.audio.paused&&this.audio.play(),!0):!0}if(t.type==SPICE_MSG_PLAYBACK_MODE){var s=new SpiceMsgPlaybackMode(t.data);return s.mode!=SPICE_AUDIO_DATA_MODE_OPUS&&(this.log_err("This player cannot handle mode "+s.mode),delete this.source_buffer),!0}return t.type==SPICE_MSG_PLAYBACK_STOP?!0:!1},SpicePlaybackConn.prototype.start_playback=function(t){this.start_time=t.time;var e=new webm_Header,i=new ArrayBuffer(e.buffer_size());this.bytes_written=e.to_buffer(i),this.source_buffer.addEventListener("error",handle_sourcebuffer_error,!1),this.source_buffer.addEventListener("updateend",handle_append_buffer_done,!1),playback_append_buffer(this,i),this.new_cluster(t)},SpicePlaybackConn.prototype.new_cluster=function(t){this.cluster_time=t.time;var e=new webm_Cluster(t.time-this.start_time-this.gap_time),i=new ArrayBuffer(e.buffer_size());this.bytes_written+=e.to_buffer(i),this.append_okay?playback_append_buffer(this,i):this.queue.push(i),this.simple_block(t,!0)},SpicePlaybackConn.prototype.simple_block=function(t,e){var i=new webm_SimpleBlock(t.time-this.cluster_time,t.data,e),s=new ArrayBuffer(i.buffer_size());this.bytes_written+=i.to_buffer(s),this.append_okay?playback_append_buffer(this,s):this.queue.push(s)},define("spice-playback",["spice-spiceconn"],function(){});var SpiceSimulateCursor={cursors:new Array,unknown_cursors:new Array,warned:!1,add_cursor:function(t,e){SpiceSimulateCursor.cursors[t]=e},unknown_cursor:function(t,e){SpiceSimulateCursor.warned||(SpiceSimulateCursor.warned=!0,alert("Internet Explorer does not support dynamic cursors.  This page will now simulate cursors with images, which will be imperfect.  We recommend using Chrome or Firefox instead.  \n\nIf you need to use Internet Explorer, you can create a static cursor file for each cursor your application uses.  View the console log for more information on creating static cursors for your environment.")),SpiceSimulateCursor.unknown_cursors[t]||(SpiceSimulateCursor.unknown_cursors[t]=e,console.log("Unknown cursor.  Simulation required.  To avoid simulation for this cursor, create and include a custom javascript file, and add the following line:"),console.log('SpiceCursorSimulator.add_cursor("'+t+'"), "<your filename here>.cur");'),console.log("And then run following command, redirecting output into <your filename here>.cur:"),console.log("php -r \"echo urldecode('"+e+"');\""))},simulate_cursor:function(t,e,i,s){var r=hex_sha1(s+" "+e.header.hot_spot_x+" "+e.header.hot_spot_y);if("undefined"!=typeof SpiceSimulateCursor.cursors&&"undefined"!=typeof SpiceSimulateCursor.cursors[r]){var n="url("+SpiceSimulateCursor.cursors[r]+"), default";i.style.cursor=n}"auto"==window.getComputedStyle(i,null).cursor?(SpiceSimulateCursor.unknown_cursor(r,SpiceSimulateCursor.create_icondir(e.header.width,e.header.height,e.data.byteLength,e.header.hot_spot_x,e.header.hot_spot_y)+s),document.getElementById(t.parent.screen_id).style.cursor="none",t.spice_simulated_cursor||(t.spice_simulated_cursor=document.createElement("img"),t.spice_simulated_cursor.style.position="absolute",t.spice_simulated_cursor.style.display="none",t.spice_simulated_cursor.style.overflow="hidden",t.spice_simulated_cursor.spice_screen=document.getElementById(t.parent.screen_id),t.spice_simulated_cursor.addEventListener("mousemove",SpiceSimulateCursor.handle_sim_mousemove),t.spice_simulated_cursor.spice_screen.appendChild(t.spice_simulated_cursor)),t.spice_simulated_cursor.src="data:image/png,"+s,t.spice_simulated_cursor.spice_hot_x=e.header.hot_spot_x,t.spice_simulated_cursor.spice_hot_y=e.header.hot_spot_y,t.spice_simulated_cursor.style.pointerEvents="none"):t.spice_simulated_cursor&&(t.spice_simulated_cursor.spice_screen.removeChild(t.spice_simulated_cursor),delete t.spice_simulated_cursor)},handle_sim_mousemove:function(t){var e=SpiceSimulateCursor.duplicate_mouse_event(t,this.spice_screen);return this.spice_screen.dispatchEvent(e)},duplicate_mouse_event:function(t){var e=document.createEvent("mouseevent");return e.initMouseEvent(t.type,!0,!0,t.view,t.detail,t.screenX,t.screenY,t.clientX,t.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.button,t.relatedTarget),e},ICONDIR:function(){},ICONDIRENTRY:function(t,e,i,s,r){this.width=t,this.height=e,this.bytes=i,this.hot_x=s,this.hot_y=r},create_icondir:function(t,e,i,s,r){var n,a=new SpiceSimulateCursor.ICONDIR,_=new SpiceSimulateCursor.ICONDIRENTRY(t,e,i,s,r),o=new ArrayBuffer(a.buffer_size()+_.buffer_size()),c=a.to_buffer(o);c=_.to_buffer(o,c);var h=new Uint8Array(o),p="";for(n=0;c>n;n++)p+="%",h[n]<16&&(p+="0"),p+=h[n].toString(16);return p}};SpiceSimulateCursor.ICONDIR.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return i.setUint16(e,0,!0),e+=2,i.setUint16(e,2,!0),e+=2,i.setUint16(e,1,!0),e+=2},buffer_size:function(){return 6}},SpiceSimulateCursor.ICONDIRENTRY.prototype={to_buffer:function(t,e){e=e||0;var i=new SpiceDataView(t);return i.setUint8(e,this.width),e++,i.setUint8(e,this.height),e++,i.setUint8(e,0),e++,i.setUint8(e,0),e++,i.setUint16(e,this.hot_x,!0),e+=2,i.setUint16(e,this.hot_y,!0),e+=2,i.setUint32(e,this.bytes,!0),e+=4,i.setUint32(e,e+4,!0),e+=4},buffer_size:function(){return 16}},define("spice-simulatecursor",function(){}),SpiceCursorConn.prototype=Object.create(SpiceConn.prototype),SpiceCursorConn.prototype.process_channel_message=function(t){if(t.type==SPICE_MSG_CURSOR_INIT){var e=new SpiceMsgCursorInit(t.data);return DEBUG>1&&console.log("SpiceMsgCursorInit"),this.parent&&this.parent.inputs&&this.parent.inputs.mouse_mode==SPICE_MOUSE_MODE_SERVER&&(this.parent.inputs.mousex=e.position.x,this.parent.inputs.mousey=e.position.y),!0}if(t.type==SPICE_MSG_CURSOR_SET){var i=new SpiceMsgCursorSet(t.data);return DEBUG>1&&console.log("SpiceMsgCursorSet"),i.flags&SPICE_CURSOR_FLAGS_NONE?(document.getElementById(this.parent.screen_id).style.cursor="none",!0):(i.flags>0&&this.log_warn("FIXME: No support for cursor flags "+i.flags),i.cursor.header.type!=SPICE_CURSOR_TYPE_ALPHA?(this.log_warn("FIXME: No support for cursor type "+i.cursor.header.type),!1):(this.set_cursor(i.cursor),!0))}return t.type==SPICE_MSG_CURSOR_HIDE?(DEBUG>1&&console.log("SpiceMsgCursorHide"),document.getElementById(this.parent.screen_id).style.cursor="none",!0):t.type==SPICE_MSG_CURSOR_RESET?(DEBUG>1&&console.log("SpiceMsgCursorReset"),document.getElementById(this.parent.screen_id).style.cursor="auto",!0):t.type==SPICE_MSG_CURSOR_INVAL_ALL?(DEBUG>1&&console.log("SpiceMsgCursorInvalAll"),!0):!1},SpiceCursorConn.prototype.set_cursor=function(t){var e=create_rgba_png(t.header.height,t.header.width,t.data),i="url(data:image/png,"+e+") "+t.header.hot_spot_x+" "+t.header.hot_spot_y+", default",s=document.getElementById(this.parent.screen_id);s.style.cursor="auto",s.style.cursor=i,"auto"==window.getComputedStyle(s,null).cursor&&SpiceSimulateCursor.simulate_cursor(this,t,s,e)},define("spice-cursor",["spice-spiceconn"],function(){});var dbits,canary=0xdeadbeefcafe,j_lm=15715070==(16777215&canary);j_lm&&"Microsoft Internet Explorer"==navigator.appName?(BigInteger.prototype.am=am2,dbits=30):j_lm&&"Netscape"!=navigator.appName?(BigInteger.prototype.am=am1,dbits=26):(BigInteger.prototype.am=am3,dbits=28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array,rr,vv;for(rr="0".charCodeAt(0),vv=0;9>=vv;++vv)BI_RC[rr++]=vv;for(rr="a".charCodeAt(0),vv=10;36>vv;++vv)BI_RC[rr++]=vv;for(rr="A".charCodeAt(0),vv=10;36>vv;++vv)BI_RC[rr++]=vv;Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),define("spice-jsbn",function(){}),RSAKey.prototype.doPublic=RSADoPublic,RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.encrypt=RSAEncrypt,define("spice-rsa",function(){}),Arcfour.prototype.init=ARC4init,Arcfour.prototype.next=ARC4next;var rng_psize=256;define("spice-prng4",function(){});var rng_state,rng_pool,rng_pptr;if(null==rng_pool){rng_pool=new Array,rng_pptr=0;var t;if("Netscape"==navigator.appName&&navigator.appVersion<"5"&&window.crypto){var z=window.crypto.random(32);for(t=0;t<z.length;++t)rng_pool[rng_pptr++]=255&z.charCodeAt(t)}for(;rng_psize>rng_pptr;)t=Math.floor(65536*Math.random()),rng_pool[rng_pptr++]=t>>>8,rng_pool[rng_pptr++]=255&t;rng_pptr=0,rng_seed_time()}SecureRandom.prototype.nextBytes=rng_get_bytes,define("spice-rng",function(){});var hexcase=0,b64pad="";define("spice-sha1",function(){});var SHA_DIGEST_LENGTH=20;define("spice-ticket",function(){}),define("spice-resize",function(){}),SpiceFileXferTask.prototype.create_progressbar=function(){var t=this,e=document.createElement("input");this.progressbar_container=document.createElement("div"),this.progressbar=document.createElement("progress"),e.type="button",e.value="Cancel",e.style["float"]="right",e.onclick=function(){t.cancelled=!0,t.remove_progressbar()},this.progressbar.setAttribute("max",this.file.size),this.progressbar.setAttribute("value",0),this.progressbar.style.width="100%",this.progressbar.style.margin="4px auto",this.progressbar.style.display="inline-block",this.progressbar_container.style.width="90%",this.progressbar_container.style.margin="auto",this.progressbar_container.style.padding="4px",this.progressbar_container.textContent=this.file.name,this.progressbar_container.appendChild(e),this.progressbar_container.appendChild(this.progressbar),document.getElementById("spice-xfer-area").appendChild(this.progressbar_container)},SpiceFileXferTask.prototype.update_progressbar=function(t){this.progressbar.setAttribute("value",t)},SpiceFileXferTask.prototype.remove_progressbar=function(){this.progressbar_container&&this.progressbar_container.parentNode&&this.progressbar_container.parentNode.removeChild(this.progressbar_container)},define("spice-filexfer",function(){}),SpiceMainConn.prototype=Object.create(SpiceConn.prototype),SpiceMainConn.prototype.process_channel_message=function(t){if(t.type==SPICE_MSG_MAIN_INIT){this.log_info("Connected to "+this.ws.url),this.report_success("Connected"),this.main_init=new SpiceMsgMainInit(t.data),this.connection_id=this.main_init.session_id,this.agent_tokens=this.main_init.agent_tokens,DEBUG>0&&this.log_info("session id "+this.main_init.session_id+" ; display_channels_hint "+this.main_init.display_channels_hint+" ; supported_mouse_modes "+this.main_init.supported_mouse_modes+" ; current_mouse_mode "+this.main_init.current_mouse_mode+" ; agent_connected "+this.main_init.agent_connected+" ; agent_tokens "+this.main_init.agent_tokens+" ; multi_media_time "+this.main_init.multi_media_time+" ; ram_hint "+this.main_init.ram_hint),this.handle_mouse_mode(this.main_init.current_mouse_mode,this.main_init.supported_mouse_modes),this.main_init.agent_connected&&this.connect_agent();var e=new SpiceMiniData;return e.type=SPICE_MSGC_MAIN_ATTACH_CHANNELS,e.size=e.buffer_size(),this.send_msg(e),!0}if(t.type==SPICE_MSG_MAIN_MOUSE_MODE){var i=new SpiceMsgMainMouseMode(t.data);return DEBUG>0&&this.log_info("Mouse supported modes "+i.supported_modes+"; current "+i.current_mode),this.handle_mouse_mode(i.current_mode,i.supported_modes),!0}if(t.type==SPICE_MSG_MAIN_CHANNELS_LIST){var s,r;for(DEBUG>0&&console.log("channels"),r=new SpiceMsgChannels(t.data),s=0;s<r.channels.length;s++){var n={uri:this.ws.url,parent:this,connection_id:this.connection_id,type:r.channels[s].type,chan_id:r.channels[s].id};r.channels[s].type==SPICE_CHANNEL_DISPLAY?this.display=new SpiceDisplayConn(n):r.channels[s].type==SPICE_CHANNEL_INPUTS?(this.inputs=new SpiceInputsConn(n),this.inputs.mouse_mode=this.mouse_mode):r.channels[s].type==SPICE_CHANNEL_CURSOR?this.cursor=new SpiceCursorConn(n):r.channels[s].type==SPICE_CHANNEL_PLAYBACK?this.cursor=new SpicePlaybackConn(n):(this.log_err("Channel type "+r.channels[s].type+" unknown."),"extra_channels"in this||(this.extra_channels=[]),this.extra_channels[s]=new SpiceConn(n))}return!0}if(t.type==SPICE_MSG_MAIN_AGENT_CONNECTED)return this.connect_agent(),!0;if(t.type==SPICE_MSG_MAIN_AGENT_CONNECTED_TOKENS){var a=new SpiceMsgMainAgentTokens(t.data);return this.agent_tokens=a.num_tokens,this.connect_agent(),!0}if(t.type==SPICE_MSG_MAIN_AGENT_TOKEN){var _,o=new SpiceMsgMainAgentTokens(t.data);for(this.agent_tokens+=o.num_tokens,this.send_agent_message_queue(),_=this.agent_tokens;_>0&&this.file_xfer_read_queue.length>0;){var c=this.file_xfer_read_queue.shift();this.file_xfer_read(c,c.read_bytes),_--}return!0}if(t.type==SPICE_MSG_MAIN_AGENT_DISCONNECTED)return this.agent_connected=!1,!0;if(t.type==SPICE_MSG_MAIN_AGENT_DATA){var h=new SpiceMsgMainAgentData(t.data);if(h.type==VD_AGENT_ANNOUNCE_CAPABILITIES){var p=new VDAgentAnnounceCapabilities(h.data);return p.request&&this.announce_agent_capabilities(0),!0}return h.type==VD_AGENT_FILE_XFER_STATUS?(this.handle_file_xfer_status(new VDAgentFileXferStatusMessage(h.data)),!0):!1}return!1},SpiceMainConn.prototype.stop=function(){if(this.state="closing",this.inputs&&(this.inputs.cleanup(),this.inputs=void 0),this.cursor&&(this.cursor.cleanup(),this.cursor=void 0),this.display&&(this.display.cleanup(),this.display.destroy_surfaces(),this.display=void 0),this.cleanup(),"extra_channels"in this)for(var t in this.extra_channels)this.extra_channels[t].cleanup();this.extra_channels=void 0},SpiceMainConn.prototype.send_agent_message_queue=function(t){if(this.agent_connected)for(t&&this.agent_msg_queue.push(t);this.agent_tokens>0&&this.agent_msg_queue.length>0;){var e=this.agent_msg_queue.shift();this.send_msg(e),this.agent_tokens--}},SpiceMainConn.prototype.send_agent_message=function(t,e){var i=new SpiceMsgcMainAgentData(t,e),s=0,r=VD_AGENT_MAX_DATA_SIZE-SpiceMiniData.prototype.buffer_size(),n=new ArrayBuffer(i.buffer_size());for(i.to_buffer(n);s<i.buffer_size();){var a=Math.min(s+r,i.buffer_size()),_=new SpiceMiniData;_.type=SPICE_MSGC_MAIN_AGENT_DATA,_.size=a-s,_.data=n.slice(s,a),this.send_agent_message_queue(_),s=a}},SpiceMainConn.prototype.announce_agent_capabilities=function(t){var e=new VDAgentAnnounceCapabilities(t,1<<VD_AGENT_CAP_MOUSE_STATE|1<<VD_AGENT_CAP_MONITORS_CONFIG|1<<VD_AGENT_CAP_REPLY);this.send_agent_message(VD_AGENT_ANNOUNCE_CAPABILITIES,e)},SpiceMainConn.prototype.resize_window=function(t,e,i,s,r,n){var a=new VDAgentMonitorsConfig(t,e,i,s,r,n);this.send_agent_message(VD_AGENT_MONITORS_CONFIG,a)},SpiceMainConn.prototype.file_xfer_start=function(t){var e,i,s;e=this.file_xfer_task_id++,s=new SpiceFileXferTask(e,t),s.create_progressbar(),this.file_xfer_tasks[e]=s,i=new VDAgentFileXferStartMessage(e,t.name,t.size),this.send_agent_message(VD_AGENT_FILE_XFER_START,i)},SpiceMainConn.prototype.handle_file_xfer_status=function(t){var e,i;if(this.file_xfer_tasks[t.id]){switch(i=this.file_xfer_tasks[t.id],t.result){case VD_AGENT_FILE_XFER_STATUS_CAN_SEND_DATA:return void this.file_xfer_read(i);case VD_AGENT_FILE_XFER_STATUS_CANCELLED:e="transfer is cancelled by spice agent";break;case VD_AGENT_FILE_XFER_STATUS_ERROR:e="some errors occurred in the spice agent";break;case VD_AGENT_FILE_XFER_STATUS_SUCCESS:break;default:e="unhandled status type: "+t.result}this.file_xfer_completed(i,e)}},SpiceMainConn.prototype.file_xfer_read=function(t,e){var i,s,r,n,a=32*VD_AGENT_MAX_DATA_SIZE,_=this;if(t&&this.file_xfer_tasks[t.id]&&!(e>0&&e==t.file.size)){if(t.cancelled){var o=new VDAgentFileXferStatusMessage(t.id,VD_AGENT_FILE_XFER_STATUS_CANCELLED);return this.send_agent_message(VD_AGENT_FILE_XFER_STATUS,o),void delete this.file_xfer_tasks[t.id]}if(i=e||0,s=Math.min(i+a,t.file.size),!this.agent_tokens)return t.read_bytes=i,void this.file_xfer_read_queue.push(t);n=new FileReader,n.onload=function(e){var i=new VDAgentFileXferDataMessage(t.id,e.target.result.byteLength,e.target.result);_.send_agent_message(VD_AGENT_FILE_XFER_DATA,i),_.file_xfer_read(t,s),t.update_progressbar(s)},r=t.file.slice(i,s),n.readAsArrayBuffer(r)}},SpiceMainConn.prototype.file_xfer_completed=function(t,e){e?this.log_err(e):this.log_info("transfer of '"+t.file.name+"' was successful"),t.remove_progressbar(),delete this.file_xfer_tasks[t.id]},SpiceMainConn.prototype.connect_agent=function(){this.agent_connected=!0;var t=new SpiceMsgcMainAgentStart(-1),e=new SpiceMiniData;e.build_msg(SPICE_MSGC_MAIN_AGENT_START,t),this.send_msg(e),this.announce_agent_capabilities(1),void 0!==this.onagent&&this.onagent(this)},SpiceMainConn.prototype.handle_mouse_mode=function(t,e){if(this.mouse_mode=t,t!=SPICE_MOUSE_MODE_CLIENT&&e&SPICE_MOUSE_MODE_CLIENT){var i=new SpiceMsgcMainMouseModeRequest(SPICE_MOUSE_MODE_CLIENT),s=new SpiceMiniData;s.build_msg(SPICE_MSGC_MAIN_MOUSE_MODE_REQUEST,i),this.send_msg(s)}this.inputs&&(this.inputs.mouse_mode=t)},define("spice-main",["spice-spiceconn","spice-spicearraybuffer","spice-enums","spice-atKeynames","spice-utils","spice-png","spice-lz","spice-quic","spice-bitmap","spice-spicedataview","spice-spicetype","spice-spicemsg","spice-wire","spice-display","spice-inputs","spice-webm","spice-playback","spice-simulatecursor","spice-cursor","spice-jsbn","spice-rsa","spice-prng4","spice-rng","spice-sha1","spice-ticket","spice-resize","spice-filexfer"],function(t){return function(){var e;return e||t.SpiceMainConn}}(this)),define("console/spice",["require","spice-main"],function(t){function e(t,e,i){var s,r;s=new Date,s.setTime(s.getTime()+24*i*60*60*1e3),r="; expires="+s.toGMTString(),document.cookie=t+"="+e+r+"; path=/"}function i(t,e){var i=RegExp("[?&]"+t+"=([^&]*)").exec(window.location.search);return i?decodeURIComponent(i[1].replace(/\+/g," ")):e}function s(){n()}function r(){var t,r,o,c,h="ws://";t=i("host",window.location.hostname);var p=window.location.port;if(p||("http:"==window.location.protocol?p=80:"https:"==window.location.protocol&&(p=443)),r=i("port",p),"https:"==window.location.protocol&&(h="wss://"),token=i("token",null),token&&e("token",token,1),o=i("password",""),path=i("path","websockify"),!t||!r)return void console.log("must specify host and port in URL");_&&_.stop(),c=h+t+":"+r+"?token="+token;try{_=new SpiceMainConn({uri:c,screen_id:"spice-screen",dump_id:"debug-div",message_id:"message-div",password:o,onerror:s,onagent:a})}catch(u){alert(u.toString()),n()}}function n(){if(console.log(">> disconnect"),_&&_.stop(),window.File&&window.FileReader&&window.FileList&&window.Blob){var t=document.getElementById("spice-xfer-area");document.getElementById("spice-area").removeChild(t),document.getElementById("spice-area").removeEventListener("dragover",handle_file_dragover,!1),document.getElementById("spice-area").removeEventListener("drop",handle_file_drop,!1)}console.log("<< disconnect")}function a(){if(window.addEventListener("resize",handle_resize),window.spice_connection=this,resize_helper(this),window.File&&window.FileReader&&window.FileList&&window.Blob){var t=document.createElement("div");t.setAttribute("id","spice-xfer-area"),document.getElementById("spice-area").addEventListener("dragover",handle_file_dragover,!1),document.getElementById("spice-area").addEventListener("drop",handle_file_drop,!1)}else console.log("File API is not supported")}t("spice-main");var _;r()}),require(["console/spice"]);
//# sourceMappingURL=spice.js
//# sourceMappingURL=spice.js.map