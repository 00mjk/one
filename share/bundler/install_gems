#!/usr/bin/env ruby

PACKAGES=%w{optional sunstone quota cloud ozones_client ozones_server
    ozones_server_mysql ozones_server_sqlite}

DEFAULT=%w{optional sunstone quota cloud ozones_server acct}


class String
    def unindent(spaces=4)
        self.gsub!(/^ {#{spaces}}/, '')
    end
end

def try_library(name, error_message)
    begin
        require name.to_s
    rescue LoadError
        STDERR.puts error_message
        exit -1
    end
end

def install_warning(packages)
    puts "Use -h for help"
    puts
    puts "About to install the gems for these components:"
    puts "* "<<packages.join("\n* ")
    puts
    puts "Are you sure you want to continue? (YES/no)"
    yes=STDIN.readline
    
    if yes.strip!="YES"
        puts "Installation aborted"
        exit(0)
    end
end

def help
    puts "Specify the package dependencies from this list:"
    puts "* "<<PACKAGES.join("\n* ")
    puts
    puts "If no parameters are specified then this list will be used:"
    puts DEFAULT.join(' ')
end


try_library :rubygems, <<-EOT.unindent
    rubygems required to use this tool

    Use one of these methods:

        * Debian/Ubuntu
            apt-get install rubygems libopenssl-ruby

        * RHEL/CENTOS
            yum install rubygems

        * Specific rubygems package for your distro

        * Follow the instructions from http://rubygems.org/pages/download
EOT

try_library :bundler, <<-EOT.unindent
    bundler needed to install gems

    execute this to install it:

        [sudo] gem install bundler
EOT

if ARGV.include?('-h')
    help
    exit(0)
end

if ARGV.length>0
    packages=ARGV
else
    packages=DEFAULT
end

no_packages=PACKAGES-packages
no_packages<<'dummy'

without="--without #{no_packages.join(' ')}"

command_string = "bundle install #{without}"

install_warning(packages)

puts command_string

system command_string
